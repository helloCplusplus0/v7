# ğŸš€ V7 Project CI/CD Pipeline - å®Œæ•´è‡ªåŠ¨åŒ–éƒ¨ç½²
name: ğŸš€ V7 CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  # å®¹å™¨é•œåƒé…ç½® - ä½¿ç”¨çœŸå®é…ç½®
  REGISTRY: ghcr.io
  REGISTRY_USER: ${{ github.actor }}
  REGISTRY_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
  
  # é•œåƒåœ°å€ - åŸºäºçœŸå®Secretsé…ç½®
  BACKEND_IMAGE_BASE: ${{ secrets.BACKEND_IMAGE || 'ghcr.io/hellocplusplus0/v7/backend' }}
  WEB_IMAGE_BASE: ${{ secrets.WEB_IMAGE || 'ghcr.io/hellocplusplus0/v7/web' }}
  
  # Rustç¯å¢ƒå˜é‡ - ä¸æœ¬åœ°CIå®Œå…¨ä¸€è‡´
  CARGO_INCREMENTAL: 0
  CARGO_PROFILE_DEV_DEBUG: 0
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: short
  CARGO_UNSTABLE_SPARSE_REGISTRY: true
  CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse

jobs:
  # ç¯å¢ƒéªŒè¯é˜¶æ®µ
  environment-check:
    name: ğŸ” Environment Check
    runs-on: ubuntu-latest
    outputs:
      node-version: ${{ steps.versions.outputs.node-version }}
      rust-version: ${{ steps.versions.outputs.rust-version }}
      backend-image: ${{ steps.images.outputs.backend-image }}
      web-image: ${{ steps.images.outputs.web-image }}
      deploy-ready: ${{ steps.deploy-check.outputs.deploy-ready }}
    steps:
      - name: ğŸ“‹ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“Š Set Version Information
        id: versions
        run: |
          echo "node-version=18" >> $GITHUB_OUTPUT
          echo "rust-version=stable" >> $GITHUB_OUTPUT
          echo "ğŸŒ Runner: ${{ runner.os }}"
          echo "ğŸ“ Workspace: ${{ github.workspace }}"
          echo "ğŸ”§ Event: ${{ github.event_name }}"

      - name: ğŸ·ï¸ Set Image Tags
        id: images
        run: |
          # åŸºäºåˆ†æ”¯è®¾ç½®é•œåƒæ ‡ç­¾
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAG="latest"
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            TAG="develop"
          else
            TAG="${{ github.ref_name }}"
          fi
          
          # ç›´æ¥ä½¿ç”¨é»˜è®¤å€¼ï¼Œç¡®ä¿é•œåƒæ ‡ç­¾ä¸ä¸ºç©º
          BACKEND_BASE="ghcr.io/hellocplusplus0/v7/backend"
          WEB_BASE="ghcr.io/hellocplusplus0/v7/web"
          
          # å¦‚æœæœ‰è‡ªå®šä¹‰é•œåƒåœ°å€ï¼Œåˆ™ä½¿ç”¨è‡ªå®šä¹‰å€¼
          if [[ -n "${{ env.BACKEND_IMAGE_BASE }}" ]]; then
            BACKEND_BASE="${{ env.BACKEND_IMAGE_BASE }}"
          fi
          
          if [[ -n "${{ env.WEB_IMAGE_BASE }}" ]]; then
            WEB_BASE="${{ env.WEB_IMAGE_BASE }}"
          fi
          
          BACKEND_IMAGE="${BACKEND_BASE}:${TAG}"
          WEB_IMAGE="${WEB_BASE}:${TAG}"
          
          echo "backend-image=${BACKEND_IMAGE}" >> $GITHUB_OUTPUT
          echo "web-image=${WEB_IMAGE}" >> $GITHUB_OUTPUT
          
          echo "ğŸ” é•œåƒæ ‡ç­¾è®¾ç½®å®Œæˆ:"
          echo "  åˆ†æ”¯: ${{ github.ref }}"
          echo "  æ ‡ç­¾: ${TAG}"
          echo "  åç«¯åŸºç¡€: ${BACKEND_BASE}"
          echo "  å‰ç«¯åŸºç¡€: ${WEB_BASE}"
          echo "  ğŸ“¦ æœ€ç»ˆåç«¯é•œåƒ: ${BACKEND_IMAGE}"
          echo "  ğŸŒ æœ€ç»ˆå‰ç«¯é•œåƒ: ${WEB_IMAGE}"
          
          # éªŒè¯è¾“å‡ºä¸ä¸ºç©º
          if [[ -z "${BACKEND_IMAGE}" ]]; then
            echo "âŒ é”™è¯¯: åç«¯é•œåƒæ ‡ç­¾ä¸ºç©º"
            exit 1
          fi
          
          if [[ -z "${WEB_IMAGE}" ]]; then
            echo "âŒ é”™è¯¯: å‰ç«¯é•œåƒæ ‡ç­¾ä¸ºç©º"
            exit 1
          fi
          
          echo "âœ… é•œåƒæ ‡ç­¾éªŒè¯é€šè¿‡"

      - name: ğŸš€ Check Deployment Configuration
        id: deploy-check
        run: |
          echo "ğŸ” æ£€æŸ¥éƒ¨ç½²é…ç½®..."
          DEPLOY_READY="false"
          
          # æ£€æŸ¥å¿…éœ€çš„Secretsï¼ˆä»…åœ¨main/developåˆ†æ”¯æ¨é€æ—¶ï¼‰
          if [[ "${{ github.event_name }}" == "push" && ("${{ github.ref }}" == "refs/heads/main" || "${{ github.ref }}" == "refs/heads/develop") ]]; then
            if [[ -n "${{ secrets.SERVER_HOST }}" && -n "${{ secrets.SERVER_USER }}" && -n "${{ secrets.SERVER_SSH_KEY }}" && -n "${{ secrets.DEPLOY_PATH }}" ]]; then
              DEPLOY_READY="true"
              echo "âœ… éƒ¨ç½²é…ç½®æ£€æŸ¥é€šè¿‡"
              echo "ğŸŒ æœåŠ¡å™¨: ${{ secrets.SERVER_HOST }}"
              echo "ğŸ‘¤ ç”¨æˆ·: ${{ secrets.SERVER_USER }}"
              echo "ğŸ“ è·¯å¾„: ${{ secrets.DEPLOY_PATH }}"
            else
              echo "âŒ éƒ¨ç½²é…ç½®ä¸å®Œæ•´"
            fi
          else
            echo "â„¹ï¸  ééƒ¨ç½²åˆ†æ”¯ï¼Œè·³è¿‡éƒ¨ç½²é…ç½®æ£€æŸ¥"
          fi
          
          echo "deploy-ready=${DEPLOY_READY}" >> $GITHUB_OUTPUT

  # åç«¯æ£€æŸ¥é˜¶æ®µ
  backend-check:
    name: ğŸ¦€ Backend (Rust) Check
    runs-on: ubuntu-latest
    needs: environment-check
    
    steps:
      - name: ğŸ“‹ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ needs.environment-check.outputs.rust-version }}
          components: rustfmt, clippy

      - name: ğŸ“¦ Cache Cargo Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            backend/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('backend/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: ğŸ§¹ Clean Build Environment
        working-directory: backend
        run: |
          echo "ğŸ§¹ æ¸…ç†ç¼–è¯‘ç¼“å­˜ä»¥ç¡®ä¿å¹²å‡€æ„å»º..."
          cargo clean

      - name: âœï¸ Rust Format Check
        working-directory: backend
        run: |
          echo "ğŸ¨ æ£€æŸ¥Rustä»£ç æ ¼å¼..."
          cargo fmt --all -- --check

      - name: ğŸ” Rust Clippy Check (Strict Mode)
        working-directory: backend
        run: |
          echo "ğŸ”§ è¿è¡ŒRustä»£ç æ£€æŸ¥ (ä¸¥æ ¼æ¨¡å¼)..."
          RUSTFLAGS='-D warnings' cargo clippy --all-targets --all-features -- -D warnings

      - name: ğŸ§ª Rust Unit Tests
        working-directory: backend
        run: |
          echo "ğŸ§ª è¿è¡ŒRustå•å…ƒæµ‹è¯•..."
          cargo test --lib --verbose

      - name: ğŸ”— Rust Integration Tests
        working-directory: backend
        run: |
          echo "ğŸ”— è¿è¡ŒRusté›†æˆæµ‹è¯•..."
          cargo test --test integration --verbose

      - name: ğŸ—ï¸ Rust Release Build
        working-directory: backend
        run: |
          echo "ğŸ—ï¸ æ„å»ºRustå‘å¸ƒç‰ˆæœ¬..."
          cargo build --release

  # å‰ç«¯æ£€æŸ¥é˜¶æ®µ
  frontend-check:
    name: ğŸŒ Frontend (SolidJS) Check
    runs-on: ubuntu-latest
    needs: environment-check
    
    defaults:
      run:
        working-directory: web

    steps:
      - name: ğŸ“‹ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.environment-check.outputs.node-version }}
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: ğŸ§¹ Clean Build Environment
        run: |
          echo "ğŸ§¹ æ¸…ç†æ„å»ºç¯å¢ƒï¼ˆæ¨¡æ‹ŸCIå…¨æ–°ç¯å¢ƒï¼‰..."
          rm -rf node_modules/.vite node_modules/.cache dist coverage .eslintcache
          npm cache clean --force

      - name: ğŸ“¦ Install Dependencies (CI Mode)
        run: |
          echo "ğŸ“¦ ä½¿ç”¨CIæ¨¡å¼å®‰è£…ä¾èµ–..."
          npm ci --prefer-offline --no-audit --no-fund --silent

      - name: ğŸ” ESLint Check
        run: |
          echo "ğŸ” è¿è¡ŒESLintæ£€æŸ¥..."
          npm run lint

      - name: ğŸ”¤ TypeScript Type Check
        run: |
          echo "ğŸ”¤ è¿è¡ŒTypeScriptç±»å‹æ£€æŸ¥..."
          npm run type-check

      - name: ğŸ“ Prepare Test Environment
        run: |
          echo "ğŸ“ å‡†å¤‡æµ‹è¯•ç¯å¢ƒ..."
          mkdir -p coverage

      - name: ğŸ§ª Frontend Tests (CI Mode)
        run: |
          echo "ğŸ§ª è¿è¡Œå‰ç«¯æµ‹è¯• (CIæ¨¡å¼)..."
          npm run test:ci
        continue-on-error: true  # æš‚æ—¶å…è®¸æµ‹è¯•å¤±è´¥ï¼Œä½†è®°å½•ç»“æœ

      - name: ğŸ—ï¸ Frontend Build
        run: |
          echo "ğŸ—ï¸ æ„å»ºå‰ç«¯åº”ç”¨..."
          npm run build

      - name: ğŸ“¦ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: web/dist/
          retention-days: 7

  # å®¹å™¨æ„å»ºå’Œæ¨é€é˜¶æ®µ
  build-and-push:
    name: ğŸ³ Build & Push Containers
    runs-on: ubuntu-latest
    needs: [environment-check, backend-check, frontend-check]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: ğŸ“‹ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.REGISTRY_USER }}
          password: ${{ env.REGISTRY_PASSWORD }}

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ“¦ Download Frontend Artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: web/dist/

      - name: ğŸ” Debug Image Tags
        run: |
          echo "ğŸ” è°ƒè¯•é•œåƒæ ‡ç­¾å€¼ï¼š"
          echo "åç«¯é•œåƒ: '${{ needs.environment-check.outputs.backend-image }}'"
          echo "å‰ç«¯é•œåƒ: '${{ needs.environment-check.outputs.web-image }}'"
          echo "é•œåƒæ ‡ç­¾é•¿åº¦: ${#BACKEND_TAG}"
          echo "Git SHA: ${{ github.sha }}"
          
          BACKEND_TAG="${{ needs.environment-check.outputs.backend-image }}"
          WEB_TAG="${{ needs.environment-check.outputs.web-image }}"
          
          if [[ -z "$BACKEND_TAG" ]]; then
            echo "âŒ é”™è¯¯ï¼šåç«¯é•œåƒæ ‡ç­¾ä¸ºç©ºï¼"
            echo "ğŸ”§ ä½¿ç”¨åº”æ€¥é»˜è®¤å€¼..."
            BACKEND_TAG="ghcr.io/hellocplusplus0/v7/backend:latest"
            echo "åº”æ€¥åç«¯é•œåƒ: $BACKEND_TAG"
          fi
          
          if [[ -z "$WEB_TAG" ]]; then
            echo "âŒ é”™è¯¯ï¼šå‰ç«¯é•œåƒæ ‡ç­¾ä¸ºç©ºï¼"
            echo "ğŸ”§ ä½¿ç”¨åº”æ€¥é»˜è®¤å€¼..."
            WEB_TAG="ghcr.io/hellocplusplus0/v7/web:latest"
            echo "åº”æ€¥å‰ç«¯é•œåƒ: $WEB_TAG"
          fi
          
          # å°†ä¿®æ­£åçš„æ ‡ç­¾ä¿å­˜ä¸ºç¯å¢ƒå˜é‡
          echo "FINAL_BACKEND_TAG=$BACKEND_TAG" >> $GITHUB_ENV
          echo "FINAL_WEB_TAG=$WEB_TAG" >> $GITHUB_ENV

      - name: ğŸ¦€ Build and Push Backend Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ env.FINAL_BACKEND_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          labels: |
            org.opencontainers.image.title=V7 Backend
            org.opencontainers.image.description=V7 Rust Backend with FMOD Architecture
            org.opencontainers.image.version=${{ github.sha }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: ğŸŒ Build and Push Web Image
        uses: docker/build-push-action@v5
        with:
          context: ./web
          file: ./web/Dockerfile
          push: true
          tags: ${{ env.FINAL_WEB_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          labels: |
            org.opencontainers.image.title=V7 Web
            org.opencontainers.image.description=V7 SolidJS Frontend with Web v7 Architecture
            org.opencontainers.image.version=${{ github.sha }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: ğŸ“ Image Build Summary
        run: |
          echo "ğŸ“¦ é•œåƒæ„å»ºå®Œæˆï¼"
          echo "ğŸ¦€ Backend: ${{ needs.environment-check.outputs.backend-image }}"
          echo "ğŸŒ Web: ${{ needs.environment-check.outputs.web-image }}"
          echo "ğŸ·ï¸ Git SHA: ${{ github.sha }}"

  # ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²é˜¶æ®µ
  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [environment-check, build-and-push]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.environment-check.outputs.deploy-ready == 'true'
    environment: production
    
    steps:
      - name: ğŸ“‹ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup SSH Connection
        run: |
          echo "ğŸ”§ é…ç½®SSHè¿æ¥..."
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # æ·»åŠ æœåŠ¡å™¨åˆ°known_hosts
          ssh-keyscan -p ${{ secrets.SERVER_PORT || 22 }} -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
          
          echo "âœ… SSHé…ç½®å®Œæˆ"

      - name: ğŸ“‹ Test SSH Connection
        run: |
          echo "ğŸ” æµ‹è¯•SSHè¿æ¥..."
          ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT || 22 }} -o ConnectTimeout=10 -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo 'âœ… SSHè¿æ¥æˆåŠŸ'; whoami; pwd"

      - name: ğŸ“ Prepare Deployment Files
        run: |
          echo "ğŸ“ å‡†å¤‡éƒ¨ç½²æ–‡ä»¶..."
          
          # åˆ›å»ºç”Ÿäº§ç¯å¢ƒé…ç½®æ–‡ä»¶
          cat > .env.production << EOF
          # ğŸ³ å®¹å™¨é•œåƒé…ç½®
          BACKEND_IMAGE=${{ needs.environment-check.outputs.backend-image }}
          WEB_IMAGE=${{ needs.environment-check.outputs.web-image }}
          
          # ğŸ”§ åº”ç”¨é…ç½® - ä½¿ç”¨çœŸå®Secrets
          DATABASE_URL=${{ secrets.DATABASE_URL || 'sqlite:./data/prod.db' }}
          RUST_LOG=${{ secrets.RUST_LOG || 'info' }}
          NODE_ENV=${{ secrets.NODE_ENV || 'production' }}
          
          # ğŸŒ ç½‘ç»œé…ç½®
          BACKEND_PORT=3000
          WEB_PORT=8080
          
          # ğŸ“Š ç›‘æ§é…ç½®
          MONITOR_PORT=9100
          
          # ğŸ·ï¸ ç‰ˆæœ¬æ ‡ç­¾
          GIT_SHA=${{ github.sha }}
          BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          VERSION=${{ github.ref_name }}-${{ github.sha }}
          EOF
          
          echo "ğŸ“„ ç”Ÿäº§ç¯å¢ƒé…ç½®:"
          cat .env.production
          
          # åˆ›å»ºéƒ¨ç½²è„šæœ¬
          cat > deploy.sh << 'EOF'
          #!/bin/bash
          set -euo pipefail
          
          echo "ğŸš€ å¼€å§‹V7é¡¹ç›®ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²..."
          echo "ğŸ“… éƒ¨ç½²æ—¶é—´: $(date)"
          echo "ğŸ·ï¸ ç‰ˆæœ¬: $VERSION"
          
          # åˆ‡æ¢åˆ°éƒ¨ç½²ç›®å½•
          cd ${{ secrets.DEPLOY_PATH }}
          
          echo "ğŸ” å½“å‰ç¯å¢ƒæ£€æŸ¥:"
          pwd
          ls -la
          
          echo "ğŸ³ ç™»å½•åˆ°å®¹å™¨é•œåƒä»“åº“..."
          echo "${{ env.REGISTRY_PASSWORD }}" | podman login ${{ env.REGISTRY }} -u ${{ env.REGISTRY_USER }} --password-stdin
          
            echo "ğŸ“¦ æ‹‰å–æœ€æ–°é•œåƒ..."
          echo "  - åç«¯: ${{ needs.environment-check.outputs.backend-image }}"
          podman pull ${{ needs.environment-check.outputs.backend-image }}
          echo "  - å‰ç«¯: ${{ needs.environment-check.outputs.web-image }}"
          podman pull ${{ needs.environment-check.outputs.web-image }}
          
          echo "ğŸ”„ æ‰§è¡Œæ»šåŠ¨æ›´æ–°éƒ¨ç½²..."
          
          # å¤‡ä»½å½“å‰è¿è¡Œçš„å®¹å™¨ä¿¡æ¯
          podman-compose --env-file .env.production ps > deployment-backup-$(date +%Y%m%d-%H%M%S).log 2>/dev/null || true
          
          # åœæ­¢ç°æœ‰æœåŠ¡
          echo "â¹ï¸  åœæ­¢ç°æœ‰æœåŠ¡..."
          podman-compose --env-file .env.production down || true
          
          # æ¸…ç†æ—§é•œåƒå’Œç¼“å­˜
          echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
          podman image prune -a -f || true
          podman system prune -f || true
          
          # å¯åŠ¨æ–°æœåŠ¡
          echo "ğŸš€ å¯åŠ¨æ–°æœåŠ¡..."
          podman-compose --env-file .env.production up -d
          
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 30
          
          echo "ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€:"
          podman-compose --env-file .env.production ps
          
          echo "ğŸ“Š æ£€æŸ¥å®¹å™¨å¥åº·çŠ¶æ€:"
          podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          EOF
          
          chmod +x deploy.sh

      - name: ğŸ“¤ Upload Files to Server
        run: |
          echo "ğŸ“¤ ä¸Šä¼ éƒ¨ç½²æ–‡ä»¶åˆ°æœåŠ¡å™¨..."
          
          # ç¡®ä¿éƒ¨ç½²ç›®å½•å­˜åœ¨
          ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT || 22 }} -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "mkdir -p ${{ secrets.DEPLOY_PATH }}"
          
          # ä¸Šä¼ æ–‡ä»¶
          scp -i ~/.ssh/id_rsa -P ${{ secrets.SERVER_PORT || 22 }} -o StrictHostKeyChecking=no \
            podman-compose.yml .env.production deploy.sh \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PATH }}/
          
          echo "âœ… æ–‡ä»¶ä¸Šä¼ å®Œæˆ"

      - name: ğŸš€ Execute Deployment
        run: |
          echo "ğŸš€ åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œéƒ¨ç½²..."
          
          ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT || 22 }} -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "cd ${{ secrets.DEPLOY_PATH }} && bash deploy.sh"

      - name: ğŸ¥ Comprehensive Health Check
        run: |
          echo "ğŸ¥ æ‰§è¡Œå…¨é¢å¥åº·æ£€æŸ¥..."
          
          # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
          echo "â³ ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨..."
          sleep 60
          
          SERVER_HOST="${{ secrets.SERVER_HOST }}"
          
          # å¥åº·æ£€æŸ¥å‡½æ•°
          check_service() {
            local service_name="$1"
            local url="$2"
            local max_attempts=10
            local attempt=1
            
            echo "ğŸ” æ£€æŸ¥ $service_name æœåŠ¡..."
            
            while [ $attempt -le $max_attempts ]; do
              if curl -f -s --connect-timeout 10 "$url" > /dev/null; then
                echo "âœ… $service_name æœåŠ¡å¥åº· (å°è¯• $attempt/$max_attempts)"
                return 0
              else
                echo "â³ $service_name æœåŠ¡æ£€æŸ¥å¤±è´¥ï¼Œç­‰å¾…é‡è¯•... ($attempt/$max_attempts)"
                sleep 15
                ((attempt++))
              fi
            done
            
            echo "âŒ $service_name æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥"
            return 1
          }
          
          # æ£€æŸ¥åç«¯æœåŠ¡
          if check_service "åç«¯" "http://$SERVER_HOST:3000/health"; then
            echo "ğŸ¦€ åç«¯æœåŠ¡è¿è¡Œæ­£å¸¸"
          else
            echo "âŒ åç«¯æœåŠ¡å¼‚å¸¸"
            exit 1
          fi
          
          # æ£€æŸ¥å‰ç«¯æœåŠ¡
          if check_service "å‰ç«¯" "http://$SERVER_HOST:8080/health"; then
            echo "ğŸŒ å‰ç«¯æœåŠ¡è¿è¡Œæ­£å¸¸"
          else
            echo "âŒ å‰ç«¯æœåŠ¡å¼‚å¸¸"
                  exit 1
                fi
          
          # æ£€æŸ¥APIåŠŸèƒ½
          echo "ğŸ”§ æµ‹è¯•APIåŠŸèƒ½..."
          if curl -f -s "http://$SERVER_HOST:3000/api/items" > /dev/null; then
            echo "âœ… APIåŠŸèƒ½æ­£å¸¸"
          else
            echo "âš ï¸  APIåŠŸèƒ½å¯èƒ½å¼‚å¸¸ï¼Œä½†ç»§ç»­éƒ¨ç½²"
          fi

      - name: ğŸ“Š Deployment Summary & Verification
        run: |
          echo "ğŸ“Š éƒ¨ç½²æ€»ç»“"
          echo "========================================"
          echo "ğŸ¯ ç¯å¢ƒ: Production"
          echo "ğŸŒ æœåŠ¡å™¨: ${{ secrets.SERVER_HOST }}"
          echo "ğŸ‘¤ ç”¨æˆ·: ${{ secrets.SERVER_USER }}"
          echo "ğŸ“ è·¯å¾„: ${{ secrets.DEPLOY_PATH }}"
          echo "ğŸ·ï¸ ç‰ˆæœ¬: ${{ github.sha }}"
          echo "ğŸ“… æ—¶é—´: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "ğŸ¦€ åç«¯é•œåƒ: ${{ needs.environment-check.outputs.backend-image }}"
          echo "ğŸŒ å‰ç«¯é•œåƒ: ${{ needs.environment-check.outputs.web-image }}"
          echo ""
          echo "ğŸŒ è®¿é—®åœ°å€:"
          echo "  - å‰ç«¯åº”ç”¨: http://${{ secrets.SERVER_HOST }}:8080"
          echo "  - åç«¯API: http://${{ secrets.SERVER_HOST }}:3000"
          echo "  - CRUDç¤ºä¾‹: http://${{ secrets.SERVER_HOST }}:8080/slice/mvp_crud"
          echo ""
          echo "ğŸ‰ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸå®Œæˆï¼"
          echo "========================================"

      - name: ğŸ”” Post-deployment Verification
        run: |
          echo "ğŸ”” éƒ¨ç½²åéªŒè¯..."
          
          # è·å–æœåŠ¡å™¨çŠ¶æ€
          ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT || 22 }} -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            
            echo "ğŸ“Š æœåŠ¡å™¨èµ„æºä½¿ç”¨æƒ…å†µ:"
            echo "==========================="
            echo "ğŸ–¥ï¸  CPUå’Œå†…å­˜:"
            top -bn1 | head -n 5
            echo ""
            echo "ğŸ’¾ ç£ç›˜ä½¿ç”¨:"
            df -h
            echo ""
            echo "ğŸ³ å®¹å™¨çŠ¶æ€:"
            podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}\t{{.Image}}"
            echo ""
            echo "ğŸ“ˆ å®¹å™¨èµ„æºä½¿ç”¨:"
            podman stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}"
            
          EOF

  # å¼€å‘ç¯å¢ƒéƒ¨ç½²é˜¶æ®µ
  deploy-development:
    name: ğŸ§ª Deploy to Development
    runs-on: ubuntu-latest
    needs: [environment-check, build-and-push]
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop' && needs.environment-check.outputs.deploy-ready == 'true'
    environment: development
    
    steps:
      - name: ğŸ“‹ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ§ª Development Deployment Placeholder
        run: |
          echo "ğŸ§ª å¼€å‘ç¯å¢ƒéƒ¨ç½²..."
          echo "ğŸ·ï¸ å¼€å‘ç‰ˆæœ¬: ${{ needs.environment-check.outputs.backend-image }}"
          echo "ğŸ“ å¼€å‘ç¯å¢ƒéƒ¨ç½²é€»è¾‘ç­‰å¾…é…ç½®å¼€å‘æœåŠ¡å™¨åå®ç°"
          echo "ğŸ”§ å¯ä»¥å¤åˆ¶ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²é€»è¾‘ï¼Œä½¿ç”¨ä¸åŒçš„æœåŠ¡å™¨é…ç½®"

  # å·¥ä½œæµçŠ¶æ€æ€»ç»“
  workflow-summary:
    name: ğŸ“Š Workflow Summary
    runs-on: ubuntu-latest
    needs: [environment-check, backend-check, frontend-check, build-and-push, deploy-production]
    if: always()
    
    steps:
      - name: ğŸ“Š CI/CD Pipeline Summary
        run: |
          echo "ğŸ” CI/CDæµæ°´çº¿æ‰§è¡Œæ€»ç»“"
          echo "================================"
          echo "ğŸŒ ç¯å¢ƒæ£€æŸ¥: ${{ needs.environment-check.result }}"
          echo "ğŸ¦€ åç«¯æ£€æŸ¥: ${{ needs.backend-check.result }}"
          echo "ğŸŒ å‰ç«¯æ£€æŸ¥: ${{ needs.frontend-check.result }}"
          echo "ğŸ³ å®¹å™¨æ„å»º: ${{ needs.build-and-push.result }}"
          echo "ğŸš€ ç”Ÿäº§éƒ¨ç½²: ${{ needs.deploy-production.result }}"
          echo "================================"
          
          # è®¡ç®—æ•´ä½“çŠ¶æ€
          OVERALL_STATUS="success"
          
          if [[ "${{ needs.environment-check.result }}" != "success" ]]; then
            OVERALL_STATUS="failed"
            echo "âŒ ç¯å¢ƒæ£€æŸ¥å¤±è´¥"
          fi
          
          if [[ "${{ needs.backend-check.result }}" != "success" ]]; then
            OVERALL_STATUS="failed"
            echo "âŒ åç«¯æ£€æŸ¥å¤±è´¥"
          fi
          
          if [[ "${{ needs.frontend-check.result }}" != "success" ]]; then
            OVERALL_STATUS="failed"
            echo "âŒ å‰ç«¯æ£€æŸ¥å¤±è´¥"
          fi
          
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            if [[ "${{ needs.build-and-push.result }}" != "success" ]]; then
              OVERALL_STATUS="failed"
              echo "âŒ å®¹å™¨æ„å»ºå¤±è´¥"
            fi
            
            if [[ "${{ needs.deploy-production.result }}" != "success" ]]; then
              OVERALL_STATUS="failed"
              echo "âŒ ç”Ÿäº§éƒ¨ç½²å¤±è´¥"
            fi
          fi
          
          if [[ "$OVERALL_STATUS" == "success" ]]; then
            echo "ğŸ‰ æ‰€æœ‰æ£€æŸ¥å’Œéƒ¨ç½²æµç¨‹å®Œæˆï¼"
          else
            echo "âŒ å‘ç°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ä¸Šè¿°æ­¥éª¤"
            exit 1
          fi

      - name: ğŸ“ Next Steps & Access Information
        if: success()
        run: |
          echo "ğŸ“ æµæ°´çº¿å®ŒæˆçŠ¶æ€ï¼š"
          echo "================================"
          
          if [[ "${{ github.ref }}" == "refs/heads/main" && "${{ needs.deploy-production.result }}" == "success" ]]; then
            echo "ğŸ‰ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼"
            echo ""
            echo "ğŸŒ åº”ç”¨è®¿é—®åœ°å€ï¼š"
            echo "  - å‰ç«¯åº”ç”¨: http://${{ secrets.SERVER_HOST }}:8080"
            echo "  - åç«¯API: http://${{ secrets.SERVER_HOST }}:3000"
            echo "  - CRUDç¤ºä¾‹: http://${{ secrets.SERVER_HOST }}:8080/slice/mvp_crud"
            echo ""
            echo "ğŸ” ç›‘æ§å’Œç»´æŠ¤ï¼š"
            echo "  - å¥åº·æ£€æŸ¥: http://${{ secrets.SERVER_HOST }}:3000/health"
            echo "  - å‰ç«¯å¥åº·: http://${{ secrets.SERVER_HOST }}:8080/health"
            echo "  - æœåŠ¡å™¨ç›‘æ§: SSHåˆ°æœåŠ¡å™¨æ‰§è¡Œ ./scripts/monitoring.sh"
            echo ""
            echo "ğŸ“– è¿ç»´æ–‡æ¡£ï¼š"
            echo "  - æ•…éšœæ’é™¤: docs/quick-reference.md"
            echo "  - ç”¨æˆ·ç®¡ç†: docs/user-management-guide.md"
            
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "ğŸ§ª å¼€å‘ç¯å¢ƒå¤„ç†å®Œæˆ"
            
          else
            echo "ğŸ“‹ ä»£ç æ£€æŸ¥å®Œæˆï¼Œç­‰å¾…åˆå¹¶åˆ°mainåˆ†æ”¯è¿›è¡Œç”Ÿäº§éƒ¨ç½²"
          fi
          
          echo ""
          echo "ğŸ¯ ä¸‹æ¬¡éƒ¨ç½²æç¤ºï¼š"
          echo "  - Pushåˆ°mainåˆ†æ”¯: è‡ªåŠ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²"
          echo "  - Pushåˆ°developåˆ†æ”¯: è‡ªåŠ¨å¼€å‘ç¯å¢ƒéƒ¨ç½²"
          echo "  - Pull Request: ä»…æ‰§è¡ŒCIæ£€æŸ¥" 