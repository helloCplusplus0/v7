# ğŸš€ V7 Project CI/CD Pipeline - å®Œæ•´è‡ªåŠ¨åŒ–éƒ¨ç½²
name: ğŸš€ V7 CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  # å®¹å™¨é•œåƒé…ç½® - å®Œå¤‡çš„è®¤è¯æœºåˆ¶
  REGISTRY: ghcr.io
  # ä¿®å¤ï¼šå°†ç”¨æˆ·åè½¬æ¢ä¸ºå°å†™ä»¥ç¬¦åˆGHCRè¦æ±‚
  REGISTRY_USER: ${{ github.actor }}
  REGISTRY_USER_LOWER: ${{ github.repository_owner }}
  
  # ğŸ“Š é•œåƒåœ°å€ - åŸºäºçœŸå®Secretsé…ç½®ï¼Œä½¿ç”¨å°å†™ç”¨æˆ·å
  BACKEND_IMAGE_BASE: ${{ secrets.BACKEND_IMAGE || 'ghcr.io/hellocplusplus0/v7/backend' }}
  WEB_IMAGE_BASE: ${{ secrets.WEB_IMAGE || 'ghcr.io/hellocplusplus0/v7/web' }}
  
  # Rustç¯å¢ƒå˜é‡ - ä¸æœ¬åœ°CIå®Œå…¨ä¸€è‡´
  CARGO_INCREMENTAL: 0
  CARGO_PROFILE_DEV_DEBUG: 0
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: short
  CARGO_UNSTABLE_SPARSE_REGISTRY: true
  CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse

jobs:
  # ç¯å¢ƒéªŒè¯é˜¶æ®µ
  environment-check:
    name: ğŸ” Environment Check
    runs-on: ubuntu-latest
    outputs:
      node-version: ${{ steps.versions.outputs.node-version }}
      rust-version: ${{ steps.versions.outputs.rust-version }}
      backend-image: ${{ steps.images.outputs.backend-image }}
      web-image: ${{ steps.images.outputs.web-image }}
      deploy-ready: ${{ steps.deploy-check.outputs.deploy-ready }}
      auth-token: ${{ steps.auth-check.outputs.auth-token }}
      auth-method: ${{ steps.auth-check.outputs.auth-method }}
      registry-user-lower: ${{ steps.registry-setup.outputs.registry-user-lower }}
    steps:
      - name: ğŸ“‹ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Registry Configuration
        id: registry-setup
        run: |
          echo "ğŸ”§ é…ç½®å®¹å™¨æ³¨å†Œè¡¨è®¾ç½®..."
          
          # å°†ç”¨æˆ·åè½¬æ¢ä¸ºå°å†™ä»¥ç¬¦åˆGHCRè¦æ±‚
          REGISTRY_USER_LOWER="${{ github.repository_owner }}"
          REGISTRY_USER_LOWER=$(echo "$REGISTRY_USER_LOWER" | tr '[:upper:]' '[:lower:]')
          
          echo "ğŸ” æ³¨å†Œè¡¨é…ç½®:"
          echo "  åŸå§‹ç”¨æˆ·å: ${{ github.repository_owner }}"
          echo "  å°å†™ç”¨æˆ·å: $REGISTRY_USER_LOWER"
          echo "  ä»“åº“: ${{ github.repository }}"
          
          echo "registry-user-lower=$REGISTRY_USER_LOWER" >> $GITHUB_OUTPUT
          
          # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "REGISTRY_USER_LOWER=$REGISTRY_USER_LOWER" >> $GITHUB_ENV

      - name: ğŸ” Comprehensive Authentication Check
        id: auth-check
        run: |
          echo "ğŸ” æ‰§è¡Œå…¨é¢è®¤è¯æ£€æŸ¥..."
          
          # æ£€æŸ¥å¯ç”¨çš„è®¤è¯æ–¹å¼
          GHCR_TOKEN="${{ secrets.GHCR_TOKEN }}"
          GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}"
          
          AUTH_TOKEN=""
          AUTH_METHOD=""
          
          echo "ğŸ” æ£€æŸ¥è®¤è¯tokenå¯ç”¨æ€§:"
          
          if [[ -n "$GHCR_TOKEN" ]]; then
            echo "âœ… GHCR_TOKEN å¯ç”¨ (é•¿åº¦: ${#GHCR_TOKEN})"
            if [[ ${#GHCR_TOKEN} -gt 10 ]]; then
              AUTH_TOKEN="$GHCR_TOKEN"
              AUTH_METHOD="GHCR_TOKEN"
              echo "ğŸ¯ é€‰æ‹©ä½¿ç”¨ GHCR_TOKEN"
            else
              echo "âš ï¸ GHCR_TOKEN é•¿åº¦å¼‚å¸¸ï¼Œå¯èƒ½ä¸ºç©ºå€¼"
            fi
          else
            echo "âŒ GHCR_TOKEN ä¸å¯ç”¨"
          fi
          
          if [[ -n "$GITHUB_TOKEN" ]]; then
            echo "âœ… GITHUB_TOKEN å¯ç”¨ (é•¿åº¦: ${#GITHUB_TOKEN})"
            if [[ -z "$AUTH_TOKEN" ]]; then
              AUTH_TOKEN="$GITHUB_TOKEN"
              AUTH_METHOD="GITHUB_TOKEN"
              echo "ğŸ¯ é€‰æ‹©ä½¿ç”¨ GITHUB_TOKEN (å¤‡ç”¨)"
            fi
          else
            echo "âŒ GITHUB_TOKEN ä¸å¯ç”¨"
          fi
          
          # æœ€ç»ˆè®¤è¯æ–¹å¼ç¡®å®š
          if [[ -n "$AUTH_TOKEN" ]]; then
            echo "âœ… è®¤è¯é…ç½®æˆåŠŸ"
            echo "ğŸ”‘ ä½¿ç”¨æ–¹å¼: $AUTH_METHOD"
            echo "ğŸ” Tokenå‰ç¼€: ${AUTH_TOKEN:0:8}..."
            
            # éªŒè¯tokenæ ¼å¼
            if [[ "$AUTH_TOKEN" =~ ^ghp_ ]]; then
              echo "âœ… æ£€æµ‹åˆ°Personal Access Tokenæ ¼å¼"
            elif [[ "$AUTH_TOKEN" =~ ^ghs_ ]]; then
              echo "âœ… æ£€æµ‹åˆ°GitHub Actions Tokenæ ¼å¼"
            else
              echo "âš ï¸ æœªçŸ¥tokenæ ¼å¼ï¼Œä½†ç»§ç»­å°è¯•ä½¿ç”¨"
            fi
            
            echo "auth-token=***" >> $GITHUB_OUTPUT
            echo "auth-method=$AUTH_METHOD" >> $GITHUB_OUTPUT
          else
            echo "âŒ æ— å¯ç”¨è®¤è¯token"
            echo "ğŸ”§ è¿™å°†å¯¼è‡´é•œåƒæ¨é€å¤±è´¥"
            exit 1
          fi

      - name: ğŸ“Š Set Version Information
        id: versions
        run: |
          echo "node-version=18" >> $GITHUB_OUTPUT
          echo "rust-version=1.87" >> $GITHUB_OUTPUT
          echo "ğŸŒ Runner: ${{ runner.os }}"
          echo "ğŸ“ Workspace: ${{ github.workspace }}"
          echo "ğŸ”§ Event: ${{ github.event_name }}"

      - name: ğŸ·ï¸ Set Image Tags
        id: images
        run: |
          # åŸºäºåˆ†æ”¯è®¾ç½®é•œåƒæ ‡ç­¾
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAG="latest"
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            TAG="develop"
          else
            TAG="${{ github.ref_name }}"
          fi
          
          # ä½¿ç”¨å°å†™ç”¨æˆ·åæ„å»ºé•œåƒåœ°å€ï¼ˆä¼˜å…ˆä»æ­¥éª¤è¾“å‡ºè·å–ï¼Œå¤‡ç”¨ç›´æ¥è®¡ç®—ï¼‰
          REGISTRY_USER_LOWER="${{ steps.registry-setup.outputs.registry-user-lower }}"
          
          # å¦‚æœæ­¥éª¤è¾“å‡ºä¸ºç©ºï¼Œç›´æ¥è®¡ç®—å°å†™ç”¨æˆ·åä½œä¸ºå¤‡ç”¨
          if [[ -z "$REGISTRY_USER_LOWER" ]]; then
            echo "âš ï¸ æ­¥éª¤è¾“å‡ºä¸ºç©ºï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•è®¡ç®—å°å†™ç”¨æˆ·å"
            REGISTRY_USER_LOWER="${{ github.repository_owner }}"
            REGISTRY_USER_LOWER=$(echo "$REGISTRY_USER_LOWER" | tr '[:upper:]' '[:lower:]')
            echo "ğŸ”§ å¤‡ç”¨è®¡ç®—ç»“æœ: $REGISTRY_USER_LOWER"
          fi
          
          # è°ƒè¯•ä¿¡æ¯
          echo "ğŸ” è°ƒè¯•é•œåƒæ ‡ç­¾æ„å»º:"
          echo "  åŸå§‹ä»“åº“æ‰€æœ‰è€…: ${{ github.repository_owner }}"
          echo "  å°å†™ç”¨æˆ·å: $REGISTRY_USER_LOWER"
          echo "  åˆ†æ”¯å¼•ç”¨: ${{ github.ref }}"
          echo "  æ ‡ç­¾: $TAG"
          
          # éªŒè¯å…³é”®å˜é‡ä¸ä¸ºç©º
          if [[ -z "$REGISTRY_USER_LOWER" ]]; then
            echo "âŒ è‡´å‘½é”™è¯¯ï¼šå°å†™ç”¨æˆ·åä¸ºç©ºï¼"
            echo "ğŸ”§ æ£€æŸ¥ registry-setup æ­¥éª¤çš„è¾“å‡º"
            exit 1
          fi
          
          BACKEND_BASE="ghcr.io/${REGISTRY_USER_LOWER}/v7/backend"
          WEB_BASE="ghcr.io/${REGISTRY_USER_LOWER}/v7/web"
          
          # å¦‚æœæœ‰è‡ªå®šä¹‰é•œåƒåœ°å€ï¼Œåˆ™ä½¿ç”¨è‡ªå®šä¹‰å€¼ï¼ˆä½†ç¡®ä¿å°å†™ï¼‰
          if [[ -n "${{ env.BACKEND_IMAGE_BASE }}" ]]; then
            BACKEND_BASE="${{ env.BACKEND_IMAGE_BASE }}"
            BACKEND_BASE=$(echo "$BACKEND_BASE" | tr '[:upper:]' '[:lower:]')
          fi
          
          if [[ -n "${{ env.WEB_IMAGE_BASE }}" ]]; then
            WEB_BASE="${{ env.WEB_IMAGE_BASE }}"
            WEB_BASE=$(echo "$WEB_BASE" | tr '[:upper:]' '[:lower:]')
          fi
          
          BACKEND_IMAGE="${BACKEND_BASE}:${TAG}"
          WEB_IMAGE="${WEB_BASE}:${TAG}"
          
          # è®¾ç½® GitHub è¾“å‡º
          echo "backend-image=${BACKEND_IMAGE}" >> $GITHUB_OUTPUT
          echo "web-image=${WEB_IMAGE}" >> $GITHUB_OUTPUT
          
          echo "ğŸ” é•œåƒæ ‡ç­¾è®¾ç½®å®Œæˆ:"
          echo "  åˆ†æ”¯: ${{ github.ref }}"
          echo "  æ ‡ç­¾: ${TAG}"
          echo "  å°å†™ç”¨æˆ·å: ${REGISTRY_USER_LOWER}"
          echo "  åç«¯åŸºç¡€: ${BACKEND_BASE}"
          echo "  å‰ç«¯åŸºç¡€: ${WEB_BASE}"
          echo "  ğŸ“¦ æœ€ç»ˆåç«¯é•œåƒ: ${BACKEND_IMAGE}"
          echo "  ğŸŒ æœ€ç»ˆå‰ç«¯é•œåƒ: ${WEB_IMAGE}"
          
          # éªŒè¯è¾“å‡ºæ–‡ä»¶å†…å®¹
          echo "ğŸ” éªŒè¯ GITHUB_OUTPUT æ–‡ä»¶å†…å®¹:"
          if [[ -f "$GITHUB_OUTPUT" ]]; then
            echo "ğŸ“„ è¾“å‡ºæ–‡ä»¶å­˜åœ¨ï¼Œå†…å®¹å¦‚ä¸‹:"
            cat "$GITHUB_OUTPUT" | tail -10
          else
            echo "âŒ è¾“å‡ºæ–‡ä»¶ä¸å­˜åœ¨: $GITHUB_OUTPUT"
          fi
          
          # éªŒè¯è¾“å‡ºä¸ä¸ºç©º
          if [[ -z "${BACKEND_IMAGE}" ]]; then
            echo "âŒ é”™è¯¯: åç«¯é•œåƒæ ‡ç­¾ä¸ºç©º"
            exit 1
          fi
          
          if [[ -z "${WEB_IMAGE}" ]]; then
            echo "âŒ é”™è¯¯: å‰ç«¯é•œåƒæ ‡ç­¾ä¸ºç©º"
            exit 1
          fi
          
          # éªŒè¯é•œåƒæ ‡ç­¾æ ¼å¼ï¼ˆç¡®ä¿å…¨éƒ¨å°å†™ï¼‰
          if [[ "$BACKEND_IMAGE" =~ [A-Z] ]]; then
            echo "âŒ é”™è¯¯: åç«¯é•œåƒæ ‡ç­¾åŒ…å«å¤§å†™å­—æ¯: $BACKEND_IMAGE"
            exit 1
          fi
          
          if [[ "$WEB_IMAGE" =~ [A-Z] ]]; then
            echo "âŒ é”™è¯¯: å‰ç«¯é•œåƒæ ‡ç­¾åŒ…å«å¤§å†™å­—æ¯: $WEB_IMAGE"
            exit 1
          fi
          
          echo "âœ… é•œåƒæ ‡ç­¾éªŒè¯é€šè¿‡"

      - name: ğŸš€ Check Deployment Configuration
        id: deploy-check
        run: |
          echo "ğŸ” æ£€æŸ¥éƒ¨ç½²é…ç½®..."
          DEPLOY_READY="false"
          
          # æ£€æŸ¥å¿…éœ€çš„Secretsï¼ˆä»…åœ¨main/developåˆ†æ”¯æ¨é€æ—¶ï¼‰
          if [[ "${{ github.event_name }}" == "push" && ("${{ github.ref }}" == "refs/heads/main" || "${{ github.ref }}" == "refs/heads/develop") ]]; then
            if [[ -n "${{ secrets.SERVER_HOST }}" && -n "${{ secrets.SERVER_USER }}" && -n "${{ secrets.SERVER_SSH_KEY }}" && -n "${{ secrets.DEPLOY_PATH }}" ]]; then
              DEPLOY_READY="true"
              echo "âœ… éƒ¨ç½²é…ç½®æ£€æŸ¥é€šè¿‡"
              echo "ğŸŒ æœåŠ¡å™¨: ${{ secrets.SERVER_HOST }}"
              echo "ğŸ‘¤ ç”¨æˆ·: ${{ secrets.SERVER_USER }}"
              echo "ğŸ“ è·¯å¾„: ${{ secrets.DEPLOY_PATH }}"
            else
              echo "âŒ éƒ¨ç½²é…ç½®ä¸å®Œæ•´"
            fi
          else
            echo "â„¹ï¸  ééƒ¨ç½²åˆ†æ”¯ï¼Œè·³è¿‡éƒ¨ç½²é…ç½®æ£€æŸ¥"
          fi
          
          echo "deploy-ready=${DEPLOY_READY}" >> $GITHUB_OUTPUT

  # åç«¯æ£€æŸ¥é˜¶æ®µ
  backend-check:
    name: ğŸ¦€ Backend (Rust) Check
    runs-on: ubuntu-latest
    needs: environment-check
    
    steps:
      - name: ğŸ“‹ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ needs.environment-check.outputs.rust-version }}
          components: rustfmt, clippy

      - name: ğŸ“¦ Cache Cargo Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            backend/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('backend/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: ğŸ§¹ Clean Build Environment
        working-directory: backend
        run: |
          echo "ğŸ§¹ æ¸…ç†ç¼–è¯‘ç¼“å­˜ä»¥ç¡®ä¿å¹²å‡€æ„å»º..."
          cargo clean

      - name: âœï¸ Rust Format Check
        working-directory: backend
        run: |
          echo "ğŸ¨ æ£€æŸ¥Rustä»£ç æ ¼å¼..."
          cargo fmt --all -- --check

      - name: ğŸ” Rust Clippy Check (Strict Mode)
        working-directory: backend
        run: |
          echo "ğŸ”§ è¿è¡ŒRustä»£ç æ£€æŸ¥ (ä¸¥æ ¼æ¨¡å¼)..."
          RUSTFLAGS='-D warnings' cargo clippy --all-targets --all-features -- -D warnings

      - name: ğŸ§ª Rust Unit Tests
        working-directory: backend
        run: |
          echo "ğŸ§ª è¿è¡ŒRustå•å…ƒæµ‹è¯•..."
          cargo test --lib --verbose

      - name: ğŸ”— Rust Integration Tests
        working-directory: backend
        run: |
          echo "ğŸ”— è¿è¡ŒRusté›†æˆæµ‹è¯•..."
          cargo test --test integration --verbose

      - name: ğŸ—ï¸ Rust Release Build
        working-directory: backend
        run: |
          echo "ğŸ—ï¸ æ„å»ºRustå‘å¸ƒç‰ˆæœ¬..."
          cargo build --release

  # å‰ç«¯æ£€æŸ¥é˜¶æ®µ
  frontend-check:
    name: ğŸŒ Frontend (SolidJS) Check
    runs-on: ubuntu-latest
    needs: environment-check
    
    defaults:
      run:
        working-directory: web

    steps:
      - name: ğŸ“‹ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.environment-check.outputs.node-version }}
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: ğŸ§¹ Clean Build Environment
        run: |
          echo "ğŸ§¹ æ¸…ç†æ„å»ºç¯å¢ƒï¼ˆæ¨¡æ‹ŸCIå…¨æ–°ç¯å¢ƒï¼‰..."
          rm -rf node_modules/.vite node_modules/.cache dist coverage .eslintcache
          npm cache clean --force

      - name: ğŸ“¦ Install Dependencies (CI Mode)
        run: |
          echo "ğŸ“¦ ä½¿ç”¨CIæ¨¡å¼å®‰è£…ä¾èµ–..."
          npm ci --prefer-offline --no-audit --no-fund --silent

      - name: ğŸ” ESLint Check
        run: |
          echo "ğŸ” è¿è¡ŒESLintæ£€æŸ¥..."
          npm run lint

      - name: ğŸ”¤ TypeScript Type Check
        run: |
          echo "ğŸ”¤ è¿è¡ŒTypeScriptç±»å‹æ£€æŸ¥..."
          npm run type-check

      - name: ğŸ“ Prepare Test Environment
        run: |
          echo "ğŸ“ å‡†å¤‡æµ‹è¯•ç¯å¢ƒ..."
          mkdir -p coverage

      - name: ğŸ§ª Frontend Tests (CI Mode)
        run: |
          echo "ğŸ§ª è¿è¡Œå‰ç«¯æµ‹è¯• (CIæ¨¡å¼)..."
          npm run test:ci
        continue-on-error: true  # æš‚æ—¶å…è®¸æµ‹è¯•å¤±è´¥ï¼Œä½†è®°å½•ç»“æœ

      - name: ğŸ—ï¸ Frontend Build
        run: |
          echo "ğŸ—ï¸ æ„å»ºå‰ç«¯åº”ç”¨..."
          npm run build

      - name: ğŸ“¦ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: web/dist/
          retention-days: 7

  # å®¹å™¨æ„å»ºå’Œæ¨é€é˜¶æ®µ
  build-and-push:
    name: ğŸ³ Build & Push Containers
    runs-on: ubuntu-latest
    needs: [environment-check, backend-check, frontend-check]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    permissions:
      contents: read
      packages: write
      id-token: write
    
    steps:
      - name: ğŸ“‹ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” Advanced Registry Authentication
        run: |
          echo "ğŸ” æ‰§è¡Œé«˜çº§å®¹å™¨æ³¨å†Œè¡¨è®¤è¯..."
          
          # è·å–è®¤è¯ä¿¡æ¯
          AUTH_METHOD="${{ needs.environment-check.outputs.auth-method }}"
          REGISTRY_USER="${{ github.actor }}"
          REGISTRY_USER_LOWER="${{ needs.environment-check.outputs.registry-user-lower }}"
          REGISTRY="ghcr.io"
          
          echo "ğŸ” è®¤è¯ä¿¡æ¯:"
          echo "  æ³¨å†Œè¡¨: $REGISTRY"
          echo "  ç”¨æˆ·: $REGISTRY_USER"
          echo "  å°å†™ç”¨æˆ·å: $REGISTRY_USER_LOWER"
          echo "  è®¤è¯æ–¹å¼: $AUTH_METHOD"
          
          # è®¾ç½®è®¤è¯token
          if [[ "$AUTH_METHOD" == "GHCR_TOKEN" ]]; then
            REGISTRY_PASSWORD="${{ secrets.GHCR_TOKEN }}"
            echo "ğŸ”‘ ä½¿ç”¨Personal Access Token (GHCR_TOKEN)"
          else
            REGISTRY_PASSWORD="${{ secrets.GITHUB_TOKEN }}"
            echo "ğŸ”‘ ä½¿ç”¨GitHub Actions Token (GITHUB_TOKEN)"
          fi
          
          # éªŒè¯tokenä¸ä¸ºç©º
          if [[ -z "$REGISTRY_PASSWORD" ]]; then
            echo "âŒ è®¤è¯tokenä¸ºç©º"
            exit 1
          fi
          
          echo "âœ… Tokené•¿åº¦: ${#REGISTRY_PASSWORD}"
          echo "âœ… Tokenå‰ç¼€: ${REGISTRY_PASSWORD:0:8}..."
          
          # æ‰§è¡Œç™»å½• - ä½¿ç”¨åŸå§‹ç”¨æˆ·åè¿›è¡Œè®¤è¯
          echo "ğŸ” æ‰§è¡ŒDockerç™»å½•..."
          echo "$REGISTRY_PASSWORD" | docker login "$REGISTRY" -u "$REGISTRY_USER" --password-stdin
          
          if [[ $? -eq 0 ]]; then
            echo "âœ… å®¹å™¨æ³¨å†Œè¡¨è®¤è¯æˆåŠŸ"
          else
            echo "âŒ å®¹å™¨æ³¨å†Œè¡¨è®¤è¯å¤±è´¥"
            exit 1
          fi
          
          # éªŒè¯è®¤è¯çŠ¶æ€
          echo "ğŸ” éªŒè¯è®¤è¯çŠ¶æ€..."
          docker system info | grep -A 5 "Registry Mirrors" || true
          
          # æµ‹è¯•æƒé™ - ä½¿ç”¨å°å†™ç”¨æˆ·åè¿›è¡Œæµ‹è¯•æ¨é€
          echo "ğŸ§ª æµ‹è¯•æ¨é€æƒé™..."
          TEST_TAG="$REGISTRY/$REGISTRY_USER_LOWER/test:auth-check"
          echo "ğŸ” æµ‹è¯•æ ‡ç­¾: $TEST_TAG"
          
          # éªŒè¯æµ‹è¯•æ ‡ç­¾æ ¼å¼
          if [[ "$TEST_TAG" =~ [A-Z] ]]; then
            echo "âŒ é”™è¯¯: æµ‹è¯•æ ‡ç­¾åŒ…å«å¤§å†™å­—æ¯: $TEST_TAG"
            exit 1
          fi
          
          echo "FROM alpine:latest" | docker build -t "$TEST_TAG" -
          
          if docker push "$TEST_TAG" 2>/dev/null; then
            echo "âœ… æ¨é€æƒé™éªŒè¯æˆåŠŸ"
            # æ¸…ç†æµ‹è¯•é•œåƒ
            docker rmi "$TEST_TAG" 2>/dev/null || true
            # å°è¯•åˆ é™¤è¿œç¨‹æµ‹è¯•é•œåƒï¼ˆå¯é€‰ï¼‰
            echo "ğŸ§¹ æ¸…ç†è¿œç¨‹æµ‹è¯•é•œåƒ..."
          else
            echo "âŒ æ¨é€æƒé™éªŒè¯å¤±è´¥"
            echo "ğŸ” æ£€æŸ¥tokenæƒé™èŒƒå›´:"
            echo "  - write:packages (å¿…éœ€)"
            echo "  - read:packages (å¿…éœ€)"
            echo "  - repo (æ¨è)"
            echo "ğŸ” æ£€æŸ¥ä»“åº“åç§°æ˜¯å¦å…¨éƒ¨å°å†™"
            exit 1
          fi

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ“¦ Download Frontend Artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: web/dist/

      - name: ğŸ” Debug Job Dependencies
        run: |
          echo "ğŸ” è°ƒè¯• job ä¾èµ–å…³ç³»:"
          echo "  éœ€è¦çš„ job: environment-check"
          echo "  environment-check job ç»“æœ: ${{ needs.environment-check.result }}"
          echo "  environment-check job è¾“å‡º:"
          echo "    backend-image: '${{ needs.environment-check.outputs.backend-image }}'"
          echo "    web-image: '${{ needs.environment-check.outputs.web-image }}'"
          echo "    registry-user-lower: '${{ needs.environment-check.outputs.registry-user-lower }}'"
          echo "    auth-method: '${{ needs.environment-check.outputs.auth-method }}'"
          echo ""
          
          # æ£€æŸ¥å…³é”®è¾“å‡ºæ˜¯å¦ä¸ºç©º
          if [[ -z "${{ needs.environment-check.outputs.backend-image }}" ]]; then
            echo "âŒ è­¦å‘Š: backend-image è¾“å‡ºä¸ºç©º"
          fi
          
          if [[ -z "${{ needs.environment-check.outputs.web-image }}" ]]; then
            echo "âŒ è­¦å‘Š: web-image è¾“å‡ºä¸ºç©º"
          fi
          
          if [[ -z "${{ needs.environment-check.outputs.registry-user-lower }}" ]]; then
            echo "âŒ è­¦å‘Š: registry-user-lower è¾“å‡ºä¸ºç©º"
          fi
          
          echo "ğŸ” GitHub ä¸Šä¸‹æ–‡ä¿¡æ¯:"
          echo "  repository: ${{ github.repository }}"
          echo "  repository_owner: ${{ github.repository_owner }}"
          echo "  actor: ${{ github.actor }}"
          echo "  ref: ${{ github.ref }}"
          echo "  ref_name: ${{ github.ref_name }}"
        
      - name: ğŸ” Final Image Tag Verification
        run: |
          echo "ğŸ” æœ€ç»ˆé•œåƒæ ‡ç­¾éªŒè¯ï¼š"
          
          # è°ƒè¯•ï¼šæ˜¾ç¤ºæ‰€æœ‰ä¼ é€’çš„è¾“å‡º
          echo "ğŸ” ä» environment-check ä¼ é€’çš„è¾“å‡º:"
          echo "  backend-image: '${{ needs.environment-check.outputs.backend-image }}'"
          echo "  web-image: '${{ needs.environment-check.outputs.web-image }}'"
          echo "  registry-user-lower: '${{ needs.environment-check.outputs.registry-user-lower }}'"
          echo "  auth-method: '${{ needs.environment-check.outputs.auth-method }}'"
          
          BACKEND_TAG="${{ needs.environment-check.outputs.backend-image }}"
          WEB_TAG="${{ needs.environment-check.outputs.web-image }}"
          
          echo "ğŸ·ï¸ è§£æåçš„é•œåƒæ ‡ç­¾:"
          echo "  åç«¯é•œåƒ: '$BACKEND_TAG'"
          echo "  å‰ç«¯é•œåƒ: '$WEB_TAG'"
          
          # å¦‚æœé•œåƒæ ‡ç­¾ä¸ºç©ºï¼Œå°è¯•é‡æ–°æ„å»º
          if [[ -z "$BACKEND_TAG" ]] || [[ -z "$WEB_TAG" ]]; then
            echo "âš ï¸ é•œåƒæ ‡ç­¾ä¸ºç©ºï¼Œå°è¯•é‡æ–°æ„å»º..."
            
            # è·å–åŸºç¡€ä¿¡æ¯
            REGISTRY_USER_LOWER="${{ needs.environment-check.outputs.registry-user-lower }}"
            
            # å¦‚æœå°å†™ç”¨æˆ·åä¹Ÿä¸ºç©ºï¼Œç›´æ¥è®¡ç®—
            if [[ -z "$REGISTRY_USER_LOWER" ]]; then
              REGISTRY_USER_LOWER="${{ github.repository_owner }}"
              REGISTRY_USER_LOWER=$(echo "$REGISTRY_USER_LOWER" | tr '[:upper:]' '[:lower:]')
              echo "ğŸ”§ é‡æ–°è®¡ç®—å°å†™ç”¨æˆ·å: $REGISTRY_USER_LOWER"
            fi
            
            # åŸºäºåˆ†æ”¯è®¾ç½®æ ‡ç­¾
            if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
              TAG="latest"
            elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
              TAG="develop"
            else
              TAG="${{ github.ref_name }}"
            fi
            
            # é‡æ–°æ„å»ºé•œåƒæ ‡ç­¾
            if [[ -z "$BACKEND_TAG" ]]; then
              BACKEND_TAG="ghcr.io/${REGISTRY_USER_LOWER}/v7/backend:${TAG}"
              echo "ğŸ”§ é‡æ–°æ„å»ºåç«¯æ ‡ç­¾: $BACKEND_TAG"
            fi
            
            if [[ -z "$WEB_TAG" ]]; then
              WEB_TAG="ghcr.io/${REGISTRY_USER_LOWER}/v7/web:${TAG}"
              echo "ğŸ”§ é‡æ–°æ„å»ºå‰ç«¯æ ‡ç­¾: $WEB_TAG"
            fi
          fi
          
          # æœ€åçš„å®‰å…¨æ£€æŸ¥
          if [[ -z "$BACKEND_TAG" ]]; then
            echo "âŒ è‡´å‘½é”™è¯¯ï¼šåç«¯é•œåƒæ ‡ç­¾ä¸ºç©ºï¼"
            echo "ğŸ” è°ƒè¯•ä¿¡æ¯:"
            echo "  github.repository_owner: ${{ github.repository_owner }}"
            echo "  github.ref: ${{ github.ref }}"
            echo "  needs.environment-check.result: ${{ needs.environment-check.result }}"
            exit 1
          fi
          
          if [[ -z "$WEB_TAG" ]]; then
            echo "âŒ è‡´å‘½é”™è¯¯ï¼šå‰ç«¯é•œåƒæ ‡ç­¾ä¸ºç©ºï¼"
            echo "ğŸ” è°ƒè¯•ä¿¡æ¯:"
            echo "  github.repository_owner: ${{ github.repository_owner }}"
            echo "  github.ref: ${{ github.ref }}"
            echo "  needs.environment-check.result: ${{ needs.environment-check.result }}"
            exit 1
          fi
          
          # éªŒè¯é•œåƒæ ‡ç­¾æ ¼å¼
          if [[ ! "$BACKEND_TAG" =~ ^ghcr\.io/.+:.+ ]]; then
            echo "âŒ åç«¯é•œåƒæ ‡ç­¾æ ¼å¼é”™è¯¯: $BACKEND_TAG"
            exit 1
          fi
          
          if [[ ! "$WEB_TAG" =~ ^ghcr\.io/.+:.+ ]]; then
            echo "âŒ å‰ç«¯é•œåƒæ ‡ç­¾æ ¼å¼é”™è¯¯: $WEB_TAG"
            exit 1
          fi
          
          # éªŒè¯æ ‡ç­¾ä¸åŒ…å«å¤§å†™å­—æ¯
          if [[ "$BACKEND_TAG" =~ [A-Z] ]]; then
            echo "âŒ åç«¯é•œåƒæ ‡ç­¾åŒ…å«å¤§å†™å­—æ¯: $BACKEND_TAG"
            exit 1
          fi
          
          if [[ "$WEB_TAG" =~ [A-Z] ]]; then
            echo "âŒ å‰ç«¯é•œåƒæ ‡ç­¾åŒ…å«å¤§å†™å­—æ¯: $WEB_TAG"
            exit 1
          fi
          
          echo "âœ… é•œåƒæ ‡ç­¾éªŒè¯é€šè¿‡"
          echo "  ğŸ“¦ åç«¯é•œåƒ: $BACKEND_TAG"
          echo "  ğŸŒ å‰ç«¯é•œåƒ: $WEB_TAG"
          
          # ä¿å­˜åˆ°ç¯å¢ƒå˜é‡
          echo "FINAL_BACKEND_TAG=$BACKEND_TAG" >> $GITHUB_ENV
          echo "FINAL_WEB_TAG=$WEB_TAG" >> $GITHUB_ENV

      - name: ğŸ¦€ Build and Push Backend Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ env.FINAL_BACKEND_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          labels: |
            org.opencontainers.image.title=V7 Backend
            org.opencontainers.image.description=V7 Rust Backend with FMOD Architecture
            org.opencontainers.image.version=${{ github.sha }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}

      - name: ğŸŒ Build and Push Web Image
        uses: docker/build-push-action@v5
        with:
          context: ./web
          file: ./web/Dockerfile
          push: true
          tags: ${{ env.FINAL_WEB_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          labels: |
            org.opencontainers.image.title=V7 Web
            org.opencontainers.image.description=V7 SolidJS Frontend with Web v7 Architecture
            org.opencontainers.image.version=${{ github.sha }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}

      - name: ğŸ” Post-Build Verification
        run: |
          echo "ğŸ” æ„å»ºåéªŒè¯..."
          
          # éªŒè¯é•œåƒæ˜¯å¦æˆåŠŸæ¨é€
          BACKEND_TAG="${{ env.FINAL_BACKEND_TAG }}"
          WEB_TAG="${{ env.FINAL_WEB_TAG }}"
          
          echo "ğŸ“¦ éªŒè¯é•œåƒæ¨é€çŠ¶æ€:"
          echo "  åç«¯: $BACKEND_TAG"
          echo "  å‰ç«¯: $WEB_TAG"
          
          # å°è¯•æ‹‰å–åˆšæ¨é€çš„é•œåƒè¿›è¡ŒéªŒè¯
          if docker pull "$BACKEND_TAG"; then
            echo "âœ… åç«¯é•œåƒæ¨é€éªŒè¯æˆåŠŸ"
          else
            echo "âŒ åç«¯é•œåƒæ¨é€éªŒè¯å¤±è´¥"
            exit 1
          fi
          
          if docker pull "$WEB_TAG"; then
            echo "âœ… å‰ç«¯é•œåƒæ¨é€éªŒè¯æˆåŠŸ"
          else
            echo "âŒ å‰ç«¯é•œåƒæ¨é€éªŒè¯å¤±è´¥"
            exit 1
          fi
          
          echo "ğŸ‰ æ‰€æœ‰é•œåƒæ„å»ºå’Œæ¨é€æˆåŠŸï¼"

      - name: ğŸ“ Build Summary
        run: |
          echo "ğŸ“ æ„å»ºæ€»ç»“"
          echo "=============="
          echo "ğŸ”‘ è®¤è¯æ–¹å¼: ${{ needs.environment-check.outputs.auth-method }}"
          echo "ğŸ¦€ åç«¯é•œåƒ: ${{ env.FINAL_BACKEND_TAG }}"
          echo "ğŸŒ å‰ç«¯é•œåƒ: ${{ env.FINAL_WEB_TAG }}"
          echo "ğŸ·ï¸ Git SHA: ${{ github.sha }}"
          echo "ğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}"
          echo "ğŸ“… æ„å»ºæ—¶é—´: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "=============="

  # ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²é˜¶æ®µ
  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [environment-check, build-and-push]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.environment-check.outputs.deploy-ready == 'true'
    environment: production
    
    steps:
      - name: ğŸ“‹ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup SSH Connection
        run: |
          echo "ğŸ”§ é…ç½®SSHè¿æ¥..."
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # æ·»åŠ æœåŠ¡å™¨åˆ°known_hosts
          ssh-keyscan -p ${{ secrets.SERVER_PORT || 22 }} -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
          
          echo "âœ… SSHé…ç½®å®Œæˆ"

      - name: ğŸ“‹ Test SSH Connection
        run: |
          echo "ğŸ” æµ‹è¯•SSHè¿æ¥..."
          ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT || 22 }} -o ConnectTimeout=10 -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo 'âœ… SSHè¿æ¥æˆåŠŸ'; whoami; pwd"

      - name: ğŸ“ Prepare Deployment Files
        run: |
          echo "ğŸ“ å‡†å¤‡éƒ¨ç½²æ–‡ä»¶..."
          
          # ğŸ” è°ƒè¯•ï¼šæ£€æŸ¥é•œåƒå˜é‡å€¼
          echo "ğŸ” è°ƒè¯•é•œåƒå˜é‡:"
          echo "åç«¯é•œåƒ: '${{ needs.environment-check.outputs.backend-image }}'"
          echo "å‰ç«¯é•œåƒ: '${{ needs.environment-check.outputs.web-image }}'"
          
          # è·å–é•œåƒæ ‡ç­¾
          BACKEND_IMAGE="${{ needs.environment-check.outputs.backend-image }}"
          WEB_IMAGE="${{ needs.environment-check.outputs.web-image }}"
          REGISTRY_USER_LOWER="${{ needs.environment-check.outputs.registry-user-lower }}"
          
          # éªŒè¯é•œåƒæ ‡ç­¾ä¸ä¸ºç©º
          if [[ -z "$BACKEND_IMAGE" ]]; then
            echo "âŒ é”™è¯¯ï¼šåç«¯é•œåƒæ ‡ç­¾ä¸ºç©º"
            echo "ğŸ”§ ä½¿ç”¨é»˜è®¤å€¼ï¼ˆå°å†™ï¼‰..."
            BACKEND_IMAGE="ghcr.io/${REGISTRY_USER_LOWER}/v7/backend:latest"
          fi
          
          if [[ -z "$WEB_IMAGE" ]]; then
            echo "âŒ é”™è¯¯ï¼šå‰ç«¯é•œåƒæ ‡ç­¾ä¸ºç©º"
            echo "ğŸ”§ ä½¿ç”¨é»˜è®¤å€¼ï¼ˆå°å†™ï¼‰..."
            WEB_IMAGE="ghcr.io/${REGISTRY_USER_LOWER}/v7/web:latest"
          fi
          
          # æœ€ç»ˆéªŒè¯é•œåƒæ ‡ç­¾æ ¼å¼
          if [[ "$BACKEND_IMAGE" =~ [A-Z] ]]; then
            echo "âŒ é”™è¯¯ï¼šåç«¯é•œåƒæ ‡ç­¾åŒ…å«å¤§å†™å­—æ¯: $BACKEND_IMAGE"
            exit 1
          fi
          
          if [[ "$WEB_IMAGE" =~ [A-Z] ]]; then
            echo "âŒ é”™è¯¯ï¼šå‰ç«¯é•œåƒæ ‡ç­¾åŒ…å«å¤§å†™å­—æ¯: $WEB_IMAGE"
            exit 1
          fi
          
          echo "âœ… æœ€ç»ˆé•œåƒæ ‡ç­¾:"
          echo "  åç«¯: $BACKEND_IMAGE"
          echo "  å‰ç«¯: $WEB_IMAGE"
          
          # åˆ›å»ºç”Ÿäº§ç¯å¢ƒé…ç½®æ–‡ä»¶
          cat > .env.production << EOF
          # ğŸ³ å®¹å™¨é•œåƒé…ç½®
          BACKEND_IMAGE=${{ needs.environment-check.outputs.backend-image }}
          WEB_IMAGE=${{ needs.environment-check.outputs.web-image }}
          
          # ğŸ”§ åº”ç”¨é…ç½® - ä½¿ç”¨çœŸå®Secretsï¼Œä¿®å¤æ•°æ®åº“è·¯å¾„
          DATABASE_URL=${{ secrets.DATABASE_URL || 'sqlite:/app/data/prod.db' }}
          RUST_LOG=${{ secrets.RUST_LOG || 'info' }}
          NODE_ENV=${{ secrets.NODE_ENV || 'production' }}
          
          # ğŸ” å®¹å™¨æ³¨å†Œè¡¨è®¤è¯ä¿¡æ¯
          GHCR_TOKEN=${{ secrets.GHCR_TOKEN || secrets.GITHUB_TOKEN }}
          REGISTRY_USER=${{ github.actor }}
          
          # ğŸŒ ç½‘ç»œé…ç½®
          BACKEND_PORT=3000
          WEB_PORT=8080
          
          # ğŸ“Š ç›‘æ§é…ç½®
          MONITOR_PORT=9100
          
          # ğŸ·ï¸ ç‰ˆæœ¬æ ‡ç­¾
          GIT_SHA=${{ github.sha }}
          BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          VERSION="${{ github.ref_name }}-${{ github.sha }}"
          BRANCH_NAME="${{ github.ref_name }}"
          COMMIT_SHA="${{ github.sha }}"
          EOF
          
          echo "ğŸ“„ ç”Ÿäº§ç¯å¢ƒé…ç½®:"
          cat .env.production
          
          # éªŒè¯é•œåƒå˜é‡ä¸ä¸ºç©ºï¼Œæ·»åŠ é»˜è®¤å€¼ä¿æŠ¤ï¼ˆä½¿ç”¨å°å†™ç”¨æˆ·åï¼‰
          REGISTRY_USER_LOWER="${{ needs.environment-check.outputs.registry-user-lower }}"
          if grep -q "BACKEND_IMAGE=$" .env.production; then
            echo "âŒ è­¦å‘Šï¼šåç«¯é•œåƒå˜é‡ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼ï¼ˆå°å†™ï¼‰"
            sed -i "s/BACKEND_IMAGE=$/BACKEND_IMAGE=ghcr.io\/${REGISTRY_USER_LOWER}\/v7\/backend:latest/" .env.production
          fi
          
          if grep -q "WEB_IMAGE=$" .env.production; then
            echo "âŒ è­¦å‘Šï¼šå‰ç«¯é•œåƒå˜é‡ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼ï¼ˆå°å†™ï¼‰"
            sed -i "s/WEB_IMAGE=$/WEB_IMAGE=ghcr.io\/${REGISTRY_USER_LOWER}\/v7\/web:latest/" .env.production
          fi
          
          echo "ğŸ” æœ€ç»ˆé…ç½®æ–‡ä»¶:"
          cat .env.production
          
          # å¤åˆ¶å¢å¼ºéƒ¨ç½²è„šæœ¬
          cp scripts/enhanced-deploy.sh deploy.sh
          
          chmod +x deploy.sh

      - name: ğŸ“¤ Upload Files to Server
        run: |
          echo "ğŸ“¤ ä¸Šä¼ éƒ¨ç½²æ–‡ä»¶åˆ°æœåŠ¡å™¨..."
          
          # ç¡®ä¿éƒ¨ç½²ç›®å½•å­˜åœ¨
          ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT || 22 }} -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "mkdir -p ${{ secrets.DEPLOY_PATH }}"
          
          # ä¸Šä¼ æ–‡ä»¶
          scp -i ~/.ssh/id_rsa -P ${{ secrets.SERVER_PORT || 22 }} -o StrictHostKeyChecking=no \
            podman-compose.yml .env.production deploy.sh \
            scripts/enhanced-deploy.sh scripts/diagnose-deployment-health.sh \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PATH }}/
          
          echo "âœ… æ–‡ä»¶ä¸Šä¼ å®Œæˆ"

      - name: ğŸ” Setup Container Registry Authentication
        run: |
          echo "ğŸ” åœ¨æœåŠ¡å™¨ä¸Šé…ç½®å®¹å™¨æ³¨å†Œè¡¨è®¤è¯..."
          
          # åˆ›å»ºè®¤è¯è„šæœ¬ï¼Œä½¿ç”¨GitHub Token
          cat > setup-auth.sh << 'SCRIPT_EOF'
          #!/bin/bash
          echo "ğŸ” é…ç½®GitHub Container Registryè®¤è¯..."
          
          # ä½¿ç”¨GitHub Tokenè¿›è¡Œè®¤è¯
          GHCR_TOKEN="${GITHUB_TOKEN}"
          REGISTRY_USER="hellocplusplus0"
          
          if [[ -n "$GHCR_TOKEN" ]]; then
            echo "ğŸ”‘ ä½¿ç”¨GitHub Tokenè®¤è¯GHCR..."
            echo "$GHCR_TOKEN" | podman login ghcr.io -u "$REGISTRY_USER" --password-stdin
            if [[ $? -eq 0 ]]; then
              echo "âœ… GitHub Container Registryè®¤è¯æˆåŠŸ"
              
              # éªŒè¯è®¤è¯çŠ¶æ€
              if podman login ghcr.io --get-login 2>/dev/null | grep -q "$REGISTRY_USER"; then
                echo "âœ… è®¤è¯çŠ¶æ€éªŒè¯æˆåŠŸ"
              else
                echo "âš ï¸ è®¤è¯çŠ¶æ€éªŒè¯å¼‚å¸¸ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
              fi
            else
              echo "âŒ GitHub Container Registryè®¤è¯å¤±è´¥"
              exit 1
            fi
          else
            echo "âŒ ç¼ºå°‘GITHUB_TOKENï¼Œæ— æ³•è®¤è¯"
            exit 1
          fi
          SCRIPT_EOF
          
          chmod +x setup-auth.sh
          
          # ä¸Šä¼ è®¤è¯è„šæœ¬
          scp -i ~/.ssh/id_rsa -P ${{ secrets.SERVER_PORT || 22 }} -o StrictHostKeyChecking=no \
            setup-auth.sh \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PATH }}/
          
          # åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œè®¤è¯ï¼Œä¼ é€’GitHub Token
          ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT || 22 }} -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "cd ${{ secrets.DEPLOY_PATH }} && GITHUB_TOKEN='${{ secrets.GITHUB_TOKEN }}' bash setup-auth.sh"

      - name: ğŸš€ Execute Deployment
        run: |
          echo "ğŸš€ åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œéƒ¨ç½²..."
          
          # åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œéƒ¨ç½²ï¼Œä¼ é€’å¿…è¦çš„ç¯å¢ƒå˜é‡
          ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT || 22 }} -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "cd ${{ secrets.DEPLOY_PATH }} && \
             GITHUB_TOKEN='${{ secrets.GITHUB_TOKEN }}' \
             GHCR_TOKEN='${{ secrets.GITHUB_TOKEN }}' \
             bash deploy.sh"

      - name: ğŸ¥ Comprehensive Health Check
        run: |
          echo "ğŸ¥ æ‰§è¡Œå…¨é¢å¥åº·æ£€æŸ¥..."
          
          # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
          echo "â³ ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨..."
          sleep 60
          
          SERVER_HOST="${{ secrets.SERVER_HOST }}"
          
          # ä¸Šä¼ è¯Šæ–­è„šæœ¬åˆ°æœåŠ¡å™¨
          echo "ğŸ“¤ ä¸Šä¼ å¥åº·è¯Šæ–­è„šæœ¬..."
          scp -i ~/.ssh/id_rsa -P ${{ secrets.SERVER_PORT || 22 }} -o StrictHostKeyChecking=no \
            scripts/diagnose-deployment-health.sh \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PATH }}/
          
          # åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œè¯Šæ–­
          echo "ğŸ” åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œåˆæ­¥è¯Šæ–­..."
          ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT || 22 }} -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "cd ${{ secrets.DEPLOY_PATH }} && chmod +x diagnose-deployment-health.sh && ./diagnose-deployment-health.sh diagnose"
          
          # å¥åº·æ£€æŸ¥å‡½æ•°ï¼ˆå¢å¼ºç‰ˆï¼‰
          check_service() {
            local service_name="$1"
            local url="$2"
            local max_attempts=15
            local attempt=1
            
            echo "ğŸ” æ£€æŸ¥ $service_name æœåŠ¡..."
            
            while [ $attempt -le $max_attempts ]; do
              # å…ˆæ£€æŸ¥ç«¯å£æ˜¯å¦å¼€æ”¾
              if timeout 5 bash -c "</dev/tcp/$SERVER_HOST/${url##*:}" 2>/dev/null; then
                echo "âœ… ç«¯å£ ${url##*:} å·²å¼€æ”¾"
                
                # å†æ£€æŸ¥HTTPå“åº”
                if curl -f -s --connect-timeout 10 --max-time 30 "$url" > /dev/null; then
                  echo "âœ… $service_name æœåŠ¡å¥åº· (å°è¯• $attempt/$max_attempts)"
                  return 0
                else
                  echo "âš ï¸  ç«¯å£å¼€æ”¾ä½†HTTPå“åº”å¼‚å¸¸ (å°è¯• $attempt/$max_attempts)"
                fi
              else
                echo "â³ $service_name ç«¯å£æœªå¼€æ”¾ï¼Œç­‰å¾…é‡è¯•... ($attempt/$max_attempts)"
              fi
              
              # å¦‚æœæ˜¯ç¬¬5æ¬¡å¤±è´¥ï¼Œæ‰§è¡Œè¯¦ç»†è¯Šæ–­
              if [ $attempt -eq 5 ]; then
                echo "ğŸ”§ æ‰§è¡Œä¸­æœŸè¯Šæ–­..."
                ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT || 22 }} -o StrictHostKeyChecking=no \
                  ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
                  "cd ${{ secrets.DEPLOY_PATH }} && ./diagnose-deployment-health.sh fix"
              fi
              
              sleep 15
              ((attempt++))
            done
            
            echo "âŒ $service_name æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥"
            
            # å¤±è´¥æ—¶æ‰§è¡Œè¯¦ç»†è¯Šæ–­
            echo "ğŸ”§ æ‰§è¡Œå¤±è´¥è¯Šæ–­..."
            ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT || 22 }} -o StrictHostKeyChecking=no \
              ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
              "cd ${{ secrets.DEPLOY_PATH }} && ./diagnose-deployment-health.sh report"
            
            return 1
          }
          
          # æ£€æŸ¥åç«¯æœåŠ¡
          echo "ğŸ¦€ å¼€å§‹åç«¯å¥åº·æ£€æŸ¥..."
          if check_service "åç«¯" "http://$SERVER_HOST:3000/health"; then
            echo "âœ… åç«¯æœåŠ¡è¿è¡Œæ­£å¸¸"
          else
            echo "âŒ åç«¯æœåŠ¡å¼‚å¸¸ï¼Œå°è¯•ä¿®å¤..."
            
            # å°è¯•ä¿®å¤åç«¯æœåŠ¡
            ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT || 22 }} -o StrictHostKeyChecking=no \
              ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
              "cd ${{ secrets.DEPLOY_PATH }} && ./diagnose-deployment-health.sh restart"
            
            # å†æ¬¡ç­‰å¾…å’Œæ£€æŸ¥
            echo "â³ ç­‰å¾…æœåŠ¡é‡å¯..."
            sleep 60
            
            if check_service "åç«¯" "http://$SERVER_HOST:3000/health"; then
              echo "âœ… åç«¯æœåŠ¡ä¿®å¤æˆåŠŸ"
            else
              echo "âŒ åç«¯æœåŠ¡ä¿®å¤å¤±è´¥ï¼Œä½†ç»§ç»­æ£€æŸ¥å‰ç«¯"
              # ä¸è¦ç«‹å³é€€å‡ºï¼Œç»§ç»­æ£€æŸ¥å‰ç«¯
            fi
          fi
          
          # æ£€æŸ¥å‰ç«¯æœåŠ¡
          echo "ğŸŒ å¼€å§‹å‰ç«¯å¥åº·æ£€æŸ¥..."
          if check_service "å‰ç«¯" "http://$SERVER_HOST:8080"; then
            echo "âœ… å‰ç«¯æœåŠ¡è¿è¡Œæ­£å¸¸"
          else
            echo "âŒ å‰ç«¯æœåŠ¡å¼‚å¸¸"
            # å‰ç«¯å¤±è´¥ä¸é˜»æ­¢éƒ¨ç½²ï¼Œå› ä¸ºå®ƒä¾èµ–äºåç«¯
            echo "âš ï¸  å‰ç«¯æœåŠ¡å¼‚å¸¸ï¼Œä½†ç»§ç»­éƒ¨ç½²æµç¨‹"
          fi
          
          # æ£€æŸ¥APIåŠŸèƒ½
          echo "ğŸ”§ æµ‹è¯•APIåŠŸèƒ½..."
          if curl -f -s --connect-timeout 10 --max-time 30 "http://$SERVER_HOST:3000/api/info" > /dev/null; then
            echo "âœ… APIåŠŸèƒ½æ­£å¸¸"
          else
            echo "âš ï¸  APIåŠŸèƒ½å¯èƒ½å¼‚å¸¸ï¼Œä½†ç»§ç»­éƒ¨ç½²"
          fi
          
          # æœ€ç»ˆå¥åº·æŠ¥å‘Š
          echo "ğŸ“Š ç”Ÿæˆæœ€ç»ˆå¥åº·æŠ¥å‘Š..."
          ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT || 22 }} -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "cd ${{ secrets.DEPLOY_PATH }} && ./diagnose-deployment-health.sh report"

      - name: ğŸ“Š Deployment Summary & Verification
        run: |
          echo "ğŸ“Š éƒ¨ç½²æ€»ç»“"
          echo "========================================"
          echo "ğŸ¯ ç¯å¢ƒ: Production"
          echo "ğŸŒ æœåŠ¡å™¨: ${{ secrets.SERVER_HOST }}"
          echo "ğŸ‘¤ ç”¨æˆ·: ${{ secrets.SERVER_USER }}"
          echo "ğŸ“ è·¯å¾„: ${{ secrets.DEPLOY_PATH }}"
          echo "ğŸ·ï¸ ç‰ˆæœ¬: ${{ github.sha }}"
          echo "ğŸ“… æ—¶é—´: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "ğŸ¦€ åç«¯é•œåƒ: ${{ needs.environment-check.outputs.backend-image }}"
          echo "ğŸŒ å‰ç«¯é•œåƒ: ${{ needs.environment-check.outputs.web-image }}"
          echo ""
          echo "ğŸŒ è®¿é—®åœ°å€:"
          echo "  - å‰ç«¯åº”ç”¨: http://${{ secrets.SERVER_HOST }}:8080"
          echo "  - åç«¯API: http://${{ secrets.SERVER_HOST }}:3000"
          echo "  - CRUDç¤ºä¾‹: http://${{ secrets.SERVER_HOST }}:8080/slice/mvp_crud"
          echo ""
          echo "ğŸ‰ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸå®Œæˆï¼"
          echo "========================================"

      - name: ğŸ”” Post-deployment Verification
        run: |
          echo "ğŸ”” éƒ¨ç½²åéªŒè¯..."
          
          # è·å–æœåŠ¡å™¨çŠ¶æ€
          ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT || 22 }} -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            
            echo "ğŸ“Š æœåŠ¡å™¨èµ„æºä½¿ç”¨æƒ…å†µ:"
            echo "==========================="
            echo "ğŸ–¥ï¸  CPUå’Œå†…å­˜:"
            top -bn1 | head -n 5
            echo ""
            echo "ğŸ’¾ ç£ç›˜ä½¿ç”¨:"
            df -h
            echo ""
            echo "ğŸ³ å®¹å™¨çŠ¶æ€:"
            podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}\t{{.Image}}"
            echo ""
            echo "ğŸ“ˆ å®¹å™¨èµ„æºä½¿ç”¨:"
            podman stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}"
            
          EOF

  # å¼€å‘ç¯å¢ƒéƒ¨ç½²é˜¶æ®µ
  deploy-development:
    name: ğŸ§ª Deploy to Development
    runs-on: ubuntu-latest
    needs: [environment-check, build-and-push]
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop' && needs.environment-check.outputs.deploy-ready == 'true'
    environment: development
    
    steps:
      - name: ğŸ“‹ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ§ª Development Deployment Placeholder
        run: |
          echo "ğŸ§ª å¼€å‘ç¯å¢ƒéƒ¨ç½²..."
          echo "ğŸ·ï¸ å¼€å‘ç‰ˆæœ¬: ${{ needs.environment-check.outputs.backend-image }}"
          echo "ğŸ“ å¼€å‘ç¯å¢ƒéƒ¨ç½²é€»è¾‘ç­‰å¾…é…ç½®å¼€å‘æœåŠ¡å™¨åå®ç°"
          echo "ğŸ”§ å¯ä»¥å¤åˆ¶ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²é€»è¾‘ï¼Œä½¿ç”¨ä¸åŒçš„æœåŠ¡å™¨é…ç½®"

  # å·¥ä½œæµçŠ¶æ€æ€»ç»“
  workflow-summary:
    name: ğŸ“Š Workflow Summary
    runs-on: ubuntu-latest
    needs: [environment-check, backend-check, frontend-check, build-and-push, deploy-production]
    if: always()
    
    steps:
      - name: ğŸ“Š CI/CD Pipeline Summary
        run: |
          echo "ğŸ” CI/CDæµæ°´çº¿æ‰§è¡Œæ€»ç»“"
          echo "================================"
          echo "ğŸŒ ç¯å¢ƒæ£€æŸ¥: ${{ needs.environment-check.result }}"
          echo "ğŸ¦€ åç«¯æ£€æŸ¥: ${{ needs.backend-check.result }}"
          echo "ğŸŒ å‰ç«¯æ£€æŸ¥: ${{ needs.frontend-check.result }}"
          echo "ğŸ³ å®¹å™¨æ„å»º: ${{ needs.build-and-push.result }}"
          echo "ğŸš€ ç”Ÿäº§éƒ¨ç½²: ${{ needs.deploy-production.result }}"
          echo "================================"
          
          # è®¡ç®—æ•´ä½“çŠ¶æ€
          OVERALL_STATUS="success"
          
          if [[ "${{ needs.environment-check.result }}" != "success" ]]; then
            OVERALL_STATUS="failed"
            echo "âŒ ç¯å¢ƒæ£€æŸ¥å¤±è´¥"
          fi
          
          if [[ "${{ needs.backend-check.result }}" != "success" ]]; then
            OVERALL_STATUS="failed"
            echo "âŒ åç«¯æ£€æŸ¥å¤±è´¥"
          fi
          
          if [[ "${{ needs.frontend-check.result }}" != "success" ]]; then
            OVERALL_STATUS="failed"
            echo "âŒ å‰ç«¯æ£€æŸ¥å¤±è´¥"
          fi
          
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            if [[ "${{ needs.build-and-push.result }}" != "success" ]]; then
              OVERALL_STATUS="failed"
              echo "âŒ å®¹å™¨æ„å»ºå¤±è´¥"
            fi
            
            if [[ "${{ needs.deploy-production.result }}" != "success" ]]; then
              OVERALL_STATUS="failed"
              echo "âŒ ç”Ÿäº§éƒ¨ç½²å¤±è´¥"
            fi
          fi
          
          if [[ "$OVERALL_STATUS" == "success" ]]; then
            echo "ğŸ‰ æ‰€æœ‰æ£€æŸ¥å’Œéƒ¨ç½²æµç¨‹å®Œæˆï¼"
          else
            echo "âŒ å‘ç°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ä¸Šè¿°æ­¥éª¤"
            exit 1
          fi

      - name: ğŸ“ Next Steps & Access Information
        if: success()
        run: |
          echo "ğŸ“ æµæ°´çº¿å®ŒæˆçŠ¶æ€ï¼š"
          echo "================================"
          
          if [[ "${{ github.ref }}" == "refs/heads/main" && "${{ needs.deploy-production.result }}" == "success" ]]; then
            echo "ğŸ‰ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼"
            echo ""
            echo "ğŸŒ åº”ç”¨è®¿é—®åœ°å€ï¼š"
            echo "  - å‰ç«¯åº”ç”¨: http://${{ secrets.SERVER_HOST }}:8080"
            echo "  - åç«¯API: http://${{ secrets.SERVER_HOST }}:3000"
            echo "  - CRUDç¤ºä¾‹: http://${{ secrets.SERVER_HOST }}:8080/slice/mvp_crud"
            echo ""
            echo "ğŸ” ç›‘æ§å’Œç»´æŠ¤ï¼š"
            echo "  - å¥åº·æ£€æŸ¥: http://${{ secrets.SERVER_HOST }}:3000/health"
            echo "  - å‰ç«¯å¥åº·: http://${{ secrets.SERVER_HOST }}:8080/health"
            echo "  - æœåŠ¡å™¨ç›‘æ§: SSHåˆ°æœåŠ¡å™¨æ‰§è¡Œ ./scripts/monitoring.sh"
            echo ""
            echo "ğŸ“– è¿ç»´æ–‡æ¡£ï¼š"
            echo "  - æ•…éšœæ’é™¤: docs/quick-reference.md"
            echo "  - ç”¨æˆ·ç®¡ç†: docs/user-management-guide.md"
            
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "ğŸ§ª å¼€å‘ç¯å¢ƒå¤„ç†å®Œæˆ"
            
          else
            echo "ğŸ“‹ ä»£ç æ£€æŸ¥å®Œæˆï¼Œç­‰å¾…åˆå¹¶åˆ°mainåˆ†æ”¯è¿›è¡Œç”Ÿäº§éƒ¨ç½²"
          fi
          
          echo ""
          echo "ğŸ¯ ä¸‹æ¬¡éƒ¨ç½²æç¤ºï¼š"
          echo "  - Pushåˆ°mainåˆ†æ”¯: è‡ªåŠ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²"
          echo "  - Pushåˆ°developåˆ†æ”¯: è‡ªåŠ¨å¼€å‘ç¯å¢ƒéƒ¨ç½²"
          echo "  - Pull Request: ä»…æ‰§è¡ŒCIæ£€æŸ¥" 