# ğŸš€ V7 Project CI/CD Pipeline - æ··åˆæ¶æ„éƒ¨ç½²
name: ğŸš€ V7 Hybrid Architecture CI/CD

on:
  push:
    branches: [ main, develop ]  # æ”¯æŒmainå’Œdevelopåˆ†æ”¯
  pull_request:
    branches: [ main, develop ]  # æ”¯æŒä¸¤ä¸ªåˆ†æ”¯çš„PR

env:
  # å®¹å™¨é•œåƒé…ç½®
  REGISTRY: ghcr.io
  REGISTRY_USER_LOWER: ${{ github.repository_owner }}
  
  # ğŸ³ é•œåƒåœ°å€é…ç½®
  BACKEND_IMAGE_BASE: ${{ vars.BACKEND_IMAGE || 'ghcr.io/your-org/v7/backend' }}
  WEB_IMAGE_BASE: ${{ vars.WEB_IMAGE || 'ghcr.io/your-org/v7/web' }}
  
  # Rustç¯å¢ƒå˜é‡
  CARGO_INCREMENTAL: 0
  CARGO_PROFILE_DEV_DEBUG: 0
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: short
  CARGO_UNSTABLE_SPARSE_REGISTRY: true
  CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse

jobs:
  # ğŸ” ç¯å¢ƒéªŒè¯
  environment-check:
    name: ğŸ” Environment Check
    runs-on: ubuntu-latest
    outputs:
      deploy-ready: ${{ steps.deploy-check.outputs.deploy-ready }}
      backend-image: ${{ steps.images.outputs.backend-image }}
      web-image: ${{ steps.images.outputs.web-image }}
      auth-method: ${{ steps.auth-check.outputs.auth-method }}
      deployment-mode: ${{ steps.deployment-config.outputs.deployment-mode }}
    steps:
      - name: ğŸ“‹ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” Authentication Check
        id: auth-check
        run: |
          echo "ğŸ” æ£€æŸ¥å®¹å™¨æ³¨å†Œè¡¨è®¤è¯..."
          
          AUTH_TOKEN=""
          AUTH_METHOD=""
          
          if [[ -n "${{ secrets.GHCR_TOKEN }}" ]]; then
            AUTH_TOKEN="${{ secrets.GHCR_TOKEN }}"
            AUTH_METHOD="GHCR_TOKEN"
            echo "âœ… ä½¿ç”¨ GHCR_TOKEN"
          elif [[ -n "${{ secrets.GITHUB_TOKEN }}" ]]; then
            AUTH_TOKEN="${{ secrets.GITHUB_TOKEN }}"
            AUTH_METHOD="GITHUB_TOKEN"
            echo "âœ… ä½¿ç”¨ GITHUB_TOKEN"
          else
            echo "âŒ æ— å¯ç”¨è®¤è¯token"
            exit 1
          fi
          
          echo "auth-method=$AUTH_METHOD" >> $GITHUB_OUTPUT

      - name: ğŸ·ï¸ Set Image Tags
        id: images
        run: |
          # æ ¹æ®åˆ†æ”¯ç¡®å®šæ ‡ç­¾
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAG="latest"
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            TAG="develop"
          else
            TAG="${{ github.ref_name }}"
          fi
          
          # æ„å»ºé•œåƒåœ°å€ï¼ˆç¡®ä¿å°å†™ï¼‰
          REGISTRY_USER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          
          BACKEND_IMAGE="ghcr.io/${REGISTRY_USER_LOWER}/v7/backend:${TAG}"
          WEB_IMAGE="ghcr.io/${REGISTRY_USER_LOWER}/v7/web:${TAG}"
          
          echo "backend-image=${BACKEND_IMAGE}" >> $GITHUB_OUTPUT
          echo "web-image=${WEB_IMAGE}" >> $GITHUB_OUTPUT
          
          echo "ğŸ·ï¸ é•œåƒæ ‡ç­¾è®¾ç½®ï¼š"
          echo "  Backend: ${BACKEND_IMAGE}"
          echo "  Web: ${WEB_IMAGE}"

      - name: ğŸ”§ Deployment Configuration
        id: deployment-config
        run: |
          echo "ğŸ”§ é…ç½®éƒ¨ç½²æ¨¡å¼..."
          
          # æ ¹æ®åˆ†æ”¯ç¡®å®šéƒ¨ç½²æ¨¡å¼
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            DEPLOYMENT_MODE="production"
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            DEPLOYMENT_MODE="staging"
          else
            DEPLOYMENT_MODE="review"
          fi
          
          echo "deployment-mode=${DEPLOYMENT_MODE}" >> $GITHUB_OUTPUT
          echo "ğŸ¯ éƒ¨ç½²æ¨¡å¼: ${DEPLOYMENT_MODE}"

      - name: ğŸš€ Check Deployment Readiness
        id: deploy-check
        run: |
          echo "ğŸ” æ£€æŸ¥éƒ¨ç½²å°±ç»ªçŠ¶æ€..."
          DEPLOY_READY="false"
          
          # ä»…åœ¨æ¨é€åˆ°mainæˆ–developåˆ†æ”¯æ—¶æ£€æŸ¥éƒ¨ç½²é…ç½®
          if [[ "${{ github.event_name }}" == "push" && ("${{ github.ref }}" == "refs/heads/main" || "${{ github.ref }}" == "refs/heads/develop") ]]; then
            # æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²é…ç½®
            if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
              if [[ -n "${{ secrets.PROD_SERVER_HOST }}" && -n "${{ secrets.PROD_SERVER_USER }}" && -n "${{ secrets.PROD_SSH_KEY }}" ]]; then
                DEPLOY_READY="true"
                echo "âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²é…ç½®å®Œæ•´"
              else
                echo "âŒ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²é…ç½®ä¸å®Œæ•´"
              fi
            # æ£€æŸ¥é¢„å‘å¸ƒç¯å¢ƒéƒ¨ç½²é…ç½®
            elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
              if [[ -n "${{ secrets.STAGING_SERVER_HOST }}" && -n "${{ secrets.STAGING_SERVER_USER }}" && -n "${{ secrets.STAGING_SSH_KEY }}" ]]; then
                DEPLOY_READY="true"
                echo "âœ… é¢„å‘å¸ƒç¯å¢ƒéƒ¨ç½²é…ç½®å®Œæ•´"
              else
                echo "âš ï¸ é¢„å‘å¸ƒç¯å¢ƒéƒ¨ç½²é…ç½®ä¸å®Œæ•´ï¼Œè·³è¿‡éƒ¨ç½²"
              fi
            fi
          else
            echo "â„¹ï¸ è·³è¿‡éƒ¨ç½²é…ç½®æ£€æŸ¥ï¼ˆPRæˆ–ééƒ¨ç½²åˆ†æ”¯ï¼‰"
          fi
          
          echo "deploy-ready=${DEPLOY_READY}" >> $GITHUB_OUTPUT

  # ğŸ¦€ Analytics Engineæ£€æŸ¥
  analytics-engine-check:
    name: ğŸ¦€ Analytics Engine Check
    runs-on: ubuntu-latest
    needs: environment-check
    
    steps:
      - name: ğŸ“‹ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.87
          components: rustfmt, clippy

      - name: ğŸ“¦ Cache Cargo Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            analytics-engine/target/
          key: ${{ runner.os }}-analytics-cargo-${{ hashFiles('analytics-engine/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-analytics-cargo-

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: âœï¸ Format Check
        working-directory: analytics-engine
        run: |
          echo "ğŸ¨ æ£€æŸ¥Rustä»£ç æ ¼å¼..."
          cargo fmt --all -- --check

      - name: ğŸ” Clippy Check
        working-directory: analytics-engine
        run: |
          echo "ğŸ” è¿è¡ŒClippyä»£ç æ£€æŸ¥..."
          cargo clippy --all-targets --all-features -- -D warnings

      - name: ğŸ§ª Run Tests
        working-directory: analytics-engine
        run: |
          echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
          # å®‰è£…Pythonä¾èµ–
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          
          # è¿è¡ŒRustæµ‹è¯•
          cargo test --verbose
          
          # è¿è¡ŒPythonæµ‹è¯•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -d python/tests ]; then
            cd python && python -m pytest tests/ -v
          fi

      - name: ğŸ—ï¸ Build Check
        working-directory: analytics-engine
        run: |
          echo "ğŸ—ï¸ æ„å»ºæ£€æŸ¥..."
          ./scripts/build.sh
          
          # éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶
          if [ -f target/release/analytics-server ]; then
            echo "âœ… æ„å»ºæˆåŠŸ: $(ls -lh target/release/analytics-server)"
            echo "ğŸ” æ–‡ä»¶ç±»å‹: $(file target/release/analytics-server)"
          else
            echo "âŒ æ„å»ºå¤±è´¥ï¼šäºŒè¿›åˆ¶æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi

  # ğŸ¦€ Backendæ£€æŸ¥
  backend-check:
    name: ğŸ¦€ Backend Check
    runs-on: ubuntu-latest
    needs: environment-check
    
    steps:
      - name: ğŸ“‹ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.87
          components: rustfmt, clippy

      - name: ğŸ“¦ Cache Cargo Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            backend/target/
          key: ${{ runner.os }}-backend-cargo-${{ hashFiles('backend/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-backend-cargo-

      - name: âœï¸ Format Check
        working-directory: backend
        run: |
          echo "ğŸ¨ æ£€æŸ¥Rustä»£ç æ ¼å¼..."
          cargo fmt --all -- --check

      - name: ğŸ” Clippy Check
        working-directory: backend
        run: |
          echo "ğŸ” è¿è¡ŒClippyä»£ç æ£€æŸ¥..."
          cargo clippy --all-targets --all-features -- -D warnings

      - name: ğŸ§ª Run Tests
        working-directory: backend
        run: |
          echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
          cargo test --verbose

      - name: ğŸ—ï¸ Build Check
        working-directory: backend
        run: |
          echo "ğŸ—ï¸ æ„å»ºæ£€æŸ¥..."
          cargo build --release
          
          # éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶
          if [ -f target/release/fmod_slice ]; then
            echo "âœ… æ„å»ºæˆåŠŸ: $(ls -lh target/release/fmod_slice)"
          else
            echo "âŒ æ„å»ºå¤±è´¥ï¼šäºŒè¿›åˆ¶æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi

  # ğŸŒ Frontendæ£€æŸ¥
  frontend-check:
    name: ğŸŒ Frontend Check
    runs-on: ubuntu-latest
    needs: environment-check
    
    steps:
      - name: ğŸ“‹ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: ğŸ“¦ Install Dependencies
        working-directory: web
        run: |
          echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
          npm ci

      - name: âœï¸ Format & Lint Check
        working-directory: web
        run: |
          echo "ğŸ¨ ä»£ç æ ¼å¼æ£€æŸ¥..."
          npm run format:check || echo "âš ï¸ æ ¼å¼æ£€æŸ¥å¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º"
          
          echo "ğŸ” ESLintæ£€æŸ¥..."
          npm run lint || echo "âš ï¸ Lintæ£€æŸ¥å¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º"

      - name: ğŸ—ï¸ Build Check
        working-directory: web
        run: |
          echo "ğŸ—ï¸ æ„å»ºæ£€æŸ¥..."
          npm run build
          
          # éªŒè¯æ„å»ºäº§ç‰©
          if [ -d dist ]; then
            echo "âœ… æ„å»ºæˆåŠŸ"
            echo "ğŸ“Š æ„å»ºäº§ç‰©å¤§å°ï¼š"
            du -sh dist/*
          else
            echo "âŒ æ„å»ºå¤±è´¥ï¼šdistç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

      - name: ğŸ§ª Run Tests
        working-directory: web
        run: |
          echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
          npm test -- --run || echo "âš ï¸ æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­æµç¨‹"

  # ğŸ³ å®¹å™¨æ„å»ºå’Œæ¨é€
  build-and-push:
    name: ğŸ³ Build & Push Containers
    runs-on: ubuntu-latest
    needs: [environment-check, backend-check, frontend-check]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
      - name: ğŸ“‹ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ¦€ Build and Push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ needs.environment-check.outputs.backend-image }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: ğŸŒ Build and Push Web
        uses: docker/build-push-action@v5
        with:
          context: ./web
          file: ./web/Dockerfile
          push: true
          tags: ${{ needs.environment-check.outputs.web-image }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: ğŸ” Verify Images
        run: |
          echo "ğŸ” éªŒè¯æ¨é€çš„é•œåƒ..."
          docker pull ${{ needs.environment-check.outputs.backend-image }}
          docker pull ${{ needs.environment-check.outputs.web-image }}
          
          echo "âœ… é•œåƒæ¨é€æˆåŠŸï¼š"
          echo "  Backend: ${{ needs.environment-check.outputs.backend-image }}"
          echo "  Web: ${{ needs.environment-check.outputs.web-image }}"

  # ğŸš€ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [environment-check, analytics-engine-check, build-and-push]
    if: github.ref == 'refs/heads/main' && needs.environment-check.outputs.deploy-ready == 'true'
    environment: production
    
    steps:
      - name: ğŸ“‹ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup SSH
        run: |
          echo "ğŸ”§ é…ç½®SSHè¿æ¥..."
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.PROD_SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ“¦ Upload Deployment Scripts
        run: |
          echo "ğŸ“¦ ä¸Šä¼ éƒ¨ç½²è„šæœ¬..."
          scp -r scripts analytics-engine/scripts backend/Dockerfile web/Dockerfile compose.env.example podman-compose.yml \
            ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }}:/tmp/v7-deploy/

      - name: ğŸ¦€ Deploy Analytics Engine
        run: |
          echo "ğŸ¦€ éƒ¨ç½²Analytics Engine (systemd)..."
          ssh ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }} << 'EOF'
            cd /tmp/v7-deploy
            
            # 1. æ„å»ºAnalytics Engine
            cd analytics-engine
            echo "ğŸ—ï¸ æ„å»ºAnalytics Engine..."
            ./scripts/build.sh
            
            # 2. åœæ­¢ç°æœ‰æœåŠ¡
            echo "ğŸ›‘ åœæ­¢ç°æœ‰Analytics EngineæœåŠ¡..."
            sudo systemctl stop analytics-engine 2>/dev/null || true
            
            # 3. éƒ¨ç½²æ–°ç‰ˆæœ¬
            echo "ğŸš€ éƒ¨ç½²Analytics Engine..."
            sudo -u analytics ./scripts/deploy.sh --enable-remote
            
            # 4. éªŒè¯æœåŠ¡
            echo "ğŸ” éªŒè¯Analytics Engine..."
            sleep 10
            if systemctl is-active --quiet analytics-engine; then
              echo "âœ… Analytics Engineå¯åŠ¨æˆåŠŸ"
              # æµ‹è¯•gRPCè¿æ¥
              if command -v grpcurl &> /dev/null; then
                grpcurl -plaintext localhost:50051 analytics.AnalyticsEngine/HealthCheck
              fi
            else
              echo "âŒ Analytics Engineå¯åŠ¨å¤±è´¥"
              sudo journalctl -u analytics-engine --no-pager -n 20
              exit 1
            fi
          EOF

      - name: ğŸ³ Deploy Backend and Web Containers
        run: |
          echo "ğŸ³ éƒ¨ç½²Backendå’ŒWebå®¹å™¨..."
          ssh ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }} << 'EOF'
            cd /tmp/v7-deploy
            
            # 1. è®¾ç½®ç¯å¢ƒå˜é‡
            echo "ğŸ”§ é…ç½®ç¯å¢ƒå˜é‡..."
            cat > .env << ENVEOF
            # Analytics Engineè¿æ¥ï¼ˆå®¹å™¨è®¿é—®å®¿ä¸»æœºï¼‰
            ANALYTICS_ENGINE_ADDR=http://host.containers.internal:50051
            
            # Backendé…ç½®
            BACKEND_IMAGE=${{ needs.environment-check.outputs.backend-image }}
            BACKEND_HTTP_PORT=3000
            BACKEND_GRPC_PORT=50053
            
            # Webé…ç½®
            WEB_IMAGE=${{ needs.environment-check.outputs.web-image }}
            WEB_PORT=8080
            
            # ç¯å¢ƒ
            NODE_ENV=production
            RUST_LOG=info
            ENVEOF
            
            # 2. åœæ­¢ç°æœ‰å®¹å™¨
            echo "ğŸ›‘ åœæ­¢ç°æœ‰å®¹å™¨..."
            podman-compose down || true
            
            # 3. æ‹‰å–æœ€æ–°é•œåƒ
            echo "ğŸ“¦ æ‹‰å–å®¹å™¨é•œåƒ..."
            podman pull ${{ needs.environment-check.outputs.backend-image }}
            podman pull ${{ needs.environment-check.outputs.web-image }}
            
            # 4. å¯åŠ¨å®¹å™¨æœåŠ¡
            echo "ğŸš€ å¯åŠ¨å®¹å™¨æœåŠ¡..."
            podman-compose up -d
            
            # 5. ç­‰å¾…æœåŠ¡å°±ç»ª
            echo "â³ ç­‰å¾…æœåŠ¡å°±ç»ª..."
            sleep 30
            
            # 6. éªŒè¯å®¹å™¨çŠ¶æ€
            echo "ğŸ” éªŒè¯å®¹å™¨çŠ¶æ€..."
            podman-compose ps
            
            # 7. å¥åº·æ£€æŸ¥
            echo "ğŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥..."
            
            # Backendå¥åº·æ£€æŸ¥
            for i in {1..5}; do
              if curl -f http://localhost:3000/health; then
                echo "âœ… Backendå¥åº·æ£€æŸ¥é€šè¿‡"
                break
              else
                echo "â³ Backendå¥åº·æ£€æŸ¥å¤±è´¥ï¼Œé‡è¯• $i/5..."
                sleep 10
              fi
              if [ $i -eq 5 ]; then
                echo "âŒ Backendå¥åº·æ£€æŸ¥æœ€ç»ˆå¤±è´¥"
                podman logs v7-backend
                exit 1
              fi
            done
            
            # Webå¥åº·æ£€æŸ¥
            for i in {1..5}; do
              if curl -f http://localhost:8080/health; then
                echo "âœ… Webå¥åº·æ£€æŸ¥é€šè¿‡"
                break
              else
                echo "â³ Webå¥åº·æ£€æŸ¥å¤±è´¥ï¼Œé‡è¯• $i/5..."
                sleep 10
              fi
              if [ $i -eq 5 ]; then
                echo "âŒ Webå¥åº·æ£€æŸ¥æœ€ç»ˆå¤±è´¥"
                podman logs v7-web
                exit 1
              fi
            done
          EOF

      - name: ğŸ” End-to-End Verification
        run: |
          echo "ğŸ” ç«¯åˆ°ç«¯éªŒè¯..."
          ssh ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }} << 'EOF'
            echo "ğŸ”— æµ‹è¯•å®Œæ•´é“¾è·¯é€šä¿¡..."
            
            # æµ‹è¯•Web -> Backend -> Analyticsé€šä¿¡é“¾
            echo "1. æµ‹è¯•Webé™æ€èµ„æº..."
            curl -f http://localhost:8080/ > /dev/null && echo "âœ… Webé™æ€èµ„æºæ­£å¸¸" || echo "âŒ Webé™æ€èµ„æºå¼‚å¸¸"
            
            echo "2. æµ‹è¯•Backend API..."
            curl -f http://localhost:8080/api/health > /dev/null && echo "âœ… Backend APIæ­£å¸¸" || echo "âŒ Backend APIå¼‚å¸¸"
            
            echo "3. æµ‹è¯•Analytics Engineé›†æˆ..."
            # é€šè¿‡Backendä»£ç†æµ‹è¯•Analytics Engine
            if curl -f -X POST http://localhost:8080/api/analytics -H "Content-Type: application/json" -d '{"algorithm":"mean","data":[1,2,3,4,5]}' > /dev/null; then
              echo "âœ… Analytics Engineé›†æˆæ­£å¸¸"
            else
              echo "âš ï¸ Analytics Engineé›†æˆå¯èƒ½å¼‚å¸¸"
            fi
            
            echo "ğŸ“Š ç³»ç»Ÿèµ„æºä½¿ç”¨ï¼š"
            echo "CPUå’Œå†…å­˜ï¼š"
            top -bn1 | head -n 5
            echo "å®¹å™¨èµ„æºï¼š"
            podman stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}"
          EOF

      - name: ğŸ“Š Deployment Summary
        run: |
          echo "ğŸ‰ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆï¼"
          echo "================================"
          echo "ğŸ¯ æ¶æ„æ¨¡å¼: æ··åˆéƒ¨ç½²"
          echo "ğŸ¦€ Analytics Engine: systemd (åŸç”Ÿæ€§èƒ½)"
          echo "ğŸ³ Backend + Web: å®¹å™¨åŒ– (æ ‡å‡†åŒ–è¿ç»´)"
          echo ""
          echo "ğŸŒ è®¿é—®åœ°å€ï¼š"
          echo "  - å‰ç«¯åº”ç”¨: http://${{ secrets.PROD_SERVER_HOST }}:8080"
          echo "  - åç«¯API: http://${{ secrets.PROD_SERVER_HOST }}:3000"
          echo "  - Analytics: localhost:50051 (æœåŠ¡å™¨å†…éƒ¨)"
          echo ""
          echo "ğŸ” å¥åº·æ£€æŸ¥ï¼š"
          echo "  - Web: http://${{ secrets.PROD_SERVER_HOST }}:8080/health"
          echo "  - Backend: http://${{ secrets.PROD_SERVER_HOST }}:3000/health"
          echo ""
          echo "ğŸ“Š éƒ¨ç½²ä¿¡æ¯ï¼š"
          echo "  - æ—¶é—´: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "  - ç‰ˆæœ¬: ${{ github.sha }}"
          echo "  - Backendé•œåƒ: ${{ needs.environment-check.outputs.backend-image }}"
          echo "  - Webé•œåƒ: ${{ needs.environment-check.outputs.web-image }}"

  # ğŸ§ª é¢„å‘å¸ƒç¯å¢ƒéƒ¨ç½²
  deploy-staging:
    name: ğŸ§ª Deploy to Staging
    runs-on: ubuntu-latest
    needs: [environment-check, analytics-engine-check, build-and-push]
    if: github.ref == 'refs/heads/develop' && needs.environment-check.outputs.deploy-ready == 'true'
    environment: staging
    
    steps:
      - name: ğŸ“‹ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ§ª Staging Deployment
        run: |
          echo "ğŸ§ª é¢„å‘å¸ƒç¯å¢ƒéƒ¨ç½²..."
          echo "ğŸ·ï¸ ç‰ˆæœ¬: ${{ needs.environment-check.outputs.backend-image }}"
          echo "ğŸ“ æ³¨æ„ï¼šé¢„å‘å¸ƒç¯å¢ƒéƒ¨ç½²é€»è¾‘ä¸ç”Ÿäº§ç¯å¢ƒç±»ä¼¼"
          echo "ğŸ’¡ ä½¿ç”¨ STAGING_* å‰ç¼€çš„secretsé…ç½®é¢„å‘å¸ƒæœåŠ¡å™¨"
          
          # å¯ä»¥å¤åˆ¶ç”Ÿäº§ç¯å¢ƒçš„éƒ¨ç½²é€»è¾‘ï¼Œä½¿ç”¨ä¸åŒçš„æœåŠ¡å™¨é…ç½®
          # ä¾‹å¦‚ï¼šSTAGING_SERVER_HOST, STAGING_SERVER_USER, STAGING_SSH_KEY

  # ğŸ“Š å·¥ä½œæµæ€»ç»“
  workflow-summary:
    name: ğŸ“Š Workflow Summary
    runs-on: ubuntu-latest
    needs: [environment-check, analytics-engine-check, backend-check, frontend-check, build-and-push, deploy-production, deploy-staging]
    if: always()
    
    steps:
      - name: ğŸ“Š CI/CD Pipeline Summary
        run: |
          echo "ğŸ” V7æ··åˆæ¶æ„CI/CDæµæ°´çº¿æ€»ç»“"
          echo "========================================"
          echo "ğŸ”§ ç¯å¢ƒæ£€æŸ¥: ${{ needs.environment-check.result }}"
          echo "ğŸ¦€ Analytics Engine: ${{ needs.analytics-engine-check.result }}"
          echo "ğŸ¦€ Backendæ£€æŸ¥: ${{ needs.backend-check.result }}"
          echo "ğŸŒ Frontendæ£€æŸ¥: ${{ needs.frontend-check.result }}"
          echo "ğŸ³ å®¹å™¨æ„å»º: ${{ needs.build-and-push.result }}"
          echo "ğŸš€ ç”Ÿäº§éƒ¨ç½²: ${{ needs.deploy-production.result }}"
          echo "ğŸ§ª é¢„å‘å¸ƒéƒ¨ç½²: ${{ needs.deploy-staging.result }}"
          echo "========================================"
          
          # è®¡ç®—æ•´ä½“çŠ¶æ€
          OVERALL_STATUS="success"
          
          # æ£€æŸ¥å¿…éœ€çš„æ­¥éª¤
          if [[ "${{ needs.environment-check.result }}" != "success" ]]; then
            OVERALL_STATUS="failed"
            echo "âŒ ç¯å¢ƒæ£€æŸ¥å¤±è´¥"
          fi
          
          if [[ "${{ needs.analytics-engine-check.result }}" != "success" ]]; then
            OVERALL_STATUS="failed"
            echo "âŒ Analytics Engineæ£€æŸ¥å¤±è´¥"
          fi
          
          if [[ "${{ needs.backend-check.result }}" != "success" ]]; then
            OVERALL_STATUS="failed"
            echo "âŒ Backendæ£€æŸ¥å¤±è´¥"
          fi
          
          if [[ "${{ needs.frontend-check.result }}" != "success" ]]; then
            OVERALL_STATUS="failed"
            echo "âŒ Frontendæ£€æŸ¥å¤±è´¥"
          fi
          
          # å¯¹äºmainåˆ†æ”¯ï¼Œæ£€æŸ¥éƒ¨ç½²çŠ¶æ€
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            if [[ "${{ needs.build-and-push.result }}" != "success" ]]; then
              OVERALL_STATUS="failed"
              echo "âŒ å®¹å™¨æ„å»ºå¤±è´¥"
            fi
            
            if [[ "${{ needs.deploy-production.result }}" != "success" ]]; then
              OVERALL_STATUS="failed"
              echo "âŒ ç”Ÿäº§éƒ¨ç½²å¤±è´¥"
            fi
          fi
          
          if [[ "$OVERALL_STATUS" == "success" ]]; then
            echo "ğŸ‰ CI/CDæµæ°´çº¿æ‰§è¡ŒæˆåŠŸï¼"
            
            if [[ "${{ github.ref }}" == "refs/heads/main" && "${{ needs.deploy-production.result }}" == "success" ]]; then
              echo ""
              echo "ğŸŒ ç”Ÿäº§ç¯å¢ƒè®¿é—®åœ°å€ï¼š"
              echo "  - åº”ç”¨å…¥å£: http://${{ secrets.PROD_SERVER_HOST }}:8080"
              echo "  - APIæ¥å£: http://${{ secrets.PROD_SERVER_HOST }}:3000"
              echo ""
              echo "ğŸ—ï¸ æ¶æ„ç‰¹ç‚¹ï¼š"
              echo "  âœ… Analytics Engine: systemdéƒ¨ç½²ï¼Œæè‡´æ€§èƒ½"
              echo "  âœ… Backend + Web: å®¹å™¨åŒ–éƒ¨ç½²ï¼Œæ ‡å‡†åŒ–è¿ç»´"
              echo "  âœ… æ··åˆæ¶æ„: å¹³è¡¡æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§"
            fi
          else
            echo "âŒ CI/CDæµæ°´çº¿æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šè¿°æ­¥éª¤"
            exit 1
          fi

      - name: ğŸ“ Next Steps
        if: success()
        run: |
          echo "ğŸ“ åç»­æ“ä½œæŒ‡å—ï¼š"
          echo "========================================"
          
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "ğŸ“‹ PRæ£€æŸ¥å®Œæˆï¼Œç­‰å¾…åˆå¹¶"
            echo "  - æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥å®‰å…¨åˆå¹¶"
            echo "  - åˆå¹¶åˆ°mainåˆ†æ”¯å°†è§¦å‘ç”Ÿäº§éƒ¨ç½²"
            
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "ğŸ‰ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
            echo "  - åº”ç”¨å·²åœ¨ç”Ÿäº§ç¯å¢ƒè¿è¡Œ"
            echo "  - ç›‘æ§æœåŠ¡çŠ¶æ€å’Œæ€§èƒ½æŒ‡æ ‡"
            echo "  - å¦‚æœ‰é—®é¢˜ï¼Œå¯å›æ»šåˆ°ä¸Šä¸ªç‰ˆæœ¬"
            
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "ğŸ§ª å¼€å‘åˆ†æ”¯æ›´æ–°å®Œæˆ"
            echo "  - å¯ä»¥åœ¨é¢„å‘å¸ƒç¯å¢ƒæµ‹è¯•æ–°åŠŸèƒ½"
            echo "  - æµ‹è¯•é€šè¿‡ååˆå¹¶åˆ°mainåˆ†æ”¯"
          fi
          
          echo ""
          echo "ğŸ”— ç›¸å…³é“¾æ¥ï¼š"
          echo "  - é¡¹ç›®æ–‡æ¡£: README.md"
          echo "  - éƒ¨ç½²æŒ‡å—: scripts/DEPLOYMENT_GUIDE.md"
          echo "  - æ¶æ„è¯´æ˜: docs/architecture.md" 