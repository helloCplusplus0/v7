# ğŸš€ V7 ç®€åŒ–æ„å»ºæµæ°´çº¿
# ä¸“æ³¨äºåŸºæœ¬çš„é•œåƒæ„å»ºå’Œæ¨é€åŠŸèƒ½ï¼Œé¿å…å¤æ‚çš„éƒ¨ç½²é€»è¾‘

name: Simple Build and Push

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}/v7

jobs:
  # ğŸ” åŸºç¡€æ£€æŸ¥
  basic-checks:
    name: åŸºç¡€æ£€æŸ¥
    runs-on: ubuntu-latest
    outputs:
      should-build: ${{ steps.check.outputs.should-build }}
      backend-tag: ${{ steps.tags.outputs.backend-tag }}
      web-tag: ${{ steps.tags.outputs.web-tag }}
      
    steps:
      - name: ğŸ“‹ Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ” æ£€æŸ¥å˜æ›´
        id: check
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰ä»£ç å˜æ›´éœ€è¦æ„å»º
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "should-build=true" >> $GITHUB_OUTPUT
            echo "âœ… Pushäº‹ä»¶ï¼Œéœ€è¦æ„å»º"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "should-build=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ PRäº‹ä»¶ï¼Œä»…æ£€æŸ¥ä¸æ„å»º"
          else
            echo "should-build=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ å…¶ä»–äº‹ä»¶ï¼Œè·³è¿‡æ„å»º"
          fi

      - name: ğŸ·ï¸ ç”Ÿæˆé•œåƒæ ‡ç­¾
        id: tags
        run: |
          # æ ¹æ®åˆ†æ”¯å’Œäº‹ä»¶ç±»å‹ç”Ÿæˆæ ‡ç­¾
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAG="latest"
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            TAG="develop"
          else
            TAG="${{ github.ref_name }}"
          fi
          
          # æ·»åŠ commitçŸ­ç 
          COMMIT_SHORT=$(echo "${{ github.sha }}" | cut -c1-8)
          
          echo "backend-tag=${{ env.IMAGE_PREFIX }}/backend:${TAG}" >> $GITHUB_OUTPUT
          echo "web-tag=${{ env.IMAGE_PREFIX }}/web:${TAG}" >> $GITHUB_OUTPUT
          
          echo "ğŸ·ï¸ é•œåƒæ ‡ç­¾:"
          echo "  Backend: ${{ env.IMAGE_PREFIX }}/backend:${TAG}"
          echo "  Web: ${{ env.IMAGE_PREFIX }}/web:${TAG}"
          echo "  Commit: ${COMMIT_SHORT}"

  # ğŸ¦€ Backendæ£€æŸ¥å’Œæ„å»º
  backend:
    name: Backendæ„å»º
    runs-on: ubuntu-latest
    needs: basic-checks
    if: needs.basic-checks.outputs.should-build == 'true'
    
    steps:
      - name: ğŸ“‹ Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ è®¾ç½®Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” ç™»å½•GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ—ï¸ æ„å»ºå’Œæ¨é€Backendé•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ needs.basic-checks.outputs.backend-tag }}
            ${{ env.IMAGE_PREFIX }}/backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: ğŸ” éªŒè¯Backendé•œåƒ
        run: |
          echo "ğŸ” éªŒè¯Backendé•œåƒ..."
          docker pull ${{ needs.basic-checks.outputs.backend-tag }}
          docker images | grep backend
          echo "âœ… Backendé•œåƒéªŒè¯æˆåŠŸ"

  # ğŸŒ Webæ£€æŸ¥å’Œæ„å»º
  web:
    name: Webæ„å»º
    runs-on: ubuntu-latest
    needs: basic-checks
    if: needs.basic-checks.outputs.should-build == 'true'
    
    steps:
      - name: ğŸ“‹ Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ è®¾ç½®Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” ç™»å½•GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ—ï¸ æ„å»ºå’Œæ¨é€Webé•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./web
          file: ./web/Dockerfile
          push: true
          tags: |
            ${{ needs.basic-checks.outputs.web-tag }}
            ${{ env.IMAGE_PREFIX }}/web:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: ğŸ” éªŒè¯Webé•œåƒ
        run: |
          echo "ğŸ” éªŒè¯Webé•œåƒ..."
          docker pull ${{ needs.basic-checks.outputs.web-tag }}
          docker images | grep web
          echo "âœ… Webé•œåƒéªŒè¯æˆåŠŸ"

  # ğŸ“Š æ„å»ºæ€»ç»“
  build-summary:
    name: æ„å»ºæ€»ç»“
    runs-on: ubuntu-latest
    needs: [basic-checks, backend, web]
    if: always() && needs.basic-checks.outputs.should-build == 'true'
    
    steps:
      - name: ğŸ“Š ç”Ÿæˆæ„å»ºæŠ¥å‘Š
        run: |
          echo "ğŸ‰ V7é•œåƒæ„å»ºå®Œæˆï¼"
          echo "================================"
          echo "ğŸ”§ æ„å»ºä¿¡æ¯:"
          echo "  äº‹ä»¶: ${{ github.event_name }}"
          echo "  åˆ†æ”¯: ${{ github.ref_name }}"
          echo "  æäº¤: ${{ github.sha }}"
          echo "  æ—¶é—´: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo ""
          echo "ğŸ“¦ æ„å»ºé•œåƒ:"
          echo "  Backend: ${{ needs.basic-checks.outputs.backend-tag }}"
          echo "  Web: ${{ needs.basic-checks.outputs.web-tag }}"
          echo ""
          echo "ğŸš€ éƒ¨ç½²å‘½ä»¤ï¼š"
          echo "curl -sSL https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/remote-deploy.sh | bash -s -- \\"
          echo "  -B ${{ needs.basic-checks.outputs.backend-tag }} \\"
          echo "  -W ${{ needs.basic-checks.outputs.web-tag }}"
          echo ""
          echo "ğŸ”§ çŠ¶æ€æ£€æŸ¥:"
          echo "  Backend: ${{ needs.backend.result }}"
          echo "  Web: ${{ needs.web.result }}"
          echo "================================"

      - name: âœ… æ£€æŸ¥æ„å»ºçŠ¶æ€
        run: |
          if [[ "${{ needs.backend.result }}" != "success" ]]; then
            echo "âŒ Backendæ„å»ºå¤±è´¥"
            exit 1
          fi
          
          if [[ "${{ needs.web.result }}" != "success" ]]; then
            echo "âŒ Webæ„å»ºå¤±è´¥"
            exit 1
          fi
          
          echo "ğŸ‰ æ‰€æœ‰é•œåƒæ„å»ºæˆåŠŸï¼"

  # ğŸ’¬ PRè¯„è®º (ä»…åœ¨PRæ—¶è¿è¡Œ)
  pr-comment:
    name: PRè¯„è®º
    runs-on: ubuntu-latest
    needs: [basic-checks, backend, web]
    if: github.event_name == 'pull_request' && always()
    
    steps:
      - name: ğŸ’¬ åˆ›å»ºPRè¯„è®º
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æ„å»ºæŠ¥å‘Šè¯„è®º
            const existingComment = comments.find(comment => 
              comment.body.includes('ğŸš€ V7æ„å»ºæ£€æŸ¥æŠ¥å‘Š')
            );
            
            const reportBody = `## ğŸš€ V7æ„å»ºæ£€æŸ¥æŠ¥å‘Š
            
            ### ğŸ“‹ æ£€æŸ¥ç»“æœ
            - **Basic Checks**: ${{ needs.basic-checks.result }}
            - **Backend Build**: ${{ needs.backend.result || 'skipped' }}
            - **Web Build**: ${{ needs.web.result || 'skipped' }}
            
            ### ğŸ“¦ æ„å»ºä¿¡æ¯
            - **åˆ†æ”¯**: \`${{ github.ref_name }}\`
            - **æäº¤**: \`${{ github.sha }}\`
            - **è§¦å‘äº‹ä»¶**: ${{ github.event_name }}
            
            ### ğŸ”§ åç»­æ“ä½œ
            ${needs.basic-checks.outputs.should-build == 'true' ? 
              'âœ… é•œåƒå·²æ„å»ºï¼Œåˆå¹¶åå¯ç”¨äºéƒ¨ç½²' : 
              'â„¹ï¸ ä»…è¿›è¡Œæ£€æŸ¥ï¼Œæœªæ„å»ºé•œåƒ'}
            
            ---
            *è‡ªåŠ¨ç”Ÿæˆäº ${new Date().toISOString()}*`;
            
            if (existingComment) {
              // æ›´æ–°ç°æœ‰è¯„è®º
              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: reportBody
              });
            } else {
              // åˆ›å»ºæ–°è¯„è®º
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: reportBody
              });
            } 