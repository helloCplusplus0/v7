# ğŸš€ Protoæ–‡ä»¶åŒæ­¥å’ŒéªŒè¯å·¥ä½œæµ
# ç¡®ä¿å‰åç«¯protoå®šä¹‰å§‹ç»ˆä¿æŒåŒæ­¥ï¼Œå¹¶æ£€æµ‹breaking changes

name: Proto Sync and Validation

on:
  push:
    paths:
      - 'backend/proto/**'
      - 'web/buf.yaml'
      - 'web/buf.gen.yaml'
      - '.github/workflows/proto-sync.yml'
  pull_request:
    paths:
      - 'backend/proto/**'
      - 'web/buf.yaml'
      - 'web/buf.gen.yaml'

jobs:
  proto-validation:
    name: Protoæ–‡ä»¶éªŒè¯å’Œä»£ç ç”Ÿæˆ
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkoutä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºbreaking changeæ£€æµ‹
    
    - name: ğŸ”§ è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: web/package-lock.json
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      working-directory: web
      run: |
        npm ci
        npm install --save-dev @bufbuild/buf @bufbuild/protoc-gen-es @connectrpc/protoc-gen-connect-es
    
    - name: ğŸ” éªŒè¯protoæ–‡ä»¶è¯­æ³•
      working-directory: web
      run: |
        echo "ğŸ” éªŒè¯protoæ–‡ä»¶è¯­æ³•..."
        npx buf lint
    
    - name: ğŸ”„ æ£€æµ‹Breaking Changes
      working-directory: web
      run: |
        echo "ğŸ”„ æ£€æµ‹Breaking Changes..."
        # æ£€æŸ¥æ˜¯å¦æœ‰ä¹‹å‰çš„æäº¤è¿›è¡Œæ¯”è¾ƒ
        if git rev-parse HEAD~1 >/dev/null 2>&1; then
          npx buf breaking --against '.git#branch=HEAD~1,subdir=backend/proto'
        else
          echo "â„¹ï¸  é¦–æ¬¡æäº¤ï¼Œè·³è¿‡breaking changeæ£€æŸ¥"
        fi
    
    - name: ğŸ¨ ç”ŸæˆTypeScriptä»£ç 
      working-directory: web
      run: |
        echo "ğŸ¨ ç”ŸæˆTypeScriptä»£ç ..."
        npx buf generate
    
    - name: ğŸ” éªŒè¯ç”Ÿæˆçš„ä»£ç 
      working-directory: web
      run: |
        echo "ğŸ” éªŒè¯ç”Ÿæˆçš„ä»£ç ..."
        # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "src/generated/backend_pb.ts" ]; then
          echo "âŒ backend_pb.ts æœªç”Ÿæˆ"
          exit 1
        fi
        
        if [ ! -f "src/generated/backend_connect.ts" ]; then
          echo "âŒ backend_connect.ts æœªç”Ÿæˆ"
          exit 1
        fi
        
        # è¿è¡ŒTypeScriptç±»å‹æ£€æŸ¥
        npm run type-check
    
    - name: ğŸ“Š ç”ŸæˆæŠ¥å‘Š
      working-directory: web
      run: |
        echo "ğŸ“Š ç”ŸæˆProtoåŒæ­¥æŠ¥å‘Š..."
        
        # åˆ›å»ºæŠ¥å‘Šç›®å½•
        mkdir -p ../reports
        
        # ç”ŸæˆæŠ¥å‘Š
        cat > ../reports/proto-sync-report.md << 'EOF'
        # Protoæ–‡ä»¶åŒæ­¥æŠ¥å‘Š
        
        ## ğŸ“‹ éªŒè¯ç»“æœ
        
        - âœ… Protoæ–‡ä»¶è¯­æ³•æ£€æŸ¥é€šè¿‡
        - âœ… Breaking Changeæ£€æµ‹å®Œæˆ
        - âœ… TypeScriptä»£ç ç”ŸæˆæˆåŠŸ
        - âœ… ç±»å‹æ£€æŸ¥é€šè¿‡
        
        ## ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶
        
        - `src/generated/backend_pb.ts` - Protoæ¶ˆæ¯ç±»å‹å®šä¹‰
        - `src/generated/backend_connect.ts` - ConnectRPCæœåŠ¡å®šä¹‰
        
        ## ğŸ”§ å·¥å…·ç‰ˆæœ¬
        
        - Buf CLI: $(npx buf --version)
        - Node.js: $(node --version)
        - npm: $(npm --version)
        
        ## ğŸ“Š ç»Ÿè®¡ä¿¡æ¯
        
        - ç”Ÿæˆæ—¶é—´: $(date)
        - æäº¤å“ˆå¸Œ: ${{ github.sha }}
        - åˆ†æ”¯: ${{ github.ref_name }}
        
        EOF
        
        echo "âœ… æŠ¥å‘Šå·²ç”Ÿæˆ"
    
    - name: ğŸ“¤ ä¸Šä¼ ç”Ÿæˆçš„ä»£ç 
      uses: actions/upload-artifact@v4
      with:
        name: generated-proto-code
        path: |
          web/src/generated/
          reports/
        retention-days: 30
    
    - name: ğŸ’¬ PRè¯„è®º (ä»…é™PR)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // è¯»å–æŠ¥å‘Šæ–‡ä»¶
          const reportPath = path.join(process.cwd(), 'reports', 'proto-sync-report.md');
          const report = fs.readFileSync(reportPath, 'utf8');
          
          // å‘å¸ƒPRè¯„è®º
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ğŸš€ Protoæ–‡ä»¶åŒæ­¥ç»“æœ\n\n${report}`
          });

  proto-format-check:
    name: Protoæ–‡ä»¶æ ¼å¼æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkoutä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ”§ è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: web/package-lock.json
    
    - name: ğŸ“¦ å®‰è£…Buf CLI
      working-directory: web
      run: |
        npm ci
        npm install --save-dev @bufbuild/buf
    
    - name: ğŸ¨ æ£€æŸ¥protoæ–‡ä»¶æ ¼å¼
      working-directory: web
      run: |
        echo "ğŸ¨ æ£€æŸ¥protoæ–‡ä»¶æ ¼å¼..."
        
        # æ ¼å¼åŒ–protoæ–‡ä»¶
        npx buf format --diff --exit-code
        
        if [ $? -eq 0 ]; then
          echo "âœ… Protoæ–‡ä»¶æ ¼å¼æ­£ç¡®"
        else
          echo "âŒ Protoæ–‡ä»¶æ ¼å¼éœ€è¦ä¿®å¤"
          echo "è¯·è¿è¡Œ: npx buf format -w"
          exit 1
        fi

  integration-test:
    name: é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    needs: [proto-validation]
    
    steps:
    - name: ğŸ“¥ Checkoutä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ”§ è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: web/package-lock.json
    
    - name: ğŸ¦€ è®¾ç½®Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
    
    - name: ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–
      working-directory: web
      run: |
        npm ci
        npm install --save-dev @bufbuild/buf @bufbuild/protoc-gen-es @connectrpc/protoc-gen-connect-es
    
    - name: ğŸ¨ ç”Ÿæˆprotoä»£ç 
      working-directory: web
      run: npx buf generate
    
    - name: ğŸš€ å¯åŠ¨åç«¯æœåŠ¡
      working-directory: backend
      run: |
        # åœ¨åå°å¯åŠ¨åç«¯æœåŠ¡
        cargo run &
        BACKEND_PID=$!
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 10
        
        # æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
        if curl -f http://localhost:50053/health; then
          echo "âœ… åç«¯æœåŠ¡å¯åŠ¨æˆåŠŸ"
        else
          echo "âŒ åç«¯æœåŠ¡å¯åŠ¨å¤±è´¥"
          kill $BACKEND_PID
          exit 1
        fi
        
        # ä¿å­˜PIDç”¨äºåç»­æ¸…ç†
        echo $BACKEND_PID > /tmp/backend.pid
    
    - name: ğŸ§ª è¿è¡Œé›†æˆæµ‹è¯•
      working-directory: web
      run: |
        # æ„å»ºå‰ç«¯
        npm run build
        
        # è¿è¡Œç±»å‹æ£€æŸ¥
        npm run type-check
        
        # è¿è¡Œæµ‹è¯•
        npm test
    
    - name: ğŸ§¹ æ¸…ç†
      if: always()
      run: |
        # åœæ­¢åç«¯æœåŠ¡
        if [ -f /tmp/backend.pid ]; then
          kill $(cat /tmp/backend.pid) || true
        fi 