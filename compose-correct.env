# 🚀 V7项目 Backend + Web 容器编排环境变量配置（正确架构版）
# 
# 🏗️ 实际部署架构：
# - ☁️ 云服务器: Backend(容器) + Web(容器)  
# - 🏠 本地局域网: Analytics Engine(systemd服务)
# - 🔐 连接方式: WireGuard VPN
#
# 🔧 关键修复：
# - Backend通过WireGuard VPN（10.0.0.1:50051）访问本地Analytics Engine
# - Web和Backend在同一bridge网络，可通过hostname互相访问
# - 不再依赖host.containers.internal（那是云服务器本地访问）

# ========================================
# 🌍 全局配置
# ========================================
NODE_ENV=production
RUST_LOG=info
TZ=Asia/Shanghai

# ========================================
# 🔌 服务端口配置
# ========================================
# Backend 服务端口
BACKEND_HTTP_PORT=3000
BACKEND_GRPC_PORT=50053

# Web 服务端口
WEB_PORT=8080

# ========================================
# 🐳 容器镜像配置（生产镜像）
# ========================================
BACKEND_IMAGE=ghcr.io/hellocplusplus0/v7/backend:latest
WEB_IMAGE=ghcr.io/hellocplusplus0/v7/web:latest

# ========================================
# 👤 容器用户配置（安全）
# ========================================
# Backend 用户配置
BACKEND_UID=1002
BACKEND_GID=1002

# Web 用户配置
WEB_UID=1003
WEB_GID=1003

# ========================================
# 🔗 Analytics Engine 连接配置（关键修复）
# ========================================
# 🔑 核心：Backend容器通过WireGuard VPN访问本地局域网的Analytics Engine
# 
# 📍 架构说明：
# - Analytics Engine: 本地局域网systemd服务，监听127.0.0.1:50051
# - WireGuard VPN: 建立云服务器到本地局域网的安全隧道
# - VPN网段: 10.0.0.0/24（可根据实际WireGuard配置调整）
# - 访问地址: 10.0.0.1:50051（本地网关在VPN中的地址）

ANALYTICS_ENGINE_ENDPOINT=http://10.0.0.1:50051
ANALYTICS_CONNECTION_TIMEOUT_SEC=15
ANALYTICS_REQUEST_TIMEOUT_SEC=60

# 📝 重要提醒：
# 1. 部署前确保WireGuard VPN已建立并测试连通性
# 2. 如VPN网段不同，请相应调整ANALYTICS_ENGINE_ENDPOINT
# 3. 可通过以下命令验证连接：
#    podman exec v7-backend wget -qO- http://10.0.0.1:50051/health

# ========================================
# 🗄️ 数据库配置
# ========================================
DATABASE_URL=sqlite:/app/data/prod.db
ENABLE_PERSISTENCE=true
CREATE_TEST_DATA=false

# ========================================
# 🌐 网络配置
# ========================================
# 容器网络子网（Backend和Web的bridge网络）
V7_NETWORK_SUBNET=172.20.0.0/16

# ========================================
# 🔒 安全配置
# ========================================
# JWT密钥（生产环境请使用强密钥）
JWT_SECRET=prod-jwt-secret-change-me-in-production

# ========================================
# 📊 性能配置
# ========================================
# Rust 运行时配置
RUST_BACKTRACE=1
MALLOC_ARENA_MAX=2
MALLOC_TRIM_THRESHOLD_=131072 