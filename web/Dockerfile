# ===== ğŸ—ï¸ æ„å»ºé˜¶æ®µ =====
FROM node:18-alpine AS builder

# ğŸ“¦ è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /build

# ğŸ”§ å¤åˆ¶packageæ–‡ä»¶å¹¶å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬å¼€å‘ä¾èµ–ï¼‰
COPY package*.json ./
RUN npm ci

# ğŸ“¦ å¤åˆ¶æºä»£ç 
COPY . .

# ğŸŒ è®¾ç½®æ„å»ºç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV VITE_API_BASE_URL=/api

# ğŸ—ï¸ æ„å»ºåº”ç”¨
RUN npm run build

# ===== ğŸƒ è¿è¡Œé˜¶æ®µ =====
FROM nginx:1.25-alpine AS runtime

# ğŸ“¦ å®‰è£…è¿è¡Œæ—¶ä¾èµ–å’Œdumb-init
RUN apk add --no-cache \
    curl \
    tzdata \
    dumb-init \
    && rm -rf /var/cache/apk/*

# ğŸ”§ å¤åˆ¶nginxé…ç½®æ–‡ä»¶
COPY nginx.conf /etc/nginx/nginx.conf

# ğŸ‘¤ åˆ›å»ºnginxuserç”¨æˆ·ï¼ˆåŸºäºDocker Forumsæœ€ä½³å®è·µï¼‰
RUN adduser --system --uid 1002 --no-create-home --disabled-login --group nginxuser

# ğŸ“ è®¾ç½®nginxç›®å½•æƒé™ï¼ˆåŸºäºä¸“å®¶å»ºè®®ï¼‰
RUN chown -R nginxuser:nginxuser /var/cache/nginx \
    && chown -R nginxuser:nginxuser /var/log/nginx \
    && chown -R nginxuser:nginxuser /etc/nginx/conf.d \
    && touch /var/run/nginx.pid \
    && chown -R nginxuser:nginxuser /var/run/nginx.pid

# ğŸ“¦ å¤åˆ¶æ„å»ºäº§ç‰©åˆ°nginxé»˜è®¤ç›®å½•
COPY --from=builder --chown=nginxuser:nginxuser /build/dist /usr/share/nginx/html

# ğŸ‘¤ åˆ‡æ¢åˆ°éç‰¹æƒç”¨æˆ·
USER nginxuser

# ğŸŒ æš´éœ²8080ç«¯å£ï¼ˆéç‰¹æƒç«¯å£ï¼‰
EXPOSE 8080

# ğŸš€ ä½¿ç”¨dumb-initå¯åŠ¨nginx
ENTRYPOINT ["dumb-init", "nginx", "-g", "daemon off;"] 