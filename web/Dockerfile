# ðŸš€ V7 Web å‰ç«¯ä¼˜åŒ–é•œåƒ
# SolidJS + TypeScript + Vite åº”ç”¨å®¹å™¨åŒ–éƒ¨ç½²
# è½»é‡åŒ–ã€æžè‡´æ€§èƒ½ã€å®‰å…¨å¼ºåŒ–çš„å¤šé˜¶æ®µæž„å»º

# ðŸ“ æž„å»ºå‚æ•°ï¼ˆå‚æ•°åŒ–ç®¡ç†ï¼‰
ARG NODE_VERSION=18
ARG NGINX_VERSION=1.25-alpine
ARG WEB_PORT=3000
ARG WEB_USER=appuser
ARG WEB_UID=1003
ARG WEB_GID=1003

# ===== ðŸ—ï¸ ä¾èµ–å®‰è£…é˜¶æ®µ =====
FROM node:${NODE_VERSION}-alpine AS deps

# ðŸ“¦ å®‰è£…æž„å»ºä¾èµ–
RUN apk add --no-cache \
    python3 \
    make \
    g++ \
    && rm -rf /var/cache/apk/*

WORKDIR /app

# ðŸ“¦ å¤åˆ¶ä¾èµ–é…ç½®æ–‡ä»¶ï¼ˆç¼“å­˜ä¼˜åŒ–ï¼‰
COPY package.json package-lock.json ./

# ðŸ”§ å®‰è£…å…¨éƒ¨ä¾èµ–ï¼ˆåŒ…æ‹¬å¼€å‘ä¾èµ–ï¼Œä¿®å¤æž„å»ºé”™è¯¯ï¼‰
RUN npm ci --verbose && \
    npm cache clean --force

# ===== ðŸ—ï¸ æž„å»ºé˜¶æ®µ =====
FROM node:${NODE_VERSION}-alpine AS builder

WORKDIR /app

# ðŸ“¦ ä»Žä¾èµ–é˜¶æ®µå¤åˆ¶node_modules
COPY --from=deps /app/node_modules ./node_modules

# ðŸ“ å¤åˆ¶æºä»£ç 
COPY . .

# ðŸ”§ è®¾ç½®æž„å»ºçŽ¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV VITE_BUILD_TARGET=production

# ðŸ—ï¸ æž„å»ºåº”ç”¨ï¼ˆä¼˜åŒ–æž„å»ºè¿‡ç¨‹ï¼‰
RUN npm run build && \
    npm run type-check && \
    find dist -name "*.map" -delete && \
    ls -la dist/

# ðŸ” éªŒè¯æž„å»ºäº§ç‰©
RUN test -f dist/index.html || (echo "âŒ Build failed: index.html not found" && exit 1) && \
    echo "âœ… Build successful: $(du -sh dist/)"

# ===== ðŸƒ ç”Ÿäº§è¿è¡Œé˜¶æ®µ =====
FROM nginx:${NGINX_VERSION} AS runtime

# ðŸ“ è¿è¡Œæ—¶å‚æ•°ï¼ˆé‡æ–°å£°æ˜Žï¼‰
ARG WEB_PORT=3000
ARG WEB_USER=appuser
ARG WEB_UID=1003
ARG WEB_GID=1003

# ðŸ“¦ å®‰è£…æœ€å°è¿è¡Œæ—¶ä¾èµ–
RUN apk add --no-cache \
    ca-certificates \
    tzdata \
    && rm -rf /var/cache/apk/* \
    && rm -rf /etc/nginx/conf.d/default.conf

# ðŸ‘¤ åˆ›å»ºéžç‰¹æƒç”¨æˆ·ï¼ˆå®‰å…¨æœ€ä½³å®žè·µï¼‰
RUN addgroup -g ${WEB_GID} -S webgroup && \
    adduser -u ${WEB_UID} -S ${WEB_USER} -G webgroup -D

# ðŸ“ åˆ›å»ºåº”ç”¨ç›®å½•ç»“æž„ï¼ˆæƒé™ä¼˜åŒ–ï¼‰
RUN mkdir -p /usr/share/nginx/html && \
    mkdir -p /var/cache/nginx && \
    mkdir -p /var/log/nginx && \
    mkdir -p /tmp/nginx && \
    chown -R ${WEB_USER}:webgroup /usr/share/nginx/html && \
    chown -R ${WEB_USER}:webgroup /var/cache/nginx && \
    chown -R ${WEB_USER}:webgroup /var/log/nginx && \
    chown -R ${WEB_USER}:webgroup /tmp/nginx && \
    chmod 755 /usr/share/nginx/html

# ðŸ“¦ ä»Žæž„å»ºé˜¶æ®µå¤åˆ¶é™æ€æ–‡ä»¶
COPY --from=builder --chown=${WEB_USER}:webgroup /app/dist /usr/share/nginx/html

# ðŸ”§ åˆ›å»ºä¼˜åŒ–çš„nginxé…ç½®
RUN cat > /etc/nginx/nginx.conf << 'EOF'
user nginx;
worker_processes auto;
pid /tmp/nginx/nginx.pid;

error_log /var/log/nginx/error.log warn;

events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # æ—¥å¿—æ ¼å¼ä¼˜åŒ–
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    # æ€§èƒ½ä¼˜åŒ–
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 16M;

    # GzipåŽ‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;

    # å®‰å…¨å¤´
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;

    server {
        listen WEB_PORT_PLACEHOLDER;
        server_name _;
        root /usr/share/nginx/html;
        index index.html;

        # é™æ€èµ„æºç¼“å­˜
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            try_files $uri =404;
        }

        # SPAè·¯ç”±æ”¯æŒ
        location / {
            try_files $uri $uri/ /index.html;
        }

        # å¥åº·æ£€æŸ¥
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # å®‰å…¨é…ç½®
        location ~ /\. {
            deny all;
        }
    }
}
EOF

# ðŸ”§ æ›¿æ¢ç«¯å£å ä½ç¬¦
RUN sed -i "s/WEB_PORT_PLACEHOLDER/${WEB_PORT}/g" /etc/nginx/nginx.conf

# ðŸŒ è®¾ç½®çŽ¯å¢ƒå˜é‡
ENV NGINX_PORT=${WEB_PORT}

# ðŸ”Œ æš´éœ²ç«¯å£
EXPOSE ${WEB_PORT}

# ðŸ“ æ•°æ®å·ï¼ˆæ—¥å¿—å’Œç¼“å­˜ï¼‰
VOLUME ["/var/log/nginx", "/tmp/nginx"]

# ðŸ‘¤ åˆ‡æ¢åˆ°éžç‰¹æƒç”¨æˆ·
USER ${WEB_USER}:webgroup

# ðŸ¥ å¥åº·æ£€æŸ¥ï¼ˆè½»é‡åŒ–ï¼‰
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:${WEB_PORT}/health || exit 1

# ðŸ·ï¸ é•œåƒæ ‡ç­¾ï¼ˆè¯¦ç»†å…ƒæ•°æ®ï¼‰
LABEL maintainer="v7-team" \
      app="v7-web" \
      version="v7-optimized" \
      architecture="solidjs+typescript+vite" \
      description="V7 Web Frontend - SolidJS + TypeScript + Vite with nginx" \
      node.version="${NODE_VERSION}" \
      nginx.version="${NGINX_VERSION}" \
      optimization="multi-stage+gzip+cache+security" \
      security="non-root+csp+xss-protection" \
      performance="extreme+static-cache" \
      port="${WEB_PORT}"

# ðŸš€ å¯åŠ¨å‘½ä»¤
CMD ["nginx", "-g", "daemon off;"] 