# ===== ğŸ—ï¸ æ„å»ºé˜¶æ®µ =====
FROM node:18-alpine AS builder

# ğŸ“¦ è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /build

# ğŸ”§ å¤åˆ¶packageæ–‡ä»¶å¹¶å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬å¼€å‘ä¾èµ–ï¼‰
COPY package*.json ./
RUN npm ci

# ğŸ“¦ å¤åˆ¶æºä»£ç 
COPY . .

# ğŸŒ è®¾ç½®æ„å»ºç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV VITE_API_BASE_URL=/api

# ğŸ—ï¸ æ„å»ºåº”ç”¨
RUN npm run build

# ===== ğŸƒ è¿è¡Œé˜¶æ®µ =====
FROM nginx:1.25-alpine AS runtime

# ğŸ“¦ å®‰è£…è¿è¡Œæ—¶ä¾èµ–
RUN apk add --no-cache \
    curl \
    tzdata \
    && rm -rf /var/cache/apk/*

# ğŸ‘¤ åˆ›å»ºåº”ç”¨ç”¨æˆ·ï¼ˆä½¿ç”¨ä¸éƒ¨ç½²ç¯å¢ƒä¸€è‡´çš„IDï¼‰
RUN addgroup -g 1002 -S appgroup && \
    adduser -u 1002 -S appuser -G appgroup

# ğŸ“ ä¸ºnginxåˆ›å»ºå¿…è¦çš„ç›®å½•å’Œæƒé™ - ä½¿ç”¨æ ‡å‡†è·¯å¾„
RUN mkdir -p /var/cache/nginx/client_temp \
             /var/cache/nginx/proxy_temp \
             /var/cache/nginx/fastcgi_temp \
             /var/cache/nginx/uwsgi_temp \
             /var/cache/nginx/scgi_temp \
             /var/log/nginx \
             /var/run \
             /usr/share/nginx/html && \
    # ä¿®æ”¹nginxé…ç½®ç›®å½•æƒé™
    chown -R appuser:appgroup /var/cache/nginx \
                              /var/log/nginx \
                              /var/run \
                              /usr/share/nginx/html \
                              /etc/nginx/conf.d && \
    # åˆ›å»ºnginx.pidæ–‡ä»¶å¹¶è®¾ç½®æƒé™
    touch /var/run/nginx.pid && \
    chown appuser:appgroup /var/run/nginx.pid && \
    chmod 644 /var/run/nginx.pid

# ğŸ“¦ å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder --chown=appuser:appgroup /build/dist /usr/share/nginx/html

# ğŸ”§ å¤åˆ¶nginxé…ç½®
COPY --chown=appuser:appgroup nginx.conf /etc/nginx/nginx.conf

# ğŸ‘¤ åˆ‡æ¢åˆ°éç‰¹æƒç”¨æˆ·
USER appuser

# ğŸš€ å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

# ğŸ“¡ æš´éœ²ç«¯å£ï¼ˆä½¿ç”¨8080é¿å…ç‰¹æƒç«¯å£ï¼‰
EXPOSE 8080

# ğŸƒ å¯åŠ¨å‘½ä»¤
CMD ["nginx", "-g", "daemon off;"] 