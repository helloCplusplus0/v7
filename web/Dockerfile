# ===== ğŸ—ï¸ æ„å»ºé˜¶æ®µ =====
FROM node:18-alpine AS builder

# ğŸ“¦ è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /build

# ğŸ”§ å¤åˆ¶packageæ–‡ä»¶å¹¶å®‰è£…ä¾èµ–
COPY package*.json ./
RUN npm ci --only=production

# ğŸ“¦ å¤åˆ¶æºä»£ç 
COPY . .

# ğŸŒ è®¾ç½®æ„å»ºç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV VITE_API_BASE_URL=/api

# ğŸ—ï¸ æ„å»ºåº”ç”¨
RUN npm run build

# ===== ğŸƒ è¿è¡Œé˜¶æ®µ =====
FROM nginx:1.25-alpine AS runtime

# ğŸ“¦ å®‰è£…è¿è¡Œæ—¶ä¾èµ–
RUN apk add --no-cache \
    curl \
    tzdata \
    && rm -rf /var/cache/apk/*

# ğŸ‘¤ åˆ›å»ºåº”ç”¨ç”¨æˆ·ï¼ˆä½¿ç”¨ä¸éƒ¨ç½²ç¯å¢ƒä¸€è‡´çš„IDï¼‰
RUN addgroup -g 1002 -S appgroup && \
    adduser -u 1002 -S appuser -G appgroup

# ğŸ“ åˆ›å»ºå¿…è¦ç›®å½•å¹¶è®¾ç½®æƒé™
RUN mkdir -p /var/cache/nginx/client_temp \
             /var/cache/nginx/proxy_temp \
             /var/cache/nginx/fastcgi_temp \
             /var/cache/nginx/uwsgi_temp \
             /var/cache/nginx/scgi_temp \
             /var/log/nginx \
             /var/run \
             /usr/share/nginx/html && \
    chown -R appuser:appgroup /var/cache/nginx \
                              /var/log/nginx \
                              /var/run \
                              /usr/share/nginx/html \
                              /etc/nginx && \
    chmod -R 755 /var/cache/nginx \
                 /var/log/nginx \
                 /var/run \
                 /usr/share/nginx/html \
                 /etc/nginx

# ğŸ”§ å¤åˆ¶é™æ€nginxé…ç½®
COPY --chown=appuser:appgroup nginx.conf /etc/nginx/nginx.conf

# ğŸ“¦ ä»æ„å»ºé˜¶æ®µå¤åˆ¶é™æ€æ–‡ä»¶
COPY --from=builder --chown=appuser:appgroup /build/dist/ /usr/share/nginx/html/

# ğŸŒ è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=production

# ğŸ”Œ æš´éœ²éç‰¹æƒç«¯å£
EXPOSE 8080

# ğŸ‘¤ åˆ‡æ¢åˆ°éç‰¹æƒç”¨æˆ·
USER appuser:appgroup

# ğŸ¥ å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

# ğŸ·ï¸ é•œåƒæ ‡ç­¾
LABEL maintainer="hellocplusplus0" \
      app="v7-web" \
      version="latest" \
      architecture="podman" \
      description="V7 Web - SolidJS + Web v7 Architecture (Simplified)" \
      node.version="18" \
      nginx.version="1.25" \
      nginx.port="8080"

# ğŸš€ å¯åŠ¨å‘½ä»¤
CMD ["nginx", "-g", "daemon off;"] 