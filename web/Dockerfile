# ğŸš€ V7 Web å‰ç«¯ä¼˜åŒ–é•œåƒ
# SolidJS + TypeScript + Vite åº”ç”¨å®¹å™¨åŒ–éƒ¨ç½²
# è½»é‡åŒ–ã€æè‡´æ€§èƒ½ã€å®‰å…¨å¼ºåŒ–çš„å¤šé˜¶æ®µæ„å»º

# ğŸ“ æ„å»ºå‚æ•°ï¼ˆå‚æ•°åŒ–ç®¡ç†ï¼‰
ARG NODE_VERSION=18
ARG NGINX_VERSION=1.25-alpine
ARG WEB_PORT=8080
ARG WEB_USER=appuser
ARG WEB_UID=1003
ARG WEB_GID=1003

# ===== ğŸ—ï¸ ä¾èµ–å®‰è£…é˜¶æ®µ =====
FROM node:${NODE_VERSION}-alpine AS deps

# ğŸ“¦ å®‰è£…æ„å»ºä¾èµ–
RUN apk add --no-cache \
    python3 \
    make \
    g++ \
    && rm -rf /var/cache/apk/*

WORKDIR /app

# ğŸ“¦ å¤åˆ¶ä¾èµ–é…ç½®æ–‡ä»¶ï¼ˆç¼“å­˜ä¼˜åŒ–ï¼‰
COPY package.json package-lock.json ./

# ğŸ”§ å®‰è£…å…¨éƒ¨ä¾èµ–ï¼ˆåŒ…æ‹¬å¼€å‘ä¾èµ–ï¼Œä¿®å¤æ„å»ºé”™è¯¯ï¼‰
RUN npm ci --verbose && \
    npm cache clean --force

# ===== ğŸ—ï¸ æ„å»ºé˜¶æ®µ =====
FROM node:${NODE_VERSION}-alpine AS builder

WORKDIR /app

# ğŸ“¦ ä»ä¾èµ–é˜¶æ®µå¤åˆ¶node_modules
COPY --from=deps /app/node_modules ./node_modules

# ğŸ“ å¤åˆ¶æºä»£ç 
COPY . .

# ğŸ”§ è®¾ç½®æ„å»ºç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV VITE_BUILD_TARGET=production

# ğŸ—ï¸ æ„å»ºåº”ç”¨ï¼ˆä¼˜åŒ–æ„å»ºè¿‡ç¨‹ï¼‰
RUN npm run build && \
    npm run type-check && \
    find dist -name "*.map" -delete && \
    ls -la dist/

# ğŸ” éªŒè¯æ„å»ºäº§ç‰©
RUN test -f dist/index.html || (echo "âŒ Build failed: index.html not found" && exit 1) && \
    echo "âœ… Build successful: $(du -sh dist/)"

# ===== ğŸƒ ç”Ÿäº§è¿è¡Œé˜¶æ®µ =====
FROM nginx:${NGINX_VERSION} AS runtime

# ğŸ“ è¿è¡Œæ—¶å‚æ•°ï¼ˆé‡æ–°å£°æ˜ï¼Œä¿æŒä¸€è‡´ï¼‰
ARG WEB_PORT=8080
ARG WEB_USER=appuser
ARG WEB_UID=1003
ARG WEB_GID=1003

# ğŸ“¦ å®‰è£…æœ€å°è¿è¡Œæ—¶ä¾èµ–
RUN apk add --no-cache \
    ca-certificates \
    tzdata \
    && rm -rf /var/cache/apk/* \
    && rm -rf /etc/nginx/conf.d/default.conf

# ğŸ‘¤ åˆ›å»ºéç‰¹æƒç”¨æˆ·ï¼ˆå®‰å…¨æœ€ä½³å®è·µï¼‰
RUN addgroup -g ${WEB_GID} -S webgroup && \
    adduser -u ${WEB_UID} -S ${WEB_USER} -G webgroup -D

# ğŸ“ ä¸€æ¬¡æ€§åˆ›å»ºæ‰€æœ‰å¿…è¦ç›®å½•å¹¶è®¾ç½®æƒé™ï¼ˆä¼˜åŒ–é•œåƒå±‚ï¼‰
RUN mkdir -p /usr/share/nginx/html \
             /var/cache/nginx/client_temp \
             /var/cache/nginx/proxy_temp \
             /var/cache/nginx/fastcgi_temp \
             /var/cache/nginx/uwsgi_temp \
             /var/cache/nginx/scgi_temp \
             /var/log/nginx \
             /var/run \
    && chown -R ${WEB_USER}:webgroup \
              /usr/share/nginx/html \
              /var/cache/nginx \
              /var/log/nginx \
              /var/run \
    && chmod 755 /usr/share/nginx/html \
                 /var/cache/nginx \
                 /var/log/nginx \
                 /var/run

# ğŸ“¦ ä»æ„å»ºé˜¶æ®µå¤åˆ¶é™æ€æ–‡ä»¶
COPY --from=builder --chown=${WEB_USER}:webgroup /app/dist /usr/share/nginx/html

# ğŸ“¦ å¤åˆ¶nginxé…ç½®æ–‡ä»¶
COPY --chown=${WEB_USER}:webgroup nginx.conf /etc/nginx/nginx.conf

# ğŸŒ è®¾ç½®è¿è¡Œæ—¶ç¯å¢ƒå˜é‡
ENV NODE_ENV=production \
    PORT=${WEB_PORT} \
    NGINX_USER=${WEB_USER}

# ğŸ”Œ æš´éœ²ç«¯å£
EXPOSE ${WEB_PORT}

# ğŸ“ æ•°æ®å·ï¼ˆæ—¥å¿—å’Œç¼“å­˜ï¼‰
VOLUME ["/var/log/nginx", "/var/cache/nginx"]

# ğŸ‘¤ åˆ‡æ¢åˆ°éç‰¹æƒç”¨æˆ·
USER ${WEB_USER}:webgroup

# ğŸ¥ å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:${WEB_PORT}/health || exit 1

# ğŸ·ï¸ é•œåƒæ ‡ç­¾
LABEL maintainer="v7-team" \
      app="v7-web" \
      version="v7-solidjs" \
      description="V7 Web Frontend - SolidJS + TypeScript + Vite + nginx" \
      architecture="solidjs+typescript+vite" \
      optimization="vite-build+nginx-static+multi-stage" \
      security="non-root+minimal-deps" \
      performance="static-assets+gzip+caching" \
      ports.http="${WEB_PORT}"

# ğŸš€ å¯åŠ¨å‘½ä»¤
CMD ["nginx", "-g", "daemon off;"] 