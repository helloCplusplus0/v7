# ===== ğŸ—ï¸ æ„å»ºé˜¶æ®µ =====
FROM node:18-alpine AS builder

# ğŸ“¦ è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /build

# ğŸ”§ å¤åˆ¶packageæ–‡ä»¶å¹¶å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬å¼€å‘ä¾èµ–ï¼‰
COPY package*.json ./
RUN npm ci

# ğŸ“¦ å¤åˆ¶æºä»£ç 
COPY . .

# ğŸŒ è®¾ç½®æ„å»ºç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV VITE_API_BASE_URL=/api

# ğŸ—ï¸ æ„å»ºåº”ç”¨
RUN npm run build

# ===== ğŸƒ è¿è¡Œé˜¶æ®µ =====
FROM nginx:1.25-alpine AS runtime

# ğŸ“¦ å®‰è£…è¿è¡Œæ—¶ä¾èµ–
RUN apk add --no-cache \
    curl \
    tzdata \
    && rm -rf /var/cache/apk/*

# ğŸ‘¤ åˆ›å»ºåº”ç”¨ç”¨æˆ·ï¼ˆä½¿ç”¨ä¸éƒ¨ç½²ç¯å¢ƒä¸€è‡´çš„IDï¼‰
RUN addgroup -g 1002 -S appgroup && \
    adduser -u 1002 -S appuser -G appgroup

# ğŸ“ åˆ›å»ºåº”ç”¨ç›®å½•å¹¶è®¾ç½®æƒé™
RUN mkdir -p /app/dist && \
    chown -R appuser:appgroup /app

# ğŸ“¦ å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder --chown=appuser:appgroup /build/dist /app/dist

# ğŸ”§ åˆ›å»ºéç‰¹æƒnginxé…ç½®
RUN mkdir -p /tmp/nginx /var/log/nginx /var/cache/nginx && \
    chown -R appuser:appgroup /tmp/nginx /var/log/nginx /var/cache/nginx && \
    chmod -R 755 /tmp/nginx /var/log/nginx /var/cache/nginx

# ğŸ“ å¤åˆ¶nginxé…ç½®æ–‡ä»¶
COPY --chown=appuser:appgroup nginx.conf /etc/nginx/nginx.conf

# ğŸŒ è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV NGINX_USER=appuser
ENV NGINX_GROUP=appgroup

# ğŸ‘¤ åˆ‡æ¢åˆ°éç‰¹æƒç”¨æˆ·
USER appuser

# ğŸš€ å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

# ğŸ“¡ æš´éœ²ç«¯å£
EXPOSE 8080

# ğŸƒ å¯åŠ¨å‘½ä»¤
CMD ["nginx", "-g", "daemon off;"] 