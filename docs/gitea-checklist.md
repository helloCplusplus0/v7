# ✅ FMOD v7 智能端口管理配置检查清单

## 🎯 智能端口管理解决方案

现在使用**智能端口检测**技术，**完全避免端口冲突**！系统会自动检测端口占用情况，如果首选端口被占用，自动分配下一个可用端口。

## 🚀 一键启动步骤

### 1. 📦 仓库初始化
```bash
# 第一次使用时运行
./scripts/gitea-init.sh
```

### 2. 📋 Gitea 基本配置

**在 Gitea 仓库 → Settings → Actions 中：**

- [ ] 启用 `Repository Actions`
- [ ] 设置 Actions 权限为 `Allow all actions`
- [ ] 确保 Gitea Runner 正常运行

**仅此而已！** 🎉

### 3. 🎯 开发工作流

```bash
# 开发时
npm run dev                    # 本地开发服务器

# 提交代码
git add .
git commit -m "feat: 新功能"
git push                       # 自动触发智能端口部署

# 本地测试
./scripts/deploy.sh deploy     # 智能端口分配部署
```

## 🧠 智能端口管理特性

### ✅ 自动端口分配策略：

| 环境 | 前端首选端口 | 后端首选端口 | 冲突处理 |
|------|-------------|-------------|----------|
| **测试环境** (develop) | 5173 | 3001 | 自动递增查找可用端口 |
| **生产环境** (main) | 8080 | 3000 | 自动递增查找可用端口 |

### 🔧 端口冲突智能解决：

1. **检测端口占用**：自动扫描目标端口是否被占用
2. **智能分配**：如果被占用，自动在范围内寻找下一个可用端口
3. **状态报告**：清晰显示分配结果和变更情况
4. **配置保存**：端口信息保存在 `.port-config` 文件中

### 📊 示例端口分配场景：

```bash
# 场景1：端口可用 ✅
首选端口 8080 → 分配端口 8080 ✅

# 场景2：端口被占用 ⚠️
首选端口 8080 (被占用) → 分配端口 8081 ⚠️
首选端口 8081 (被占用) → 分配端口 8082 ⚠️
...继续扫描直到找到可用端口

# 场景3：查看当前配置 📊
./scripts/deploy.sh ports
```

## 🎛️ 可选的高级端口配置

### 如果您想自定义首选端口（完全可选）

**在 Gitea → Settings → Actions → Variables 中添加：**

| Variable | 默认值 | 用途 | 说明 |
|----------|--------|------|------|
| `FRONTEND_PORT_STAGING` | `5173` | 测试环境前端首选端口 | 如被占用会自动递增 |
| `FRONTEND_PORT_PRODUCTION` | `8080` | 生产环境前端首选端口 | 避免使用80需要sudo |
| `BACKEND_PORT_STAGING` | `3001` | 测试环境后端首选端口 | 如被占用会自动递增 |
| `BACKEND_PORT_PRODUCTION` | `3000` | 生产环境后端首选端口 | 如被占用会自动递增 |

**注意**：这些都是**完全可选的**！不配置的话使用默认值，端口冲突会自动处理！

### 🚫 为什么不再使用端口80？

- **权限问题**：端口80需要sudo权限
- **常被占用**：系统Web服务器通常占用80端口
- **更安全**：8080端口更安全，无权限要求
- **自动化友好**：无需特殊权限配置

## 📊 自动部署效果

### 测试分支 (develop)
```bash
git push origin develop
```
**自动触发**：
1. 代码质量检查 ✅
2. 单元测试 ✅
3. 构建镜像 ✅
4. 智能端口分配 (首选 5173/3001) ✅
5. 部署到测试环境 ✅
6. 健康检查 ✅

### 生产分支 (main)
```bash
git push origin main
```
**自动触发**：
1. 代码质量检查 ✅
2. 完整测试套件 ✅
3. 构建生产镜像 ✅
4. 数据备份 ✅
5. 智能端口分配 (首选 8080/3000) ✅
6. 部署到生产环境 ✅
7. 健康检查和验证 ✅

## 📊 智能端口分配的服务地址

| 服务 | 测试环境 | 生产环境 | 状态 |
|------|----------|----------|------|
| 前端 | http://localhost:5173+ | http://localhost:8080+ | 🟢 智能分配 |
| 后端 | http://localhost:3001+ | http://localhost:3000+ | 🟢 智能分配 |
| 数据库 | SQLite (fmod-data-staging) | SQLite (fmod-data-production) | 🟢 自动隔离 |

**注**：`+` 表示如果首选端口被占用，会自动递增到下一个可用端口

## 🔍 实时端口信息查看

### ✅ 部署成功的标志：

1. **代码推送后**，Gitea Actions 显示绿色 ✅
2. **访问前端**：根据部署报告中的实际分配端口
3. **API 可用**：http://localhost:{实际后端端口}/health
4. **容器运行**：`podman ps | grep fmod` 显示运行中的容器

### 🔍 快速检查命令：

```bash
# 查看当前端口配置（推荐）
./scripts/deploy.sh ports

# 查看完整服务状态
./scripts/deploy.sh status

# 查看日志
./scripts/deploy.sh logs

# 手动重启（如果需要）
./scripts/deploy.sh restart

# 查看所有可用命令
./scripts/deploy.sh help
```

### 📋 智能端口分配报告示例：

```bash
🎯 部署完成报告：
┌─────────────────────────────────────────┐
│              FMOD v7 部署状态           │
├─────────────────────────────────────────┤
│ 环境: production                        │
│ 前端: ✅ http://localhost:8081          │
│ 后端: ✅ http://localhost:3000          │
│ API:  http://localhost:3000/health      │
└─────────────────────────────────────────┘

📊 当前端口配置：
FRONTEND_PORT=8081
BACKEND_PORT=3000
ENVIRONMENT=production
TIMESTAMP=2024-01-15 14:30:25
```

## 🆘 故障排除

### 问题：CI 失败
**解决方案**：
```bash
# 检查 Gitea Runner 状态
sudo systemctl status gitea-runner

# 查看 CI 日志
# 在 Gitea Actions 页面查看详细错误信息
```

### 问题：端口仍然冲突
**解决方案**：
```bash
# 手动停止冲突的服务
sudo netstat -tulpn | grep :8080
sudo kill -9 <PID>

# 或重新部署让系统自动分配新端口
./scripts/deploy.sh restart
```

### 问题：找不到服务地址
**解决方案**：
```bash
# 查看实际分配的端口
./scripts/deploy.sh ports

# 或查看完整状态
./scripts/deploy.sh status
```

### 问题：健康检查失败
**解决方案**：
```bash
# 查看容器日志
./scripts/deploy.sh logs

# 手动检查服务状态
curl http://localhost:$(cat .port-config | grep BACKEND_PORT | cut -d'=' -f2)/health
```

## 🎯 智能端口管理的优势

### ✅ 自动化优势：

- ❌ **无需手动管理端口冲突**
- ❌ **无需停止其他服务**
- ❌ **无需复杂的端口规划**
- ❌ **无需sudo权限**

### ✅ 实际效果：

- ✅ **零配置冲突处理**
- ✅ **自动端口发现**
- ✅ **状态透明可见**
- ✅ **持久化配置保存**
- ✅ **友好的错误提示**

---

## 🎯 总结

**现在您完全不用担心端口冲突了！** 🎉

1. **推送代码** → 自动智能端口分配
2. **冲突检测** → 自动寻找可用端口  
3. **透明报告** → 清晰显示分配结果
4. **持久化保存** → 配置信息永久保存

**真正的零配置，零冲突！** 专注于业务开发，让系统处理基础设施问题。

### 🚀 开始使用：

1. 运行 `./scripts/gitea-init.sh`
2. 在 Gitea 中启用 Actions
3. 开始开发和推送代码
4. 享受自动化部署的便利！

**就是这么简单！** 🎯

---

*如果您觉得还是太复杂，可能是我们做得还不够简化。请告诉我们哪里还能再简化！* 