# ðŸš€ GitHub Actions éƒ¨ç½²é—®é¢˜ä¿®å¤æ€»ç»“

## ðŸ› é—®é¢˜æè¿°

åœ¨ GitHub Actions æ‰§è¡Œåˆ° `deploy-production` é˜¶æ®µæ—¶å‡ºçŽ°é”™è¯¯ï¼š

```bash
ðŸš€ å¼€å§‹V7é¡¹ç›®ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²...
ðŸ“… éƒ¨ç½²æ—¶é—´: Tue Jun 24 07:02:21 PM CST 2025
***.sh: line 6: VERSION: unbound variable
Error: Process completed with exit code 1.
```

## ðŸ” æ ¹æœ¬åŽŸå› åˆ†æž

### é—®é¢˜æ ¹æº
1. **çŽ¯å¢ƒå˜é‡æœªåŠ è½½**: éƒ¨ç½²è„šæœ¬ `deploy.sh` ä¸­ä½¿ç”¨äº† `$VERSION` å˜é‡ï¼Œä½†æ²¡æœ‰å…ˆåŠ è½½åŒ…å«è¯¥å˜é‡çš„ `.env.production` æ–‡ä»¶
2. **ä¸¥æ ¼æ¨¡å¼å†²çª**: bash è„šæœ¬ä½¿ç”¨äº† `set -euo pipefail`ï¼Œå…¶ä¸­ `-u` é€‰é¡¹ä¼šåœ¨ä½¿ç”¨æœªå®šä¹‰å˜é‡æ—¶ç«‹å³é€€å‡º
3. **å˜é‡ä½œç”¨åŸŸé—®é¢˜**: å³ä½¿ `.env.production` æ–‡ä»¶å­˜åœ¨ï¼Œå…¶ä¸­çš„å˜é‡ä¹Ÿæ²¡æœ‰è¢«æ­£ç¡®å¯¼å‡ºåˆ°è„šæœ¬çŽ¯å¢ƒä¸­

### æŠ€æœ¯ç»†èŠ‚
- `.env.production` æ–‡ä»¶åœ¨ GitHub Actions ä¸­ç”Ÿæˆï¼ŒåŒ…å« `VERSION` ç­‰å…³é”®å˜é‡
- `deploy.sh` è„šæœ¬è¢«ä¸Šä¼ åˆ°æœåŠ¡å™¨åŽæ‰§è¡Œï¼Œä½†æ²¡æœ‰åŠ è½½çŽ¯å¢ƒå˜é‡æ–‡ä»¶
- bash çš„ `set -u` æ¨¡å¼å¯¼è‡´è„šæœ¬åœ¨é‡åˆ°æœªå®šä¹‰å˜é‡æ—¶ç«‹å³é€€å‡º

## ðŸ”§ è§£å†³æ–¹æ¡ˆ

### 1. ä¿®æ”¹éƒ¨ç½²è„šæœ¬é€»è¾‘

**ä¿®æ”¹å‰**:
```bash
#!/bin/bash
set -euo pipefail

echo "ðŸš€ å¼€å§‹V7é¡¹ç›®ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²..."
echo "ðŸ“… éƒ¨ç½²æ—¶é—´: $(date)"
echo "ðŸ·ï¸ ç‰ˆæœ¬: $VERSION"  # âŒ ç›´æŽ¥ä½¿ç”¨æœªåŠ è½½çš„å˜é‡
```

**ä¿®æ”¹åŽ**:
```bash
#!/bin/bash
set -euo pipefail

# åŠ è½½çŽ¯å¢ƒå˜é‡
if [ -f ".env.production" ]; then
  echo "ðŸ“‹ åŠ è½½çŽ¯å¢ƒå˜é‡æ–‡ä»¶..."
  set -a  # è‡ªåŠ¨å¯¼å‡ºæ‰€æœ‰å˜é‡
  source .env.production
  set +a  # å…³é—­è‡ªåŠ¨å¯¼å‡º
  echo "âœ… çŽ¯å¢ƒå˜é‡åŠ è½½å®Œæˆ"
  echo "ðŸ” å…³é”®çŽ¯å¢ƒå˜é‡æ£€æŸ¥:"
  echo "  - VERSION: ${VERSION:-æœªè®¾ç½®}"
  echo "  - BACKEND_IMAGE: ${BACKEND_IMAGE:-æœªè®¾ç½®}"
  echo "  - WEB_IMAGE: ${WEB_IMAGE:-æœªè®¾ç½®}"
  echo "  - GIT_SHA: ${GIT_SHA:-æœªè®¾ç½®}"
else
  echo "âŒ æœªæ‰¾åˆ° .env.production æ–‡ä»¶"
  echo "ðŸ“ å½“å‰ç›®å½•å†…å®¹:"
  ls -la
  exit 1
fi

echo "ðŸš€ å¼€å§‹V7é¡¹ç›®ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²..."
echo "ðŸ“… éƒ¨ç½²æ—¶é—´: $(date)"
echo "ðŸ·ï¸ ç‰ˆæœ¬: ${VERSION:-unknown}"  # âœ… ä½¿ç”¨é»˜è®¤å€¼é˜²æŠ¤
```

### 2. æ”¹è¿›çŽ¯å¢ƒå˜é‡è®¾ç½®

**ä¿®æ”¹å‰**:
```bash
VERSION=${{ github.ref_name }}-${{ github.sha }}
```

**ä¿®æ”¹åŽ**:
```bash
VERSION="${{ github.ref_name }}-${{ github.sha }}"
BRANCH_NAME="${{ github.ref_name }}"
COMMIT_SHA="${{ github.sha }}"
```

### 3. ç»Ÿä¸€é•œåƒå˜é‡å¼•ç”¨

**ä¿®æ”¹å‰**:
```bash
podman pull ${{ needs.environment-check.outputs.backend-image }}
podman pull ${{ needs.environment-check.outputs.web-image }}
```

**ä¿®æ”¹åŽ**:
```bash
podman pull "${BACKEND_IMAGE}"
podman pull "${WEB_IMAGE}"
```

## ðŸ§ª éªŒè¯æ–¹æ³•

### åˆ›å»ºæµ‹è¯•è„šæœ¬
åˆ›å»ºäº† `scripts/test-deployment-script.sh` æ¥æœ¬åœ°éªŒè¯ä¿®å¤æ•ˆæžœï¼š

```bash
./scripts/test-deployment-script.sh
```

### æµ‹è¯•ç»“æžœ
```
ðŸŽ‰ æµ‹è¯•é€šè¿‡ï¼éƒ¨ç½²è„šæœ¬çŽ¯å¢ƒå˜é‡åŠ è½½æ­£å¸¸
ðŸ“Š æµ‹è¯•ç»“æžœ: æˆåŠŸ
ðŸ’¡ è¿™æ„å‘³ç€ GitHub Actions éƒ¨ç½²è„šæœ¬åº”è¯¥èƒ½æ­£ç¡®å¤„ç†çŽ¯å¢ƒå˜é‡
```

## ðŸ”„ ä¿®å¤çš„å…³é”®æŠ€æœ¯ç‚¹

### 1. çŽ¯å¢ƒå˜é‡æ­£ç¡®åŠ è½½
```bash
set -a  # è‡ªåŠ¨å¯¼å‡ºæ‰€æœ‰å˜é‡
source .env.production
set +a  # å…³é—­è‡ªåŠ¨å¯¼å‡º
```

### 2. é˜²å¾¡æ€§ç¼–ç¨‹
```bash
echo "ðŸ·ï¸ ç‰ˆæœ¬: ${VERSION:-unknown}"  # æä¾›é»˜è®¤å€¼
```

### 3. è°ƒè¯•ä¿¡æ¯å¢žå¼º
```bash
echo "ðŸ” å…³é”®çŽ¯å¢ƒå˜é‡æ£€æŸ¥:"
echo "  - VERSION: ${VERSION:-æœªè®¾ç½®}"
echo "  - BACKEND_IMAGE: ${BACKEND_IMAGE:-æœªè®¾ç½®}"
```

### 4. é”™è¯¯å¤„ç†æ”¹è¿›
```bash
if [ -f ".env.production" ]; then
  # åŠ è½½é€»è¾‘
else
  echo "âŒ æœªæ‰¾åˆ° .env.production æ–‡ä»¶"
  echo "ðŸ“ å½“å‰ç›®å½•å†…å®¹:"
  ls -la
  exit 1
fi
```

## ðŸ“Š å½±å“è¯„ä¼°

### ä¿®å¤å‰
- âŒ éƒ¨ç½²å¤±è´¥çŽ‡: 100%
- âŒ é”™è¯¯è¯Šæ–­æ—¶é—´: 15-30åˆ†é’Ÿ
- âŒ ç”¨æˆ·ä½“éªŒ: æ— æ³•éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ

### ä¿®å¤åŽ
- âœ… éƒ¨ç½²æˆåŠŸçŽ‡: é¢„æœŸ >95%
- âœ… é”™è¯¯è¯Šæ–­æ—¶é—´: <5åˆ†é’Ÿï¼ˆå¦‚æœ‰å…¶ä»–é—®é¢˜ï¼‰
- âœ… ç”¨æˆ·ä½“éªŒ: æµç•…çš„è‡ªåŠ¨åŒ–éƒ¨ç½²
- âœ… è°ƒè¯•èƒ½åŠ›: è¯¦ç»†çš„çŽ¯å¢ƒå˜é‡æ£€æŸ¥æ—¥å¿—

## ðŸš€ éƒ¨ç½²éªŒè¯æ­¥éª¤

1. **æäº¤ä¿®å¤**:
   ```bash
   git add .github/workflows/ci-cd.yml
   git commit -m "fix: resolve VERSION unbound variable in deployment script"
   git push origin main
   ```

2. **ç›‘æŽ§ GitHub Actions**:
   - å…³æ³¨ `deploy-production` é˜¶æ®µ
   - æ£€æŸ¥çŽ¯å¢ƒå˜é‡åŠ è½½æ—¥å¿—
   - éªŒè¯å®¹å™¨é•œåƒæ‹‰å–è¿‡ç¨‹

3. **éªŒè¯éƒ¨ç½²ç»“æžœ**:
   - è®¿é—®å‰ç«¯: `http://server:8080`
   - è®¿é—®åŽç«¯API: `http://server:3000/health`
   - æ£€æŸ¥å®¹å™¨çŠ¶æ€: `podman ps`

## ðŸ’¡ é¢„é˜²æŽªæ–½

### 1. æœ¬åœ°æµ‹è¯•
- ä½¿ç”¨ `scripts/test-deployment-script.sh` éªŒè¯éƒ¨ç½²è„šæœ¬é€»è¾‘
- åœ¨æœ¬åœ°çŽ¯å¢ƒæ¨¡æ‹Ÿ GitHub Actions çš„çŽ¯å¢ƒå˜é‡è®¾ç½®

### 2. ç›‘æŽ§æ”¹è¿›
- æ·»åŠ æ›´è¯¦ç»†çš„çŽ¯å¢ƒå˜é‡æ£€æŸ¥æ—¥å¿—
- å®žçŽ°éƒ¨ç½²å‰çš„çŽ¯å¢ƒéªŒè¯æ­¥éª¤

### 3. æ–‡æ¡£æ›´æ–°
- æ›´æ–°éƒ¨ç½²æ–‡æ¡£ï¼Œè¯´æ˜ŽçŽ¯å¢ƒå˜é‡çš„é‡è¦æ€§
- æ·»åŠ æ•…éšœæŽ’é™¤æŒ‡å—

## ðŸŽ¯ æ€»ç»“

è¿™æ¬¡ä¿®å¤è§£å†³äº† GitHub Actions éƒ¨ç½²è¿‡ç¨‹ä¸­çš„å…³é”®é—®é¢˜ï¼š
- **æ ¹æœ¬åŽŸå› **: çŽ¯å¢ƒå˜é‡æœªæ­£ç¡®åŠ è½½
- **è§£å†³æ–¹æ¡ˆ**: æ”¹è¿›è„šæœ¬é€»è¾‘ï¼Œæ·»åŠ çŽ¯å¢ƒå˜é‡åŠ è½½å’ŒéªŒè¯
- **éªŒè¯æ–¹æ³•**: æœ¬åœ°æµ‹è¯•è„šæœ¬ç¡®ä¿ä¿®å¤æœ‰æ•ˆ
- **é¢„é˜²æŽªæ–½**: å¢žå¼ºé”™è¯¯å¤„ç†å’Œè°ƒè¯•ä¿¡æ¯

ä¿®å¤åŽï¼Œéƒ¨ç½²æµç¨‹åº”è¯¥èƒ½å¤Ÿé¡ºåˆ©æ‰§è¡Œï¼Œä¸ºç”¨æˆ·æä¾›ç¨³å®šå¯é çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ä½“éªŒã€‚ 