# ğŸš€ Analytics Engine éƒ¨ç½²æŒ‡å—

> **å®Œæ•´çš„ç”Ÿäº§éƒ¨ç½²å’Œè¿ç»´ç®¡ç†æŒ‡å—**  
> é¡¹ç›®ä»‹ç»å’Œå¼€å‘æŒ‡å—è¯·å‚è€ƒï¼š[README.md](../README.md)

## ğŸ“‹ éƒ¨ç½²ç­–ç•¥

Analytics Engineé‡‡ç”¨**systemdæœåŠ¡éƒ¨ç½²**ï¼Œæ”¾å¼ƒå®¹å™¨åŒ–æ–¹æ¡ˆã€‚

### ğŸ¯ ä¸ºä»€ä¹ˆé€‰æ‹©systemdè€Œéå®¹å™¨ï¼Ÿ

ç»è¿‡æ·±å…¥åˆ†æï¼Œæˆ‘ä»¬å†³å®šé‡‡ç”¨systemdæœåŠ¡éƒ¨ç½²ï¼š

âœ… **æè‡´æ€§èƒ½**ï¼šæ— å®¹å™¨è™šæ‹ŸåŒ–å¼€é”€ï¼Œé™æ€äºŒè¿›åˆ¶ç›´æ¥è¿è¡Œ  
âœ… **ç®€å•è¿ç»´**ï¼šæ ‡å‡†LinuxæœåŠ¡ç®¡ç†ï¼Œæ— éœ€å­¦ä¹ å®¹å™¨ç¼–æ’  
âœ… **èµ„æºæ•ˆç‡**ï¼šå†…å­˜å ç”¨ä»…3-5MBï¼Œå®¹å™¨è‡³å°‘å¢åŠ 200MB  
âœ… **ç¨³å®šå¯é **ï¼šsystemdä¹…ç»è€ƒéªŒï¼Œè‡ªåŠ¨é‡å¯ã€ä¾èµ–ç®¡ç†  
âœ… **é«˜æ•ˆå·¥ä½œæµ**ï¼šä¿æŒ`./scripts/build.sh + ./scripts/run.sh`çš„ç®€æ´æµç¨‹

### âŒ å®¹å™¨åŒ–çš„é—®é¢˜

- **èµ„æºæµªè´¹**ï¼š200-300MBé•œåƒ vs 10MBé™æ€äºŒè¿›åˆ¶
- **å¤æ‚åº¦å¢åŠ **ï¼šç ´åäº†ç®€å•é«˜æ•ˆçš„å¼€å‘å·¥ä½œæµ
- **æ€§èƒ½æŸå¤±**ï¼šè™šæ‹ŸåŒ–å±‚å¼€é”€å¯¹è®¡ç®—å¯†é›†å‹æœåŠ¡ä¸å‹å¥½
- **è¿ç»´å¤æ‚**ï¼šå®¹å™¨ç¼–æ’ã€é•œåƒç®¡ç†å¢åŠ è¿ç»´è´Ÿæ‹…

---

## ğŸ¯ ä¸‰ç§éƒ¨ç½²åœºæ™¯

| åœºæ™¯ | é€‚ç”¨æƒ…å†µ | å¤æ‚åº¦ | å‘½ä»¤ |
|------|----------|--------|------|
| **å¼€å‘æ¨¡å¼** | æœ¬åœ°å¼€å‘æµ‹è¯• | â­ | `./scripts/run.sh` |
| **å•æœåŠ¡å™¨** | Web+Backend+AnalyticsåŒæœºéƒ¨ç½² | â­â­ | `./scripts/deploy.sh` |
| **è·¨æœåŠ¡å™¨** | Analyticsç‹¬ç«‹éƒ¨ç½²åˆ°è®¡ç®—æœåŠ¡å™¨ | â­â­â­ | `./scripts/deploy.sh --remote` |

## ğŸ¯ åœºæ™¯ä¸€ï¼šå¼€å‘æ¨¡å¼ï¼ˆæ¨èæ–°æ‰‹ï¼‰

```bash
cd analytics-engine

# ä¸€é”®æ„å»ºå’Œè¿è¡Œ
./scripts/build.sh && ./scripts/run.sh

# éªŒè¯æœåŠ¡
curl http://localhost:50051/health
```

**ç‰¹ç‚¹**ï¼š
- âœ… æœ€ç®€å•ï¼Œæ— éœ€rootæƒé™
- âœ… é€‚åˆå¼€å‘è°ƒè¯•
- âŒ é‡å¯åæœåŠ¡ä¸ä¼šè‡ªåŠ¨å¯åŠ¨

## ğŸ¯ åœºæ™¯äºŒï¼šå•æœåŠ¡å™¨éƒ¨ç½²ï¼ˆæ¨èç”Ÿäº§ï¼‰

```bash
# Step 1: åˆ›å»ºä¸“ç”¨ç”¨æˆ·
sudo ./scripts/setup-user.sh

# Step 2: æ„å»ºå’Œéƒ¨ç½²
./scripts/build.sh
sudo -u analytics ./scripts/deploy.sh

# Step 3: ç®¡ç†æœåŠ¡
./scripts/manage-service.sh
```

**éƒ¨ç½²æ¶æ„**ï¼š
```
å•å°äº‘æœåŠ¡å™¨
â”œâ”€â”€ Web (nginx) - Port 80
â”œâ”€â”€ Backend (rust) - Port 50053  
â””â”€â”€ Analytics (systemd) - Port 50051
    â”œâ”€â”€ ç”¨æˆ·: analytics
    â”œâ”€â”€ è·¯å¾„: /opt/v7/analytics-engine
    â””â”€â”€ é€šä¿¡: localhost:50051
```

**ç‰¹ç‚¹**ï¼š
- âœ… ç”Ÿäº§çº§éƒ¨ç½²ï¼Œsystemdç®¡ç†
- âœ… å¼€æœºè‡ªå¯ï¼Œè‡ªåŠ¨é‡å¯
- âœ… ä¸“ç”¨ç”¨æˆ·ï¼Œå®‰å…¨éš”ç¦»
- âœ… é€‚åˆWeb+Backend+AnalyticsåŒæœºéƒ¨ç½²

## ğŸ¯ åœºæ™¯ä¸‰ï¼šè·¨æœåŠ¡å™¨éƒ¨ç½²ï¼ˆä¼ä¸šçº§ï¼‰

### ä¸‰ç§éƒ¨ç½²æ¨¡å¼è¯¦è§£

#### **æ¨¡å¼ä¸€ï¼šæœ¬åœ°éƒ¨ç½²ï¼ˆä»…localhostè®¿é—®ï¼‰**
```bash
sudo -u analytics ./scripts/deploy.sh
```

**é…ç½®**ï¼š
- ç›‘å¬åœ°å€ï¼š`127.0.0.1:50051`ï¼ˆä»…æœ¬åœ°å›ç¯ï¼‰
- é˜²ç«å¢™ï¼šä¸å¼€æ”¾å¤–éƒ¨ç«¯å£
- é€‚ç”¨ï¼šWeb+Backend+AnalyticsåŒæœºéƒ¨ç½²

#### **æ¨¡å¼äºŒï¼šæœ¬åœ°éƒ¨ç½²+è¿œç¨‹è®¿é—®**
```bash
sudo -u analytics ./scripts/deploy.sh --enable-remote
```

**é…ç½®**ï¼š
- ç›‘å¬åœ°å€ï¼š`0.0.0.0:50051`ï¼ˆç›‘å¬æ‰€æœ‰ç½‘ç»œæ¥å£ï¼‰
- é˜²ç«å¢™ï¼šè‡ªåŠ¨å¼€æ”¾50051ç«¯å£
- é€‚ç”¨ï¼šéœ€è¦è·¨æœåŠ¡å™¨é€šä¿¡ä½†Analyticsåœ¨æœ¬åœ°

#### **æ¨¡å¼ä¸‰ï¼šè¿œç¨‹æœåŠ¡å™¨éƒ¨ç½²**
```bash
./scripts/deploy.sh --remote-host 192.168.1.100
```

**é…ç½®**ï¼š
- éƒ¨ç½²ä½ç½®ï¼šè¿œç¨‹æœåŠ¡å™¨ï¼ˆ192.168.1.100ï¼‰
- é€šè¿‡SSHä¸Šä¼ æ„å»ºæ–‡ä»¶å¹¶åœ¨è¿œç¨‹æœåŠ¡å™¨éƒ¨ç½²
- é€‚ç”¨ï¼šAnalyticsç‹¬ç«‹éƒ¨ç½²åˆ°è®¡ç®—æœåŠ¡å™¨

### SSHé…ç½®è¦æ±‚ï¼ˆæ¨¡å¼ä¸‰ï¼‰

```bash
# 1. é…ç½®SSHå¯†é’¥è®¿é—®
ssh-copy-id root@192.168.1.100

# 2. æµ‹è¯•SSHè¿æ¥
ssh root@192.168.1.100 "echo 'Connection successful'"
```

### éƒ¨ç½²æ¶æ„å¯¹æ¯”

**åŒæœºéƒ¨ç½²ï¼ˆæ¨¡å¼ä¸€ï¼‰**ï¼š
```
äº‘æœåŠ¡å™¨A
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Web + Backend + Analyticsâ”‚
â”‚ é€šä¿¡: localhost:50051    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è·¨æœåŠ¡å™¨éƒ¨ç½²ï¼ˆæ¨¡å¼ä¸‰ï¼‰**ï¼š
```
äº‘æœåŠ¡å™¨A (Web+Backend)      äº‘æœåŠ¡å™¨B (Analytics)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Web + Backend           â”‚   â”‚ Analytics Engine        â”‚
â”‚ ANALYTICS_ENGINE_ADDR=  â”‚â”€â”€â”€â”¼â”€â”€â†’ systemd service      â”‚
â”‚ B-SERVER-IP:50051       â”‚   â”‚ Port: 50051             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ æ ¸å¿ƒè„šæœ¬è¯´æ˜

| è„šæœ¬ | ç”¨é€” | ä½¿ç”¨åœºæ™¯ |
|------|------|----------|
| `build.sh` | æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶ | æ‰€æœ‰åœºæ™¯å¿…éœ€ |
| `run.sh` | å¼€å‘æ¨¡å¼è¿è¡Œ | å¼€å‘è°ƒè¯• |
| `setup-user.sh` | åˆ›å»ºanalyticsç”¨æˆ· | ç”Ÿäº§éƒ¨ç½²å¿…éœ€ |
| `deploy.sh` | ç”Ÿäº§éƒ¨ç½² | å•æœåŠ¡å™¨/è·¨æœåŠ¡å™¨ |
| `manage-service.sh` | æœåŠ¡ç®¡ç† | è¿ç»´ç®¡ç† |

### è„šæœ¬å…³ç³»
```
å¼€å‘æµç¨‹: build.sh â†’ run.sh
ç”Ÿäº§æµç¨‹: setup-user.sh â†’ build.sh â†’ deploy.sh â†’ manage-service.sh
```

### è¯¦ç»†ä½¿ç”¨è¯´æ˜

æ›´å¤šè„šæœ¬ä½¿ç”¨è¯´æ˜è¯·å‚è€ƒï¼š[scripts/README.md](README.md)

---

## ğŸ“ æ—¥å¸¸è¿ç»´

### æœåŠ¡ç®¡ç†
```bash
# å‹å¥½çš„å›¾å½¢ç•Œé¢
./scripts/manage-service.sh

# æˆ–ç›´æ¥systemctlå‘½ä»¤
sudo systemctl {start|stop|restart|status} analytics-engine
```

### ç›‘æ§æ£€æŸ¥
```bash
# å¥åº·æ£€æŸ¥
curl -f http://localhost:50051/health
grpcurl -plaintext localhost:50051 analytics.AnalyticsEngine/HealthCheck

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u analytics-engine -f

# æ€§èƒ½ç›‘æ§
htop -p $(pgrep analytics-server)
```

### æ›´æ–°éƒ¨ç½²
```bash
# é‡æ–°æ„å»º
./scripts/build.sh

# çƒ­æ›´æ–°éƒ¨ç½²
sudo -u analytics ./scripts/deploy.sh
```

---

## ğŸš¨ æ•…éšœæ’é™¤

### æƒé™é—®é¢˜
```bash
# ç¡®ä¿analyticsç”¨æˆ·å­˜åœ¨
sudo ./scripts/setup-user.sh

# æ£€æŸ¥æ–‡ä»¶æƒé™
ls -la /opt/v7/analytics-engine/
```

### æœåŠ¡æ— æ³•å¯åŠ¨
```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
sudo journalctl -u analytics-engine -n 50

# æ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶
/opt/v7/analytics-engine/bin/analytics-server --version
```

### ç½‘ç»œè¿æ¥é—®é¢˜
```bash
# æ£€æŸ¥ç«¯å£ç›‘å¬
sudo netstat -tlnp | grep 50051

# æµ‹è¯•gRPCè¿æ¥
grpcurl -plaintext localhost:50051 analytics.AnalyticsEngine/HealthCheck
```

### Pythonæ¨¡å—é—®é¢˜
```bash
# æ£€æŸ¥Pythonè·¯å¾„
sudo -u analytics /opt/v7/analytics-engine/bin/analytics-server --test-python
```

### å¸¸è§é”™è¯¯è§£å†³

#### é”™è¯¯ï¼š`Permission denied`
```bash
# æ£€æŸ¥ç”¨æˆ·å’Œæƒé™
sudo ./scripts/setup-user.sh
sudo chown -R analytics:analytics /opt/v7/analytics-engine/
```

#### é”™è¯¯ï¼š`Address already in use`
```bash
# æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
sudo netstat -tlnp | grep 50051
sudo kill -9 <PID>
```

#### é”™è¯¯ï¼š`Python module not found`
```bash
# é‡æ–°å®‰è£…Pythonä¾èµ–
cd analytics-engine && pip install -r requirements.txt
```

---

## ğŸ”’ å®‰å…¨æœ€ä½³å®è·µ

### ç”¨æˆ·æƒé™
- âœ… **analyticsä¸“ç”¨ç”¨æˆ·**ï¼šè¿è¡ŒæœåŠ¡ï¼Œæœ€å°æƒé™
- âœ… **sudoç”¨æˆ·**ï¼šç®¡ç†å’Œéƒ¨ç½²æ“ä½œ
- âœ… **æƒé™éš”ç¦»**ï¼šæœåŠ¡æ— æ³•è®¿é—®å…¶ä»–ç³»ç»Ÿèµ„æº

### ç½‘ç»œå®‰å…¨
```bash
# åŒæœåŠ¡å™¨éƒ¨ç½²ï¼ˆæ¨èï¼‰
ANALYTICS_ENGINE_ADDR=localhost:50051  # æ— éœ€å¼€æ”¾å¤–éƒ¨ç«¯å£

# è·¨æœåŠ¡å™¨éƒ¨ç½²ï¼ˆæŒ‰éœ€ï¼‰
sudo ufw allow 50051/tcp  # ä»…é™å†…ç½‘è®¿é—®
```

### æ–‡ä»¶å®‰å…¨
```bash
# æ£€æŸ¥å…³é”®æƒé™
ls -la /opt/v7/analytics-engine/bin/analytics-server  # 755, owned by analytics
ls -la /etc/systemd/system/analytics-engine.service   # 644, owned by root
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### ç³»ç»Ÿèµ„æº
- **CPU**: 2-4æ ¸ï¼ˆå•æœåŠ¡å™¨ï¼‰/ 4-8æ ¸ï¼ˆä¸“ç”¨æœåŠ¡å™¨ï¼‰
- **å†…å­˜**: 4-8GBï¼ˆå«Python MLåº“ï¼‰
- **å­˜å‚¨**: 20-50GB
- **ç½‘ç»œ**: 1Gbps+ï¼ˆè·¨æœåŠ¡å™¨é€šä¿¡ï¼‰

### systemdé…ç½®è°ƒä¼˜
```bash
# ç¼–è¾‘systemdæœåŠ¡
sudo systemctl edit analytics-engine

# æ·»åŠ èµ„æºé™åˆ¶
[Service]
MemoryMax=4G
TasksMax=8192
LimitNOFILE=65536
```

---

## ğŸ”„ å¤‡ä»½å’Œæ¢å¤

### å¤‡ä»½é‡è¦æ•°æ®
```bash
sudo tar -czf analytics-backup-$(date +%Y%m%d).tar.gz \
  /opt/v7/analytics-engine/ \
  /etc/systemd/system/analytics-engine.service
```

### æ¢å¤æ­¥éª¤
```bash
sudo tar -xzf analytics-backup-20240315.tar.gz -C /
sudo systemctl daemon-reload
sudo systemctl start analytics-engine
```

---

## ğŸ‰ æ€»ç»“

### æ¨èè·¯å¾„
1. **å¼€å‘é˜¶æ®µ**ï¼šä½¿ç”¨`run.sh`å¿«é€ŸéªŒè¯åŠŸèƒ½
2. **æµ‹è¯•é˜¶æ®µ**ï¼šä½¿ç”¨å•æœåŠ¡å™¨éƒ¨ç½²éªŒè¯å®Œæ•´æµç¨‹
3. **ç”Ÿäº§é˜¶æ®µ**ï¼šæ ¹æ®è´Ÿè½½é€‰æ‹©å•æœåŠ¡å™¨æˆ–è·¨æœåŠ¡å™¨

### æ ¸å¿ƒä¼˜åŠ¿
- ğŸš€ **é«˜æ€§èƒ½**ï¼šåŸç”ŸäºŒè¿›åˆ¶ï¼Œæ— å®¹å™¨å¼€é”€
- ğŸ”’ **å®‰å…¨æ€§**ï¼šä¸“ç”¨ç”¨æˆ·ï¼Œæƒé™éš”ç¦»
- ğŸ› ï¸ **ç®€å•æ€§**ï¼šæ ‡å‡†systemdï¼Œç»Ÿä¸€ç®¡ç†
- ğŸ”„ **å¯é æ€§**ï¼šè‡ªåŠ¨é‡å¯ï¼Œå¥åº·æ£€æŸ¥

**è®°ä½**ï¼šé€‰æ‹©æœ€ç®€å•æ»¡è¶³éœ€æ±‚çš„éƒ¨ç½²æ–¹å¼ï¼Œä¸è¦è¿‡åº¦å¤æ‚åŒ–ï¼ 