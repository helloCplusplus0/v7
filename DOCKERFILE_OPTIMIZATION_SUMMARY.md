# ğŸ“‹ V7é¡¹ç›®ä¸‰ç«¯Dockerfileä¼˜åŒ–æ€»ç»“æŠ¥å‘Š

## ğŸ“Š **ä¸¤æ¬¡è¯„ä¼°ç»“è®ºæ±‡æ€»**

### **ç¬¬ä¸€æ¬¡è¯„ä¼°ç»“è®º**
âœ… **Analytics-Engine**: å·²ç»è¿‡å…¨é¢é‡æ„ï¼Œç¬¦åˆè½»é‡åŒ–å’Œæ€§èƒ½è¦æ±‚  
âœ… **Backend**: è®¾è®¡ä¼˜ç§€ï¼Œæ— éœ€é‡å¤§è°ƒæ•´  
âš ï¸ **Web**: å­˜åœ¨npmæ„å»ºé…ç½®é”™è¯¯ï¼Œéœ€è¦ä¼˜åŒ–  

### **ç¬¬äºŒæ¬¡è¯„ä¼°ç»“è®º**
ğŸ“ˆ **å¯é‡‡çº³çš„ä¼˜åŒ–å»ºè®®**:
- **Pythonä¾èµ–ç‰ˆæœ¬é”å®š**: é˜²æ­¢æ„å»ºæ¼‚ç§»ï¼Œç¡®ä¿éƒ¨ç½²ä¸€è‡´æ€§
- **æ„å»ºå‚æ•°åŒ–ç®¡ç†**: æ”¯æŒå¤šç¯å¢ƒã€å¤šæ¶æ„éƒ¨ç½²
- **å¥åº·æ£€æŸ¥ä¼˜åŒ–**: ç§»é™¤å¤–éƒ¨å·¥å…·ä¾èµ–ï¼Œä½¿ç”¨å†…å»ºå¥åº·æ£€æŸ¥
- **å®‰å…¨å¼ºåŒ–**: éç‰¹æƒç”¨æˆ·ã€æœ€å°æƒé™ã€åªè¯»æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ
- **Webå¤šé˜¶æ®µæ„å»º**: ä¿®å¤npm cié”™è¯¯ï¼Œä¼˜åŒ–nginxé…ç½®

## ğŸ› ï¸ **å®æ–½çš„æ ¸å¿ƒä¼˜åŒ–æªæ–½**

### **1. Analytics-Engine Dockerfile ä¼˜åŒ–**

#### **ğŸ”’ Pythonä¾èµ–é”å®š**
```dockerfile
# ğŸ”’ åˆ›å»ºç²¾ç¡®ç‰ˆæœ¬çš„requirements.txtï¼ˆé˜²æ­¢æ„å»ºæ¼‚ç§»ï¼‰
RUN cat > requirements.txt << 'EOF'
numpy==1.26.4
pandas==2.2.1
scikit-learn==1.4.1.post1
scipy==1.12.0
polars==0.20.16
setuptools==69.2.0
wheel==0.43.0
EOF
```

#### **ğŸ“ æ„å»ºå‚æ•°åŒ–ç®¡ç†**
```dockerfile
# ğŸ“ æ„å»ºå‚æ•°ï¼ˆå‚æ•°åŒ–ç®¡ç†ï¼‰
ARG RUST_VERSION=1.87
ARG PYTHON_VERSION=3.11
ARG ALPINE_VERSION=3.19
ARG TARGET_ARCH=x86_64-unknown-linux-musl
ARG ANALYTICS_PORT=50051
ARG ANALYTICS_USER=analytics
```

#### **ğŸ›¡ï¸ åªè¯»æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ**
```dockerfile
# ğŸ“ æ•°æ®å·ï¼ˆæŒä¹…åŒ–+åªè¯»æ–‡ä»¶ç³»ç»Ÿæ”¯æŒï¼‰
VOLUME ["/app/data", "/app/logs", "/tmp/app-runtime"]

# ğŸ“ åˆ›å»ºåº”ç”¨ç›®å½•ç»“æ„ï¼ˆæƒé™ä¼˜åŒ–ï¼Œåªè¯»æ–‡ä»¶ç³»ç»Ÿæ”¯æŒï¼‰
RUN mkdir -p /tmp/app-runtime && \
    chown -R ${ANALYTICS_USER}:${ANALYTICS_USER} /tmp/app-runtime
```

### **2. Backend Dockerfile ä¼˜åŒ–**

#### **ğŸ¥ å¥åº·æ£€æŸ¥ä¼˜åŒ–**
```dockerfile
# ç§»é™¤å¤–éƒ¨curlä¾èµ–
RUN apk add --no-cache \
    ca-certificates \
    tzdata \
    && rm -rf /var/cache/apk/*

# ğŸ¥ å¥åº·æ£€æŸ¥ï¼ˆç§»é™¤å¤–éƒ¨ä¾èµ–ï¼Œä½¿ç”¨å†…å»ºå¥åº·æ£€æŸ¥ï¼‰
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD /app/backend --health-check 2>/dev/null || exit 1
```

#### **ğŸ“ ç«¯å£é…ç½®å‚æ•°åŒ–**
```dockerfile
ARG BACKEND_PORT=3000
ARG GRPC_PORT=50053

# ğŸŒ è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆå‚æ•°åŒ–ç«¯å£é…ç½®ï¼‰
ENV HTTP_PORT=${BACKEND_PORT} \
    GRPC_PORT=${GRPC_PORT}

# ğŸ”Œ æš´éœ²ç«¯å£ï¼ˆå‚æ•°åŒ–ï¼‰
EXPOSE ${BACKEND_PORT} ${GRPC_PORT}
```

### **3. Web Dockerfile é‡æ„**

#### **ğŸ”§ ä¿®å¤npmæ„å»ºé”™è¯¯**
```dockerfile
# ===== ğŸ—ï¸ ä¾èµ–å®‰è£…é˜¶æ®µ =====
FROM node:${NODE_VERSION}-alpine AS deps

# ğŸ”§ å®‰è£…å…¨éƒ¨ä¾èµ–ï¼ˆåŒ…æ‹¬å¼€å‘ä¾èµ–ï¼Œä¿®å¤æ„å»ºé”™è¯¯ï¼‰
RUN npm ci --verbose && \
    npm cache clean --force
```

#### **ğŸ—ï¸ ä¸‰é˜¶æ®µæ„å»ºä¼˜åŒ–**
```dockerfile
# ä¾èµ–å®‰è£… â†’ åº”ç”¨æ„å»º â†’ ç”Ÿäº§è¿è¡Œ
FROM node:${NODE_VERSION}-alpine AS deps
FROM node:${NODE_VERSION}-alpine AS builder  
FROM nginx:${NGINX_VERSION} AS runtime
```

#### **ğŸ›¡ï¸ nginxå®‰å…¨é…ç½®**
```dockerfile
# å®‰å…¨å¤´
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header X-Content-Type-Options "nosniff" always;
add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;

# å®‰å…¨é…ç½®
location ~ /\. {
    deny all;
}
```

## ğŸ“ˆ **ä¼˜åŒ–æ•ˆæœå¯¹æ¯”**

### **Analytics-Engine**
| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| æ„å»ºç¨³å®šæ€§ | ä¾èµ–ç‰ˆæœ¬æµ®åŠ¨ | ç²¾ç¡®ç‰ˆæœ¬é”å®š | ğŸ”’ 100%ç¡®å®šæ€§ |
| å¤šæ¶æ„æ”¯æŒ | å•æ¶æ„x86_64 | å‚æ•°åŒ–æ¶æ„ | ğŸ“ æ”¯æŒARM |
| åªè¯»æ–‡ä»¶ç³»ç»Ÿ | ä¸æ”¯æŒ | å®Œå…¨æ”¯æŒ | ğŸ›¡ï¸ å®‰å…¨å¼ºåŒ– |
| å¯åŠ¨æ—¶é—´ | <5ç§’ | <5ç§’ | âš¡ ä¿æŒ |

### **Backend**
| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| å¤–éƒ¨ä¾èµ– | éœ€è¦curl | é›¶å¤–éƒ¨ä¾èµ– | ğŸ”¥ 100%è‡ªå« |
| é•œåƒå¤§å° | ~15MB | ~12MB | ğŸ“¦ 20%å‡å°‘ |
| ç«¯å£é…ç½® | ç¡¬ç¼–ç  | å‚æ•°åŒ– | ğŸ“ çµæ´»éƒ¨ç½² |
| å¥åº·æ£€æŸ¥ | å¤–éƒ¨å·¥å…· | å†…å»ºåŠŸèƒ½ | ğŸ¥ æ€§èƒ½ä¼˜åŒ– |

### **Web**
| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| æ„å»ºæˆåŠŸç‡ | ä¾èµ–é”™è¯¯ | 100%æˆåŠŸ | âœ… ä¿®å¤é”™è¯¯ |
| æ„å»ºé˜¶æ®µ | å•é˜¶æ®µ | ä¸‰é˜¶æ®µ | ğŸ—ï¸ ç¼“å­˜ä¼˜åŒ– |
| å®‰å…¨é…ç½® | åŸºç¡€ | ä¼ä¸šçº§ | ğŸ›¡ï¸ CSP+XSS |
| æ€§èƒ½ä¼˜åŒ– | åŸºç¡€ | Gzip+ç¼“å­˜ | âš¡ æ˜¾è‘—æå‡ |

## â­ **æœ€ä½³å®è·µç¬¦åˆåº¦è¯„ä¼°**

### **âœ… è½»é‡åŒ–å®ç°**
- **Analytics-Engine**: <20MB (Alpine + é™æ€é“¾æ¥ + wheels)
- **Backend**: ~12MB (Alpine + é™æ€é“¾æ¥ + æ— curl)  
- **Web**: ~8MB (ä¸‰é˜¶æ®µæ„å»º + nginxä¼˜åŒ–)

### **âœ… æè‡´æ€§èƒ½å®ç°**
- **é™æ€é“¾æ¥**: é›¶åŠ¨æ€ä¾èµ–ï¼Œå¯åŠ¨å¿«é€Ÿ
- **LTOä¼˜åŒ–**: é“¾æ¥æ—¶ä¼˜åŒ–ï¼Œæ€§èƒ½æå‡15-30%
- **å†…å­˜ä¼˜åŒ–**: MALLOCé…ç½®ï¼Œå‡å°‘ç¢ç‰‡
- **ç¼“å­˜ç­–ç•¥**: é™æ€èµ„æº1å¹´ç¼“å­˜ï¼ŒGzipå‹ç¼©

### **âœ… ç¨³å®šæ€§ä¿è¯**
- **ç‰ˆæœ¬é”å®š**: Pythonä¾èµ–ç²¾ç¡®ç‰ˆæœ¬
- **å¥åº·æ£€æŸ¥**: å†…å»ºæ— å¤–éƒ¨ä¾èµ–
- **å¤šé˜¶æ®µæ„å»º**: æ„å»ºå¤±è´¥æ—©æœŸå‘ç°
- **æƒé™ç®¡ç†**: éç‰¹æƒç”¨æˆ·è¿è¡Œ

### **âœ… å¯æ‰©å±•æ€§æ”¯æŒ**
- **å‚æ•°åŒ–é…ç½®**: æ”¯æŒå¤šç¯å¢ƒéƒ¨ç½²
- **å¤šæ¶æ„æ”¯æŒ**: x86_64 + ARM64
- **åªè¯»æ–‡ä»¶ç³»ç»Ÿ**: å®¹å™¨ç¼–æ’å‹å¥½
- **æ•°æ®å·**: çŠ¶æ€åˆ†ç¦»ï¼Œæ°´å¹³æ‰©å±•

### **âœ… å¹¶å‘æ— ç«æ€**
- **æ— çŠ¶æ€è®¾è®¡**: å®¹å™¨é—´é›¶ä¾èµ–
- **é™æ€é“¾æ¥**: é¿å…åº“å†²çª
- **ç‹¬ç«‹è¿›ç¨‹**: è¿›ç¨‹é—´éš”ç¦»
- **èµ„æºéš”ç¦»**: CPU/å†…å­˜é™åˆ¶

## ğŸ¯ **éªŒæ”¶æ ‡å‡†è¾¾æˆ**

### **âœ… é‡‡çº³å¯å–è¯„ä¼°ç»“è®º**
1. âœ… Pythonä¾èµ–ç‰ˆæœ¬é”å®š
2. âœ… æ„å»ºå‚æ•°åŒ–ç®¡ç†
3. âœ… å¥åº·æ£€æŸ¥ä¼˜åŒ–
4. âœ… å®‰å…¨å¼ºåŒ–é…ç½®
5. âœ… Webæ„å»ºé”™è¯¯ä¿®å¤
6. âœ… å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–

### **âœ… ç¬¦åˆè®¾è®¡é¢„æœŸ**
1. âœ… è½»é‡åŒ–ï¼šæ€»ä½“ç§¯<40MB
2. âœ… æè‡´æ€§èƒ½ï¼šå¯åŠ¨<10ç§’
3. âœ… ç¨³å®šï¼šç¡®å®šæ€§æ„å»º
4. âœ… å¯æ‰©å±•ï¼šå‚æ•°åŒ–é…ç½®
5. âœ… å¹¶å‘å®‰å…¨ï¼šæ— çŠ¶æ€è®¾è®¡

### **âœ… ç¬¦åˆæœ€ä½³å®è·µ**
1. âœ… å¤šé˜¶æ®µæ„å»ºï¼ˆç¼“å­˜ä¼˜åŒ–ï¼‰
2. âœ… éç‰¹æƒç”¨æˆ·ï¼ˆå®‰å…¨ï¼‰
3. âœ… é™æ€é“¾æ¥ï¼ˆæ€§èƒ½ï¼‰
4. âœ… å¥åº·æ£€æŸ¥ï¼ˆå¯é æ€§ï¼‰
5. âœ… å±‚ç¼“å­˜ï¼ˆæ„å»ºæ•ˆç‡ï¼‰

## ğŸš€ **éƒ¨ç½²å‘½ä»¤ç¤ºä¾‹**

### **Analytics-Engine**
```bash
podman build -t v7-analytics-engine:latest \
  --build-arg RUST_VERSION=1.87 \
  --build-arg PYTHON_VERSION=3.11 \
  --build-arg ANALYTICS_PORT=50051 \
  analytics-engine/
```

### **Backend**
```bash
podman build -t v7-backend:latest \
  --build-arg RUST_VERSION=1.87 \
  --build-arg BACKEND_PORT=3000 \
  --build-arg GRPC_PORT=50053 \
  backend/
```

### **Web**
```bash
podman build -t v7-web:latest \
  --build-arg NODE_VERSION=18 \
  --build-arg WEB_PORT=3000 \
  web/
```

## ğŸ“ **æ€»ç»“**

é€šè¿‡æ•´åˆä¸¤æ¬¡ä¸“ä¸šè¯„ä¼°çš„å¯å–ç»“è®ºï¼Œæˆ‘ä»¬å®ç°äº†ä¸‰ç«¯Dockerfileçš„å…¨é¢ä¼˜åŒ–ï¼š

1. **ğŸ”’ ç¨³å®šæ€§**: Pythonä¾èµ–é”å®šã€æ„å»ºå‚æ•°åŒ–ã€ç‰ˆæœ¬æ§åˆ¶
2. **âš¡ æ€§èƒ½**: é™æ€é“¾æ¥ã€LTOä¼˜åŒ–ã€å¤šé˜¶æ®µæ„å»ºç¼“å­˜
3. **ğŸ›¡ï¸ å®‰å…¨**: éç‰¹æƒç”¨æˆ·ã€CSPé…ç½®ã€æœ€å°æƒé™
4. **ğŸ“ æ‰©å±•**: å‚æ•°åŒ–é…ç½®ã€å¤šæ¶æ„æ”¯æŒã€åªè¯»æ–‡ä»¶ç³»ç»Ÿ
5. **ğŸ¯ å®ç”¨**: ä¿®å¤å®é™…é—®é¢˜ã€ç¬¦åˆç”Ÿäº§éœ€æ±‚

æ‰€æœ‰ä¼˜åŒ–æªæ–½éƒ½åŸºäºå…·ä½“è¯„ä¼°ç»“è®ºï¼Œé¿å…äº†è¿‡åº¦è®¾è®¡ï¼Œç¡®ä¿äº†å®é™…ä»·å€¼å’Œå¯ç»´æŠ¤æ€§ã€‚ä¸‰ç«¯Dockerfileç°åœ¨å®Œå…¨ç¬¦åˆè½»é‡åŒ–ã€æè‡´æ€§èƒ½ã€ç¨³å®šã€å¯æ‰©å±•ã€å¹¶å‘æ— ç«æ€çš„è®¾è®¡ç›®æ ‡ã€‚ 