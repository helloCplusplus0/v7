# ğŸ”§ æ•°æ®åº“æŒä¹…åŒ–é—®é¢˜ä¿®å¤æ–‡æ¡£

## ğŸ“‹ é—®é¢˜æè¿°

BackendæœåŠ¡åœ¨å¯åŠ¨æ—¶æ˜¾ç¤ºä½¿ç”¨å†…å­˜æ•°æ®åº“è€ŒéæŒä¹…åŒ–SQLiteæ–‡ä»¶æ•°æ®åº“ï¼š

```
ğŸ—„ï¸ åˆ›å»ºSQLiteå†…å­˜æ•°æ®åº“: :memory:
```

å¯¼è‡´æ¯æ¬¡é‡å¯åæ•°æ®æ¸…ç©ºï¼Œä¸å…·æœ‰æŒä¹…åŒ–ç‰¹æ€§ã€‚

## ğŸ” é—®é¢˜æ ¹æºåˆ†æ

### 1. ç¯å¢ƒå˜é‡åŠ è½½æ—¶æœºé—®é¢˜
- `Config::from_env()`åœ¨`GLOBAL_CONFIG`åˆå§‹åŒ–æ—¶è¢«è°ƒç”¨
- è¿™å‘ç”Ÿåœ¨`main.rs`çš„`load_environment_config()`ä¹‹å‰
- åŸå§‹å®ç°åªå°è¯•åŠ è½½æ ‡å‡†çš„`.env`æ–‡ä»¶ï¼Œè€Œä¸æ˜¯é¡¹ç›®ä½¿ç”¨çš„`dev.env`æ–‡ä»¶

### 2. Cargoé…ç½®æ–‡ä»¶å†²çª
- `.cargo/config.toml`ä¸­çš„é…ç½®ï¼š
  ```toml
  DATABASE_URL = { value = "sqlite::memory:", condition = "cfg(test)" }
  ```
- è¿™ä¸ªé…ç½®æ„å¤–åœ°å½±å“äº†æ­£å¸¸è¿è¡Œæ—¶çš„ç¯å¢ƒå˜é‡è¯»å–

### 3. é…ç½®æ–‡ä»¶å‘½åä¸ä¸€è‡´
- é¡¹ç›®ä½¿ç”¨`dev.env`æ–‡ä»¶å­˜å‚¨å¼€å‘ç¯å¢ƒé…ç½®
- ä½†dotenvåº“é»˜è®¤æŸ¥æ‰¾`.env`æ–‡ä»¶

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### 1. ä¿®å¤é…ç½®åŠ è½½ä¼˜å…ˆçº§

åœ¨`src/infra/config/mod.rs`ä¸­ä¿®æ”¹`Config::from_env()`æ–¹æ³•ï¼š

```rust
/// ä»ç¯å¢ƒå˜é‡åˆ›å»ºé…ç½®
#[must_use]
pub fn from_env() -> Self {
    let environment = Environment::from_env();
    let config = Self::new(environment);

    // ğŸ”§ ä¿®å¤ï¼šåŠ è½½ç¯å¢ƒé…ç½®æ–‡ä»¶çš„ä¼˜å…ˆçº§
    // 1. ä¼˜å…ˆå°è¯•åŠ è½½ dev.env æ–‡ä»¶ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
    if std::path::Path::new("dev.env").exists() {
        if let Err(e) = dotenv::from_filename("dev.env") {
            eprintln!("Warning: Failed to load dev.env file: {e}");
        }
    }
    // 2. å°è¯•åŠ è½½ç¯å¢ƒå˜é‡æŒ‡å®šçš„æ–‡ä»¶
    else if let Ok(env_path) = std::env::var("ENV_FILE") {
        if let Err(e) = dotenv::from_path(&env_path) {
            eprintln!("Warning: Failed to load .env file: {e}");
        }
    }
    // 3. å›é€€åˆ°æ ‡å‡† .env æ–‡ä»¶
    else if environment.is_development() {
        let _ = dotenv::dotenv(); // å°è¯•åŠ è½½.envæ–‡ä»¶
    }

    config
}
```

### 2. ä¿®å¤Cargoé…ç½®æ–‡ä»¶

åœ¨`.cargo/config.toml`ä¸­ä¿®å¤æµ‹è¯•ç¯å¢ƒå˜é‡é…ç½®ï¼š

```toml
# ğŸ”§ ä¿®å¤å‰ï¼ˆæœ‰é—®é¢˜ï¼‰
[env]
DATABASE_URL = { value = "sqlite::memory:", condition = "cfg(test)" }

# ğŸ”§ ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰
[target.'cfg(test)'.env]
DATABASE_URL = "sqlite::memory:"
```

### 3. ç®€åŒ–ä¸»ç¨‹åºé…ç½®åŠ è½½

åœ¨`src/main.rs`ä¸­ç®€åŒ–`load_environment_config()`å‡½æ•°ï¼š

```rust
/// ğŸ”§ åŠ è½½ç¯å¢ƒé…ç½®æ–‡ä»¶
fn load_environment_config() {
    // é…ç½®åŠ è½½å·²ç»åœ¨ Config::from_env() ä¸­å¤„ç†äº†
    // è¿™é‡Œåªéœ€è¦æ‰“å°è°ƒè¯•ä¿¡æ¯
    
    if let Ok(db_url) = std::env::var("DATABASE_URL") {
        println!("ğŸ“Š æ•°æ®åº“é…ç½®: {}", db_url);
    } else {
        println!("ğŸ“Š æ•°æ®åº“é…ç½®: ä½¿ç”¨é»˜è®¤å€¼");
    }
    
    if let Ok(create_test_data) = std::env::var("CREATE_TEST_DATA") {
        println!("ğŸ”§ æµ‹è¯•æ•°æ®åˆ›å»º: {}", create_test_data);
    } else {
        println!("ğŸ”§ æµ‹è¯•æ•°æ®åˆ›å»º: ä½¿ç”¨é»˜è®¤å€¼");
    }
}
```

## âœ… ä¿®å¤éªŒè¯

ä¿®å¤åçš„å¯åŠ¨æ—¥å¿—æ˜¾ç¤ºï¼š

```
ğŸ“Š æ•°æ®åº“é…ç½®: sqlite:./backend/data/dev.db
ğŸ—„ï¸ åˆ›å»ºSQLiteæ–‡ä»¶æ•°æ®åº“: ./backend/data/dev.db
âœ… æ•°æ®åº“è¿ç§»å®Œæˆ
æ•°æ®åº“å·²æœ‰ 3 ä¸ªé¡¹ç›®ï¼Œè·³è¿‡æµ‹è¯•æ•°æ®åˆ›å»º
```

### éªŒè¯è¦ç‚¹ï¼š
1. âœ… æ­£ç¡®è¯»å–`dev.env`æ–‡ä»¶ä¸­çš„`DATABASE_URL`é…ç½®
2. âœ… ä½¿ç”¨æŒä¹…åŒ–SQLiteæ–‡ä»¶æ•°æ®åº“ï¼ˆ`./backend/data/dev.db`ï¼‰
3. âœ… æ•°æ®åœ¨é‡å¯åä¿æŒä¸å˜ï¼ˆæ˜¾ç¤º"å·²æœ‰3ä¸ªé¡¹ç›®"ï¼‰
4. âœ… æµ‹è¯•ç¯å¢ƒä»ç„¶ä½¿ç”¨å†…å­˜æ•°æ®åº“ï¼ˆä¸å½±å“æµ‹è¯•ï¼‰

## ğŸ¯ é…ç½®æ–‡ä»¶ç»“æ„

### dev.envï¼ˆå¼€å‘ç¯å¢ƒï¼‰
```env
# æ•°æ®åº“é…ç½®
DATABASE_URL=sqlite:./backend/data/dev.db

# æµ‹è¯•æ•°æ®é…ç½®
CREATE_TEST_DATA=true

# å…¶ä»–é…ç½®...
```

### .cargo/config.tomlï¼ˆæ„å»ºé…ç½®ï¼‰
```toml
# æµ‹è¯•ç¯å¢ƒä¸“ç”¨é…ç½®
[target.'cfg(test)'.env]
DATABASE_URL = "sqlite::memory:"
```

## ğŸ“Š æŠ€æœ¯è¦ç‚¹

### 1. ç¯å¢ƒå˜é‡åŠ è½½ä¼˜å…ˆçº§
1. `dev.env`æ–‡ä»¶ï¼ˆå¼€å‘ç¯å¢ƒä¼˜å…ˆï¼‰
2. `ENV_FILE`ç¯å¢ƒå˜é‡æŒ‡å®šçš„æ–‡ä»¶
3. æ ‡å‡†`.env`æ–‡ä»¶ï¼ˆå›é€€é€‰é¡¹ï¼‰

### 2. é…ç½®ç³»ç»Ÿè®¾è®¡
- ä½¿ç”¨`LazyLock`ç¡®ä¿é…ç½®å•ä¾‹åˆå§‹åŒ–
- æ”¯æŒè¿è¡Œæ—¶é…ç½®æ›´æ–°å’Œç›‘å¬
- æä¾›ç±»å‹å®‰å…¨çš„é…ç½®è®¿é—®æ–¹æ³•

### 3. æ•°æ®åº“æŒä¹…åŒ–
- å¼€å‘ç¯å¢ƒï¼šä½¿ç”¨æ–‡ä»¶æ•°æ®åº“ï¼ˆ`./backend/data/dev.db`ï¼‰
- æµ‹è¯•ç¯å¢ƒï¼šä½¿ç”¨å†…å­˜æ•°æ®åº“ï¼ˆ`:memory:`ï¼‰
- ç”Ÿäº§ç¯å¢ƒï¼šæ”¯æŒPostgreSQLé…ç½®

## ğŸ”® æœªæ¥æ”¹è¿›å»ºè®®

1. **é…ç½®æ–‡ä»¶æ ‡å‡†åŒ–**ï¼šè€ƒè™‘ç»Ÿä¸€ä½¿ç”¨`.env`æ–‡ä»¶å‘½å
2. **ç¯å¢ƒæ£€æµ‹å¢å¼º**ï¼šæ·»åŠ æ›´å¤šç¯å¢ƒå˜é‡æ£€æµ‹é€»è¾‘
3. **é…ç½®éªŒè¯**ï¼šå¢å¼ºé…ç½®å®Œæ•´æ€§éªŒè¯
4. **çƒ­é‡è½½æ”¯æŒ**ï¼šå®ç°é…ç½®æ–‡ä»¶å˜æ›´æ—¶çš„çƒ­é‡è½½

---

**ä¿®å¤å®Œæˆæ—¶é—´**ï¼š2025-07-14
**å½±å“èŒƒå›´**ï¼šBackendæ•°æ®æŒä¹…åŒ–ã€å¼€å‘ç¯å¢ƒé…ç½®
**æµ‹è¯•çŠ¶æ€**ï¼šâœ… å·²éªŒè¯ä¿®å¤æ•ˆæœ 