# ğŸš€ V7 Backend Podman ä¼˜åŒ–é•œåƒ
# å¤šé˜¶æ®µæ„å»º - ä¸“ä¸ºè½»é‡åŒ–å’Œæè‡´æ€§èƒ½è®¾è®¡

# ğŸ“ æ„å»ºå‚æ•°ï¼ˆå‚æ•°åŒ–ç®¡ç†ï¼‰
ARG RUST_VERSION=1.87
ARG ALPINE_VERSION=3.19
ARG TARGET_ARCH=x86_64-unknown-linux-musl
ARG BACKEND_PORT=3000
ARG GRPC_PORT=50053
ARG APP_USER=appuser
ARG APP_UID=1002
ARG APP_GID=1002

# ===== ğŸ—ï¸ æ„å»ºé˜¶æ®µ =====
FROM rust:${RUST_VERSION}-alpine AS builder

# ğŸ“ é‡æ–°å£°æ˜æ„å»ºå‚æ•°ï¼ˆå¤šé˜¶æ®µæ„å»ºéœ€è¦ï¼‰
ARG TARGET_ARCH=x86_64-unknown-linux-musl

# ğŸ“¦ å®‰è£…æ„å»ºä¾èµ–
RUN apk add --no-cache \
    musl-dev \
    pkgconfig \
    openssl-dev \
    openssl-libs-static \
    sqlite-dev \
    sqlite-static \
    build-base \
    protobuf-dev \
    bash \
    coreutils \
    && rm -rf /var/cache/apk/*

# ğŸ› ï¸ ä¿®å¤/tmpæƒé™å’Œç©ºé—´é—®é¢˜
RUN mkdir -p /tmp && chmod 1777 /tmp
ENV TMPDIR=/tmp

# ğŸ”§ è®¾ç½®æ„å»ºç¯å¢ƒå˜é‡ï¼ˆå¢å¼ºä¼˜åŒ–ï¼‰
ENV RUSTFLAGS="-C target-feature=+crt-static -C link-arg=-static-pie -C target-cpu=native"
ENV PKG_CONFIG_ALLOW_CROSS=1
ENV OPENSSL_STATIC=1
ENV OPENSSL_DIR=/usr
ENV CARGO_NET_GIT_FETCH_WITH_CLI=true

# ğŸ“ åˆ›å»ºå·¥ä½œç›®å½•
WORKDIR /build

# ğŸ“¦ å¤åˆ¶ä¾èµ–æ–‡ä»¶ï¼ˆåˆ©ç”¨Dockerå±‚ç¼“å­˜ï¼‰
COPY Cargo.toml Cargo.lock build.rs ./
COPY proto/ proto/

# ğŸ”¨ é¢„æ„å»ºä¾èµ–ï¼ˆç¼“å­˜ä¼˜åŒ–ï¼‰- æ­£ç¡®å¤„ç†æ··åˆé¡¹ç›®
RUN mkdir -p src && \
    echo "fn main() {}" > src/main.rs && \
    echo "// Dummy lib for dependency caching" > src/lib.rs && \
    cargo build --release --target ${TARGET_ARCH} && \
    rm -rf src target/${TARGET_ARCH}/release/deps/fmod*

# ğŸ“ å¤åˆ¶æºä»£ç 
COPY src/ src/

# ğŸ—ï¸ æ„å»ºåº”ç”¨ç¨‹åº - å¯ç”¨æ‰€æœ‰ä¼˜åŒ–
RUN cargo build \
    --release \
    --target ${TARGET_ARCH} \
    --config "profile.release.lto=true" \
    --config "profile.release.codegen-units=1" \
    --config "profile.release.panic='abort'" \
    --config "profile.release.strip=true" \
    --config "profile.release.opt-level=3" \
    && cp target/${TARGET_ARCH}/release/fmod_slice /build/v7-backend

# ğŸ” éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶
RUN file /build/v7-backend && \
    ldd /build/v7-backend || echo "âœ… Static binary - no dynamic dependencies" && \
    ls -lh /build/v7-backend

# ===== ğŸƒ è¿è¡Œé˜¶æ®µ =====
FROM alpine:${ALPINE_VERSION} AS runtime

# ğŸ“¦ å®‰è£…è¿è¡Œæ—¶ä¾èµ–ï¼ˆæœ€å°åŒ–ï¼Œç§»é™¤curlï¼‰
RUN apk add --no-cache \
    ca-certificates \
    tzdata \
    && rm -rf /var/cache/apk/*

# ğŸ‘¤ åˆ›å»ºéç‰¹æƒç”¨æˆ·ï¼ˆå‚æ•°åŒ–ç”¨æˆ·é…ç½®ï¼‰
RUN addgroup -g ${APP_GID} -S appgroup && \
    adduser -u ${APP_UID} -S ${APP_USER} -G appgroup

# ğŸ“ åˆ›å»ºåº”ç”¨ç›®å½•ï¼ˆå¢å¼ºæƒé™ç®¡ç†ï¼‰
RUN mkdir -p /app/{data,logs,config,tmp} && \
    mkdir -p /tmp/app-runtime && \
    chown -R ${APP_USER}:appgroup /app /tmp/app-runtime && \
    chmod 755 /app && \
    chmod 750 /app/data /app/logs /app/config && \
    chmod 755 /app/tmp

# ğŸ“‹ è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# ğŸ“¦ ä»æ„å»ºé˜¶æ®µå¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
COPY --from=builder --chown=${APP_USER}:appgroup /build/v7-backend /app/backend

# ğŸ”§ è®¾ç½®æ‰§è¡Œæƒé™ï¼ˆå®‰å…¨ä¼˜åŒ–ï¼‰
RUN chmod 755 /app/backend

# ğŸŒ è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆå‚æ•°åŒ–ç«¯å£é…ç½®ï¼‰
ENV RUST_LOG=info \
    DATABASE_URL=sqlite:/app/data/prod.db \
    HTTP_PORT=${BACKEND_PORT} \
    GRPC_PORT=${GRPC_PORT} \
    RUST_BACKTRACE=1 \
    MALLOC_ARENA_MAX=2 \
    MALLOC_TRIM_THRESHOLD_=131072

# ğŸ”Œ æš´éœ²ç«¯å£ï¼ˆå‚æ•°åŒ–ï¼‰
EXPOSE ${BACKEND_PORT} ${GRPC_PORT}

# ğŸ“ æ•°æ®å·ï¼ˆåªè¯»æ–‡ä»¶ç³»ç»Ÿæ”¯æŒï¼‰
VOLUME ["/app/data", "/app/logs", "/tmp/app-runtime"]

# ğŸ‘¤ åˆ‡æ¢åˆ°éç‰¹æƒç”¨æˆ·
USER ${APP_USER}:appgroup

# ğŸ¥ å¥åº·æ£€æŸ¥ï¼ˆç§»é™¤å¤–éƒ¨ä¾èµ–ï¼Œä½¿ç”¨å†…å»ºå¥åº·æ£€æŸ¥ï¼‰
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD /app/backend --health-check 2>/dev/null || exit 1

# ğŸ·ï¸ é•œåƒæ ‡ç­¾ï¼ˆå¢å¼ºå…ƒæ•°æ®ï¼‰
LABEL maintainer="v7-team" \
      app="v7-backend" \
      version="v7-optimized" \
      architecture="rust+fmod-v7" \
      description="V7 Backend - Rust + FMOD v7 Architecture with gRPC support" \
      rust.version="${RUST_VERSION}" \
      optimization="lto+strip+static+no-external-deps" \
      security="non-root+minimal-deps+readonly-fs" \
      performance="extreme+static-binary" \
      ports.http="${BACKEND_PORT}" \
      ports.grpc="${GRPC_PORT}"

# ğŸš€ å¯åŠ¨å‘½ä»¤
ENTRYPOINT ["/app/backend"]

# ğŸ“ æ„å»ºè¯´æ˜
# 
# ğŸ—ï¸ æ„å»ºå‘½ä»¤:
#   podman build -t v7-backend:latest -f Dockerfile .
# 
# ğŸš€ è¿è¡Œå‘½ä»¤:
#   podman run -d \
#     --name v7-backend \
#     -p 3000:3000 \
#     -v ./data:/app/data:Z \
#     -e RUST_LOG=info \
#     v7-backend:latest
# 
# ğŸ” é•œåƒä¿¡æ¯:
#   podman inspect v7-backend:latest
# 
# ğŸ§ª æµ‹è¯•å¥åº·æ£€æŸ¥:
#   podman exec v7-backend curl -f http://localhost:3000/health
# 
# ğŸ“Š æ€§èƒ½ä¼˜åŒ–ç‰¹æ€§:
# - é™æ€é“¾æ¥äºŒè¿›åˆ¶æ–‡ä»¶ (æ— åŠ¨æ€ä¾èµ–)
# - LTO (é“¾æ¥æ—¶ä¼˜åŒ–)
# - Strip symbols (å‡å°äºŒè¿›åˆ¶å¤§å°)
# - Alpine Linux (æœ€å°åŸºç¡€é•œåƒ)
# - å¤šé˜¶æ®µæ„å»º (å‡å°æœ€ç»ˆé•œåƒå¤§å°)
# - ä¾èµ–ç¼“å­˜ä¼˜åŒ– (åŠ å¿«æ„å»ºé€Ÿåº¦)
# 
# ğŸ”’ å®‰å…¨ç‰¹æ€§:
# - éç‰¹æƒç”¨æˆ·è¿è¡Œ
# - åªè¯»æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ
# - æœ€å°åŒ–æ”»å‡»é¢
# - å¥åº·æ£€æŸ¥å†…ç½® 