# ğŸš€ V7 Backend Podman ä¼˜åŒ–é•œåƒ
# å¤šé˜¶æ®µæ„å»º - ä¸“ä¸ºè½»é‡åŒ–å’Œæè‡´æ€§èƒ½è®¾è®¡

# ===== ğŸ—ï¸ æ„å»ºé˜¶æ®µ =====
FROM rust:1.87-alpine AS builder

# ğŸ“¦ å®‰è£…æ„å»ºä¾èµ–
RUN apk add --no-cache \
    musl-dev \
    pkgconfig \
    openssl-dev \
    openssl-libs-static \
    sqlite-dev \
    sqlite-static \
    build-base \
    curl \
    && rm -rf /var/cache/apk/*

# ğŸ”§ è®¾ç½®æ„å»ºç¯å¢ƒå˜é‡
ENV RUSTFLAGS="-C target-feature=+crt-static -C link-arg=-static-pie"
ENV PKG_CONFIG_ALLOW_CROSS=1
ENV OPENSSL_STATIC=1
ENV OPENSSL_DIR=/usr

# ğŸ“ åˆ›å»ºå·¥ä½œç›®å½•
WORKDIR /build

# ğŸ“¦ å¤åˆ¶ä¾èµ–æ–‡ä»¶ï¼ˆåˆ©ç”¨Dockerå±‚ç¼“å­˜ï¼‰
COPY Cargo.toml Cargo.lock build.rs ./
COPY src/main.rs src/main.rs

# ğŸ”¨ é¢„æ„å»ºä¾èµ–ï¼ˆç¼“å­˜ä¼˜åŒ–ï¼‰
RUN mkdir -p src && \
    echo "fn main() {}" > src/main.rs && \
    cargo build --release --target x86_64-unknown-linux-musl && \
    rm -rf src

# ğŸ“ å¤åˆ¶æºä»£ç 
COPY src/ src/

# ğŸ—ï¸ æ„å»ºåº”ç”¨ç¨‹åº - å¯ç”¨æ‰€æœ‰ä¼˜åŒ–
RUN cargo build \
    --release \
    --target x86_64-unknown-linux-musl \
    --config "profile.release.lto=true" \
    --config "profile.release.codegen-units=1" \
    --config "profile.release.panic='abort'" \
    --config "profile.release.strip=true" \
    && cp target/x86_64-unknown-linux-musl/release/backend /build/v7-backend

# ğŸ” éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶
RUN file /build/v7-backend && \
    ldd /build/v7-backend || echo "Static binary - no dynamic dependencies" && \
    ls -la /build/v7-backend

# ===== ğŸƒ è¿è¡Œé˜¶æ®µ =====
FROM alpine:3.19 AS runtime

# ğŸ“¦ å®‰è£…è¿è¡Œæ—¶ä¾èµ–ï¼ˆæœ€å°åŒ–ï¼‰
RUN apk add --no-cache \
    ca-certificates \
    curl \
    tzdata \
    && rm -rf /var/cache/apk/*

# ğŸ‘¤ åˆ›å»ºéç‰¹æƒç”¨æˆ·
RUN addgroup -g 1001 -S appgroup && \
    adduser -u 1001 -S appuser -G appgroup

# ğŸ“ åˆ›å»ºåº”ç”¨ç›®å½•
RUN mkdir -p /app/{data,logs,config} && \
    chown -R appuser:appgroup /app

# ğŸ“‹ è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# ğŸ“¦ ä»æ„å»ºé˜¶æ®µå¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
COPY --from=builder --chown=appuser:appgroup /build/v7-backend /app/backend

# ğŸ”§ è®¾ç½®æ‰§è¡Œæƒé™
RUN chmod +x /app/backend

# ğŸŒ è®¾ç½®ç¯å¢ƒå˜é‡
ENV RUST_LOG=info
ENV DATABASE_URL=sqlite:./data/prod.db
ENV PORT=3000
ENV RUST_BACKTRACE=1

# ğŸ”Œ æš´éœ²ç«¯å£
EXPOSE 3000

# ğŸ‘¤ åˆ‡æ¢åˆ°éç‰¹æƒç”¨æˆ·
USER appuser:appgroup

# ğŸ¥ å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:3000/health || exit 1

# ğŸ·ï¸ é•œåƒæ ‡ç­¾
LABEL maintainer="hellocplusplus0" \
      app="v7-backend" \
      version="latest" \
      architecture="podman" \
      description="V7 Backend - Rust + FMOD v7 Architecture" \
      rust.version="1.87" \
      build.optimization="lto+strip+static"

# ğŸš€ å¯åŠ¨å‘½ä»¤
ENTRYPOINT ["/app/backend"]

# ğŸ“ æ„å»ºè¯´æ˜
# 
# ğŸ—ï¸ æ„å»ºå‘½ä»¤:
#   podman build -t v7-backend:latest -f Dockerfile .
# 
# ğŸš€ è¿è¡Œå‘½ä»¤:
#   podman run -d \
#     --name v7-backend \
#     -p 3000:3000 \
#     -v ./data:/app/data:Z \
#     -e RUST_LOG=info \
#     v7-backend:latest
# 
# ğŸ” é•œåƒä¿¡æ¯:
#   podman inspect v7-backend:latest
# 
# ğŸ§ª æµ‹è¯•å¥åº·æ£€æŸ¥:
#   podman exec v7-backend curl -f http://localhost:3000/health
# 
# ğŸ“Š æ€§èƒ½ä¼˜åŒ–ç‰¹æ€§:
# - é™æ€é“¾æ¥äºŒè¿›åˆ¶æ–‡ä»¶ (æ— åŠ¨æ€ä¾èµ–)
# - LTO (é“¾æ¥æ—¶ä¼˜åŒ–)
# - Strip symbols (å‡å°äºŒè¿›åˆ¶å¤§å°)
# - Alpine Linux (æœ€å°åŸºç¡€é•œåƒ)
# - å¤šé˜¶æ®µæ„å»º (å‡å°æœ€ç»ˆé•œåƒå¤§å°)
# - ä¾èµ–ç¼“å­˜ä¼˜åŒ– (åŠ å¿«æ„å»ºé€Ÿåº¦)
# 
# ğŸ”’ å®‰å…¨ç‰¹æ€§:
# - éç‰¹æƒç”¨æˆ·è¿è¡Œ
# - åªè¯»æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ
# - æœ€å°åŒ–æ”»å‡»é¢
# - å¥åº·æ£€æŸ¥å†…ç½® 