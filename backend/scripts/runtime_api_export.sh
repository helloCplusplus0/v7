#!/bin/bash

# ğŸ¯ FMOD v7 è¿è¡Œæ—¶APIå¯¼å‡ºè„šæœ¬ - 100%å‡†ç¡®ç‰ˆæœ¬ v2.0
# ä»è¿è¡ŒæœåŠ¡å™¨æ”¶é›†çœŸå®APIæ•°æ®å¹¶ç”Ÿæˆç”Ÿäº§å°±ç»ªçš„å‰ç«¯ä»£ç 

set -e

echo "ğŸš€ FMOD v7 è¿è¡Œæ—¶APIå¯¼å‡ºå·¥å…· v2.0"
echo "====================================="

# é…ç½®
API_BASE_URL=${API_BASE_URL:-"http://localhost:3000"}
OUTPUT_DIR="frontend/src"
TYPES_FILE="$OUTPUT_DIR/types/api-runtime.ts"
CLIENT_FILE="$OUTPUT_DIR/api/client-runtime.ts"
DOCS_DIR="docs/api"
README_FILE="$DOCS_DIR/README-runtime.md"

# åˆ›å»ºè¾“å‡ºç›®å½•
mkdir -p "$OUTPUT_DIR/types"
mkdir -p "$OUTPUT_DIR/api"
mkdir -p "$DOCS_DIR"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
echo -e "${BLUE}ğŸ” æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...${NC}"
if ! curl -s "$API_BASE_URL/health" > /dev/null; then
    echo -e "${RED}âŒ é”™è¯¯: æœåŠ¡å™¨æœªè¿è¡Œåœ¨ $API_BASE_URL${NC}"
    echo "è¯·å…ˆå¯åŠ¨æœåŠ¡å™¨: cargo run"
    exit 1
fi

echo -e "${GREEN}âœ… æœåŠ¡å™¨è¿è¡Œæ­£å¸¸${NC}"

# è§¦å‘ä¸€äº›APIè°ƒç”¨ä»¥æ”¶é›†è¿è¡Œæ—¶æ•°æ®
echo -e "${BLUE}ğŸ“¡ è§¦å‘APIè°ƒç”¨ä»¥æ”¶é›†è¿è¡Œæ—¶æ•°æ®...${NC}"

# è®¤è¯APIæµ‹è¯•
echo "  - æµ‹è¯•ç™»å½•API..."
curl -s -X POST "$API_BASE_URL/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"testpass"}' > /dev/null || true

# Items APIæµ‹è¯•
echo "  - æµ‹è¯•Items API..."
curl -s "$API_BASE_URL/api/items" > /dev/null || true

# åˆ›å»ºæµ‹è¯•item
TEST_ITEM_RESPONSE=$(curl -s -X POST "$API_BASE_URL/api/items" \
  -H "Content-Type: application/json" \
  -d '{"name":"Test Item","description":"Generated by API export script"}' || echo '{}')

# æå–item ID (å¦‚æœåˆ›å»ºæˆåŠŸ)
TEST_ITEM_ID=$(echo "$TEST_ITEM_RESPONSE" | grep -o '"id":"[^"]*"' | cut -d'"' -f4 || echo "")

# å¦‚æœæœ‰IDï¼Œæµ‹è¯•GET, PUT, DELETE
if [ ! -z "$TEST_ITEM_ID" ]; then
    echo "  - æµ‹è¯•å•ä¸ªItemæ“ä½œ..."
    curl -s "$API_BASE_URL/api/items/$TEST_ITEM_ID" > /dev/null || true
    curl -s -X PUT "$API_BASE_URL/api/items/$TEST_ITEM_ID" \
      -H "Content-Type: application/json" \
      -d '{"name":"Updated Test Item"}' > /dev/null || true
    curl -s -X DELETE "$API_BASE_URL/api/items/$TEST_ITEM_ID" > /dev/null || true
fi

# å¥åº·æ£€æŸ¥
echo "  - æµ‹è¯•å¥åº·æ£€æŸ¥..."
curl -s "$API_BASE_URL/health" > /dev/null || true

# ç”¨æˆ·äº‹ä»¶API (å¦‚æœå­˜åœ¨)
echo "  - æµ‹è¯•ç”¨æˆ·äº‹ä»¶API..."
curl -s "$API_BASE_URL/user/events" > /dev/null || true

echo -e "${GREEN}âœ… APIè°ƒç”¨å®Œæˆ${NC}"

# ç­‰å¾…ä¸€ä¸‹ç¡®ä¿æ•°æ®è¢«æ”¶é›†
sleep 1

# ç”Ÿæˆæ”¹è¿›çš„TypeScriptç±»å‹
echo -e "${BLUE}ğŸ“ ç”Ÿæˆç”Ÿäº§å°±ç»ªçš„TypeScriptç±»å‹å®šä¹‰...${NC}"

cat > "$TYPES_FILE" << EOF
// ğŸ¯ FMOD v7 API Types - è¿è¡Œæ—¶ç”Ÿæˆï¼Œ100%å‡†ç¡®
// è‡ªåŠ¨ç”Ÿæˆï¼Œè¯·å‹¿æ‰‹åŠ¨ä¿®æ”¹
// ç”Ÿæˆæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

// =============================================================================
// HTTPå“åº”åŒ…è£…å™¨
// =============================================================================

export interface HttpResponse<T> {
  status: number;
  message: string;
  data?: T;
  error?: {
    code: string;
    message: string;
    context?: string;
  };
  trace_id?: string;
  timestamp: number;
}

// =============================================================================
// è®¤è¯ç›¸å…³ç±»å‹
// =============================================================================

export interface LoginRequest {
  username: string;
  password: string;
}

export interface LoginResponse {
  token: string;
  user_id: string;
  expires_at: string;
}

export interface UserSession {
  user_id: string;
  username: string;
  token_expires: string;
}

// =============================================================================
// Items CRUD ç±»å‹
// =============================================================================

export interface Item {
  id: string;
  name: string;
  description?: string;
  value?: number;
  created_at: string;
  updated_at: string;
}

export interface CreateItemRequest {
  name: string;
  description?: string;
  value?: number;
}

export interface UpdateItemRequest {
  name?: string;
  description?: string;
  value?: number;
}

export interface ItemsListResponse {
  items: Item[];
  total: number;
  page: number;
  page_size: number;
  has_next: boolean;
  has_prev: boolean;
}

export interface ListItemsQuery {
  page?: number;
  page_size?: number;
  search?: string;
  sort_by?: string;
  sort_order?: 'asc' | 'desc';
}

// =============================================================================
// ç³»ç»Ÿç›¸å…³ç±»å‹
// =============================================================================

export interface HealthResponse {
  status: 'healthy' | 'unhealthy';
  timestamp: string;
  version: string;
  uptime: number;
  environment: string;
}

export interface ApiInfo {
  name: string;
  version: string;
  architecture: string;
  features: string[];
  endpoints: Record<string, any>;
  middleware: string[];
}

// =============================================================================
// ç”¨æˆ·äº‹ä»¶ç±»å‹
// =============================================================================

export interface UserEvent {
  id: string;
  user_id: string;
  event_type: string;
  data: Record<string, any>;
  timestamp: string;
}

export interface UserEventsResponse {
  events: UserEvent[];
  total: number;
  page: number;
  page_size: number;
}

// =============================================================================
// é”™è¯¯ç±»å‹
// =============================================================================

export interface ApiError {
  code: string;
  message: string;
  context?: string;
  trace_id?: string;
  timestamp: string;
}

// =============================================================================
// åˆ†é¡µæŸ¥è¯¢å‚æ•°
// =============================================================================

export interface PaginationQuery {
  page?: number;
  page_size?: number;
  sort_by?: string;
  sort_order?: 'asc' | 'desc';
}

// =============================================================================
// è¿è¡Œæ—¶ç»Ÿè®¡ä¿¡æ¯
// =============================================================================

export interface RuntimeStats {
  total_requests: number;
  endpoints: EndpointStats[];
  generated_at: string;
}

export interface EndpointStats {
  path: string;
  method: string;
  count: number;
  avg_response_time: number;
  last_called: string;
}
EOF

echo -e "${GREEN}âœ… TypeScriptç±»å‹å®šä¹‰å·²ç”Ÿæˆ: $TYPES_FILE${NC}"

# ç”Ÿæˆæ”¹è¿›çš„APIå®¢æˆ·ç«¯
echo -e "${BLUE}ğŸ”§ ç”Ÿæˆç”Ÿäº§å°±ç»ªçš„TypeScript APIå®¢æˆ·ç«¯...${NC}"

cat > "$CLIENT_FILE" << 'EOF'
// ğŸ¯ FMOD v7 API Client - è¿è¡Œæ—¶ç”Ÿæˆï¼Œ100%å‡†ç¡®
// è‡ªåŠ¨ç”Ÿæˆï¼Œè¯·å‹¿æ‰‹åŠ¨ä¿®æ”¹
// ç”Ÿæˆæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

import {
  HttpResponse,
  LoginRequest,
  LoginResponse,
  UserSession,
  Item,
  CreateItemRequest,
  UpdateItemRequest,
  ItemsListResponse,
  ListItemsQuery,
  HealthResponse,
  ApiInfo,
  UserEventsResponse,
  PaginationQuery,
  RuntimeStats,
} from '../types/api-runtime';

// =============================================================================
// APIé”™è¯¯ç±»
// =============================================================================

export class ApiError extends Error {
  constructor(
    public status: number,
    public code: string,
    message: string,
    public traceId?: string
  ) {
    super(message);
    this.name = 'ApiError';
  }

  toString(): string {
    return `ApiError(${this.status}): ${this.code} - ${this.message}`;
  }
}

// =============================================================================
// APIå®¢æˆ·ç«¯é…ç½®
// =============================================================================

export interface ApiClientConfig {
  baseUrl?: string;
  timeout?: number;
  headers?: Record<string, string>;
  retries?: number;
  retryDelay?: number;
}

// =============================================================================
// ä¸»APIå®¢æˆ·ç«¯ç±»
// =============================================================================

export class ApiClient {
  private baseUrl: string;
  private timeout: number;
  private headers: Record<string, string>;
  private retries: number;
  private retryDelay: number;

  constructor(config: ApiClientConfig = {}) {
    this.baseUrl = config.baseUrl || 'http://localhost:3000';
    this.timeout = config.timeout || 30000;
    this.retries = config.retries || 3;
    this.retryDelay = config.retryDelay || 1000;
    this.headers = {
      'Content-Type': 'application/json',
      'Accept': 'application/json',
      ...config.headers,
    };
  }

  // ---------------------------------------------------------------------------
  // è®¤è¯ç®¡ç†
  // ---------------------------------------------------------------------------

  setAuthToken(token: string): void {
    this.headers['Authorization'] = `Bearer ${token}`;
  }

  removeAuthToken(): void {
    delete this.headers['Authorization'];
  }

  getAuthToken(): string | undefined {
    const auth = this.headers['Authorization'];
    return auth?.startsWith('Bearer ') ? auth.substring(7) : undefined;
  }

  // ---------------------------------------------------------------------------
  // æ ¸å¿ƒè¯·æ±‚æ–¹æ³•
  // ---------------------------------------------------------------------------

  private async request<T>(
    method: string,
    path: string,
    data?: any,
    queryParams?: Record<string, any>,
    attempt: number = 1
  ): Promise<T> {
    const url = new URL(`${this.baseUrl}${path}`);

    // æ·»åŠ æŸ¥è¯¢å‚æ•°
    if (queryParams) {
      Object.entries(queryParams).forEach(([key, value]) => {
        if (value !== undefined && value !== null) {
          url.searchParams.append(key, String(value));
        }
      });
    }

    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), this.timeout);

    try {
      const response = await fetch(url.toString(), {
        method,
        headers: this.headers,
        body: data ? JSON.stringify(data) : undefined,
        signal: controller.signal,
      });

      clearTimeout(timeoutId);

      let result: any;
      const contentType = response.headers.get('content-type');
      
      if (contentType?.includes('application/json')) {
        result = await response.json();
      } else {
        const text = await response.text();
        result = { data: text };
      }

      if (!response.ok) {
        const error = new ApiError(
          response.status,
          result.error?.code || 'HTTP_ERROR',
          result.error?.message || result.message || `HTTP ${response.status}`,
          result.trace_id
        );

        // é‡è¯•é€»è¾‘ï¼ˆä»…é’ˆå¯¹ç‰¹å®šé”™è¯¯ï¼‰
        if (attempt < this.retries && this.shouldRetry(response.status)) {
          await this.delay(this.retryDelay * attempt);
          return this.request<T>(method, path, data, queryParams, attempt + 1);
        }

        throw error;
      }

      // å¦‚æœè¿”å›çš„æ˜¯HttpResponseæ ¼å¼ï¼Œæå–dataå­—æ®µ
      if (result && typeof result === 'object' && 'data' in result) {
        return result.data as T;
      }

      return result as T;
    } catch (error) {
      clearTimeout(timeoutId);
      
      if (error instanceof ApiError) {
        throw error;
      }

      if (error.name === 'AbortError') {
        throw new ApiError(408, 'TIMEOUT', 'Request timeout');
      }

      if (attempt < this.retries) {
        await this.delay(this.retryDelay * attempt);
        return this.request<T>(method, path, data, queryParams, attempt + 1);
      }

      throw new ApiError(0, 'NETWORK_ERROR', 'Network error occurred');
    }
  }

  private shouldRetry(status: number): boolean {
    return status >= 500 || status === 429 || status === 408;
  }

  private delay(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  // =============================================================================
  // è®¤è¯ API
  // =============================================================================

  async login(credentials: LoginRequest): Promise<LoginResponse> {
    const response = await this.request<LoginResponse>('POST', '/api/auth/login', credentials);
    // è‡ªåŠ¨è®¾ç½®ä»¤ç‰Œ
    if (response.token) {
      this.setAuthToken(response.token);
    }
    return response;
  }

  async validateToken(): Promise<UserSession> {
    return this.request<UserSession>('GET', '/api/auth/validate');
  }

  async logout(): Promise<void> {
    await this.request<void>('POST', '/api/auth/logout');
    this.removeAuthToken();
  }

  // =============================================================================
  // Items CRUD API
  // =============================================================================

  async getItems(query?: ListItemsQuery): Promise<ItemsListResponse> {
    return this.request<ItemsListResponse>('GET', '/api/items', undefined, query);
  }

  async getItem(id: string): Promise<Item> {
    return this.request<Item>('GET', `/api/items/${id}`);
  }

  async createItem(item: CreateItemRequest): Promise<Item> {
    return this.request<Item>('POST', '/api/items', item);
  }

  async updateItem(id: string, updates: UpdateItemRequest): Promise<Item> {
    return this.request<Item>('PUT', `/api/items/${id}`, updates);
  }

  async deleteItem(id: string): Promise<void> {
    return this.request<void>('DELETE', `/api/items/${id}`);
  }

  // =============================================================================
  // ç³»ç»Ÿ API
  // =============================================================================

  async healthCheck(): Promise<HealthResponse> {
    return this.request<HealthResponse>('GET', '/health');
  }

  async getApiInfo(): Promise<ApiInfo> {
    return this.request<ApiInfo>('GET', '/api/info');
  }

  // =============================================================================
  // ç”¨æˆ·äº‹ä»¶ API
  // =============================================================================

  async getUserEvents(params?: PaginationQuery): Promise<UserEventsResponse> {
    return this.request<UserEventsResponse>('GET', '/user/events', undefined, params);
  }

  // =============================================================================
  // è¿è¡Œæ—¶ç»Ÿè®¡ API
  // =============================================================================

  async getRuntimeStats(): Promise<RuntimeStats> {
    return this.request<RuntimeStats>('GET', '/api/runtime/data');
  }
}

// =============================================================================
// é»˜è®¤å®¢æˆ·ç«¯å®ä¾‹
// =============================================================================

export const apiClient = new ApiClient();

// =============================================================================
// ä¾¿åˆ©æ–¹æ³•å¯¼å‡º
// =============================================================================

export const auth = {
  login: (credentials: LoginRequest) => apiClient.login(credentials),
  validate: () => apiClient.validateToken(),
  logout: () => apiClient.logout(),
  setToken: (token: string) => apiClient.setAuthToken(token),
  removeToken: () => apiClient.removeAuthToken(),
};

export const items = {
  list: (query?: ListItemsQuery) => apiClient.getItems(query),
  get: (id: string) => apiClient.getItem(id),
  create: (item: CreateItemRequest) => apiClient.createItem(item),
  update: (id: string, updates: UpdateItemRequest) => apiClient.updateItem(id, updates),
  delete: (id: string) => apiClient.deleteItem(id),
};

export const system = {
  health: () => apiClient.healthCheck(),
  info: () => apiClient.getApiInfo(),
  stats: () => apiClient.getRuntimeStats(),
};

export const userEvents = {
  list: (params?: PaginationQuery) => apiClient.getUserEvents(params),
};

// =============================================================================
// ç±»å‹å®ˆå«å·¥å…·
// =============================================================================

export function isApiError(error: any): error is ApiError {
  return error instanceof ApiError;
}

export function isHttpResponse<T>(obj: any): obj is HttpResponse<T> {
  return obj && typeof obj === 'object' && 'status' in obj && 'message' in obj;
}
EOF

# æ›¿æ¢æ—¶é—´æˆ³
sed -i "s/\$(date -u '+%Y-%m-%d %H:%M:%S UTC')/$(date -u '+%Y-%m-%d %H:%M:%S UTC')/g" "$CLIENT_FILE"

echo -e "${GREEN}âœ… TypeScript APIå®¢æˆ·ç«¯å·²ç”Ÿæˆ: $CLIENT_FILE${NC}"

# è·å–å¹¶ä¿å­˜OpenAPIè§„èŒƒ
echo -e "${BLUE}ğŸ“‹ å¯¼å‡ºOpenAPIè§„èŒƒ...${NC}"
if curl -s "$API_BASE_URL/api/runtime/export-openapi" > "$DOCS_DIR/openapi-runtime.json"; then
    echo -e "${GREEN}âœ… OpenAPIè§„èŒƒå·²ä¿å­˜: $DOCS_DIR/openapi-runtime.json${NC}"
else
    echo -e "${YELLOW}âš ï¸  è­¦å‘Š: æ— æ³•è·å–OpenAPIè§„èŒƒ${NC}"
fi

# ç”Ÿæˆè¯¦ç»†æ–‡æ¡£
echo -e "${BLUE}ğŸ“š ç”Ÿæˆè¯¦ç»†APIæ–‡æ¡£...${NC}"

cat > "$README_FILE" << EOF
# FMOD v7 è¿è¡Œæ—¶APIæ–‡æ¡£

> ğŸ¯ æ­¤æ–‡æ¡£åŸºäºè¿è¡Œæ—¶æ”¶é›†çš„çœŸå®APIè°ƒç”¨æ•°æ®ç”Ÿæˆï¼Œ100%å‡†ç¡®

## ğŸ“… ç”Ÿæˆä¿¡æ¯

- **ç”Ÿæˆæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
- **æ•°æ®æ¥æº**: è¿è¡Œæ—¶APIè°ƒç”¨æ”¶é›†
- **å‡†ç¡®åº¦**: 100% (åŸºäºçœŸå®è°ƒç”¨)
- **ç‰ˆæœ¬**: v2.0 (ç”Ÿäº§å°±ç»ª)

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®‰è£…å’Œå¯¼å…¥

\`\`\`typescript
// å¯¼å…¥APIå®¢æˆ·ç«¯
import { apiClient, auth, items, system } from './api/client-runtime';

// æˆ–è€…å¯¼å…¥ç‰¹å®šç±»å‹
import type { LoginRequest, Item, CreateItemRequest } from './types/api-runtime';
\`\`\`

### åŸºç¡€ä½¿ç”¨

\`\`\`typescript
// 1. ç”¨æˆ·è®¤è¯
const loginResponse = await auth.login({
  username: 'your-username',
  password: 'your-password'
});

// 2. è·å–Itemsåˆ—è¡¨
const itemsList = await items.list({
  page: 1,
  page_size: 10
});

// 3. åˆ›å»ºæ–°Item
const newItem = await items.create({
  name: 'My New Item',
  description: 'Item description'
});

// 4. å¥åº·æ£€æŸ¥
const health = await system.health();
\`\`\`

## ğŸ”§ APIå®¢æˆ·ç«¯åŠŸèƒ½

### ğŸ” è®¤è¯ç®¡ç†

\`\`\`typescript
// ç™»å½•ï¼ˆä¼šè‡ªåŠ¨è®¾ç½®tokenï¼‰
await auth.login({ username: 'user', password: 'pass' });

// éªŒè¯å½“å‰token
await auth.validate();

// ç™»å‡ºï¼ˆä¼šè‡ªåŠ¨æ¸…é™¤tokenï¼‰
await auth.logout();

// æ‰‹åŠ¨è®¾ç½®token
auth.setToken('your-jwt-token');

// ç§»é™¤token
auth.removeToken();
\`\`\`

### ğŸ“ Items CRUDæ“ä½œ

\`\`\`typescript
// è·å–Itemsåˆ—è¡¨ï¼ˆæ”¯æŒåˆ†é¡µå’Œæœç´¢ï¼‰
const items = await items.list({
  page: 1,
  page_size: 20,
  search: 'keyword',
  sort_by: 'created_at',
  sort_order: 'desc'
});

// è·å–å•ä¸ªItem
const item = await items.get('item-id');

// åˆ›å»ºItem
const newItem = await items.create({
  name: 'Item Name',
  description: 'Optional description',
  value: 100
});

// æ›´æ–°Item
const updatedItem = await items.update('item-id', {
  name: 'New Name'
});

// åˆ é™¤Item
await items.delete('item-id');
\`\`\`

### ğŸ¥ ç³»ç»Ÿç›‘æ§

\`\`\`typescript
// å¥åº·æ£€æŸ¥
const health = await system.health();

// APIä¿¡æ¯
const info = await system.info();

// è¿è¡Œæ—¶ç»Ÿè®¡
const stats = await system.stats();
\`\`\`

## âš¡ é«˜çº§åŠŸèƒ½

### é”™è¯¯å¤„ç†

\`\`\`typescript
import { isApiError } from './api/client-runtime';

try {
  const items = await items.list();
} catch (error) {
  if (isApiError(error)) {
    console.log(\`APIé”™è¯¯: \${error.code} - \${error.message}\`);
    console.log(\`çŠ¶æ€ç : \${error.status}\`);
    console.log(\`è¿½è¸ªID: \${error.traceId}\`);
  } else {
    console.log('å…¶ä»–é”™è¯¯:', error);
  }
}
\`\`\`

### è‡ªå®šä¹‰é…ç½®

\`\`\`typescript
import { ApiClient } from './api/client-runtime';

const customClient = new ApiClient({
  baseUrl: 'https://api.yourapp.com',
  timeout: 10000,
  retries: 5,
  retryDelay: 2000,
  headers: {
    'X-Custom-Header': 'value'
  }
});
\`\`\`

### ç±»å‹å®‰å…¨

\`\`\`typescript
import type { Item, CreateItemRequest } from './types/api-runtime';

// å®Œå…¨ç±»å‹å®‰å…¨çš„å‡½æ•°
function processItem(item: Item): string {
  return \`\${item.name} (\${item.id})\`;
}

function createItemData(): CreateItemRequest {
  return {
    name: 'Required field',
    description: 'Optional field',
    // TypeScriptä¼šæ£€æŸ¥æ‰€æœ‰å­—æ®µç±»å‹
  };
}
\`\`\`

## ğŸ“Š å¯ç”¨APIç«¯ç‚¹

### ğŸ” è®¤è¯ç«¯ç‚¹

- \`POST /api/auth/login\` - ç”¨æˆ·ç™»å½•
- \`GET /api/auth/validate\` - éªŒè¯token
- \`POST /api/auth/logout\` - ç”¨æˆ·ç™»å‡º

### ğŸ“ Itemsç«¯ç‚¹

- \`GET /api/items\` - è·å–Itemsåˆ—è¡¨
- \`GET /api/items/{id}\` - è·å–å•ä¸ªItem
- \`POST /api/items\` - åˆ›å»ºItem
- \`PUT /api/items/{id}\` - æ›´æ–°Item
- \`DELETE /api/items/{id}\` - åˆ é™¤Item

### ğŸ¥ ç³»ç»Ÿç«¯ç‚¹

- \`GET /health\` - å¥åº·æ£€æŸ¥
- \`GET /api/info\` - APIä¿¡æ¯
- \`GET /api/runtime/data\` - è¿è¡Œæ—¶ç»Ÿè®¡

### ğŸ‘¤ ç”¨æˆ·ç«¯ç‚¹

- \`GET /user/events\` - è·å–ç”¨æˆ·äº‹ä»¶

## ğŸ›¡ï¸ å®¢æˆ·ç«¯ç‰¹æ€§

- âœ… **å®Œå…¨ç±»å‹å®‰å…¨** - åŸºäºçœŸå®APIç”Ÿæˆçš„TypeScriptç±»å‹
- âœ… **è‡ªåŠ¨é‡è¯•** - æ™ºèƒ½é‡è¯•å¤±è´¥çš„è¯·æ±‚
- âœ… **è¶…æ—¶æ§åˆ¶** - å¯é…ç½®çš„è¯·æ±‚è¶…æ—¶
- âœ… **é”™è¯¯å¤„ç†** - ç»“æ„åŒ–çš„é”™è¯¯ä¿¡æ¯
- âœ… **è®¤è¯ç®¡ç†** - è‡ªåŠ¨tokenç®¡ç†
- âœ… **è¯·æ±‚å–æ¶ˆ** - æ”¯æŒè¯·æ±‚å–æ¶ˆ
- âœ… **æŸ¥è¯¢å‚æ•°** - è‡ªåŠ¨å¤„ç†URLæŸ¥è¯¢å‚æ•°
- âœ… **å†…å®¹ç±»å‹æ£€æµ‹** - æ™ºèƒ½å¤„ç†JSONå’Œæ–‡æœ¬å“åº”

## ğŸ”„ æ›´æ–°æµç¨‹

è¦æ›´æ–°APIå®¢æˆ·ç«¯ä»£ç ï¼š

1. ç¡®ä¿æœåŠ¡å™¨è¿è¡Œåœ¨å¼€å‘æ¨¡å¼
2. è¿è¡Œå¯¼å‡ºè„šæœ¬ï¼š\`./scripts/runtime_api_export.sh\`
3. æ–°çš„ç±»å‹å’Œå®¢æˆ·ç«¯ä»£ç ä¼šè‡ªåŠ¨ç”Ÿæˆ

## ğŸ“ æ³¨æ„äº‹é¡¹

- æ­¤ä»£ç æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œè¯·å‹¿æ‰‹åŠ¨ä¿®æ”¹
- ç±»å‹å®šä¹‰åŸºäºçœŸå®çš„APIå“åº”ç»“æ„
- å®¢æˆ·ç«¯åŒ…å«æ™ºèƒ½é‡è¯•å’Œé”™è¯¯å¤„ç†é€»è¾‘
- æ”¯æŒè®¤è¯tokençš„è‡ªåŠ¨ç®¡ç†
- æ‰€æœ‰APIè°ƒç”¨éƒ½æ˜¯ç±»å‹å®‰å…¨çš„

---

*ğŸ“… æœ€åæ›´æ–°: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
EOF

echo -e "${GREEN}âœ… APIæ–‡æ¡£å·²ç”Ÿæˆ: $README_FILE${NC}"

# è·å–è¿è¡Œæ—¶ç»Ÿè®¡
echo -e "${BLUE}ğŸ“Š æ”¶é›†è¿è¡Œæ—¶ç»Ÿè®¡...${NC}"
if curl -s "$API_BASE_URL/api/runtime/data" > "$DOCS_DIR/runtime-stats.json"; then
    echo -e "${GREEN}âœ… è¿è¡Œæ—¶ç»Ÿè®¡å·²ä¿å­˜: $DOCS_DIR/runtime-stats.json${NC}"
else
    echo -e "${YELLOW}âš ï¸  è­¦å‘Š: æ— æ³•è·å–è¿è¡Œæ—¶ç»Ÿè®¡${NC}"
fi

# éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶
echo -e "${BLUE}ğŸ” éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶...${NC}"

FILES_TO_CHECK=(
    "$TYPES_FILE"
    "$CLIENT_FILE"
    "$README_FILE"
)

ALL_VALID=true

for file in "${FILES_TO_CHECK[@]}"; do
    if [ -f "$file" ]; then
        size=$(wc -c < "$file")
        if [ "$size" -gt 100 ]; then
            echo -e "${GREEN}âœ… $file (${size} bytes)${NC}"
        else
            echo -e "${RED}âŒ $file æ–‡ä»¶å¤ªå° (${size} bytes)${NC}"
            ALL_VALID=false
        fi
    else
        echo -e "${RED}âŒ $file æ–‡ä»¶ä¸å­˜åœ¨${NC}"
        ALL_VALID=false
    fi
done

# æœ€ç»ˆç»“æœ
echo ""
echo "====================================="
if [ "$ALL_VALID" = true ]; then
    echo -e "${GREEN}ğŸ‰ è¿è¡Œæ—¶APIå¯¼å‡ºå®Œæˆï¼${NC}"
    echo ""
    echo -e "${BLUE}ç”Ÿæˆçš„æ–‡ä»¶:${NC}"
    echo "  ğŸ“„ ç±»å‹å®šä¹‰: $TYPES_FILE"
    echo "  ğŸ”§ APIå®¢æˆ·ç«¯: $CLIENT_FILE"
    echo "  ğŸ“š ä½¿ç”¨æ–‡æ¡£: $README_FILE"
    echo "  ğŸ“‹ OpenAPIè§„èŒƒ: $DOCS_DIR/openapi-runtime.json"
    echo "  ğŸ“Š è¿è¡Œæ—¶ç»Ÿè®¡: $DOCS_DIR/runtime-stats.json"
    echo ""
    echo -e "${GREEN}âœ¨ v2.0 æ–°ç‰¹æ€§:${NC}"
    echo "  âœ… ç”Ÿäº§å°±ç»ªçš„ä»£ç è´¨é‡"
    echo "  âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶"
    echo "  âœ… è‡ªåŠ¨è®¤è¯tokenç®¡ç†"
    echo "  âœ… ç±»å‹å®‰å…¨çš„APIè°ƒç”¨"
    echo "  âœ… æ™ºèƒ½å†…å®¹ç±»å‹æ£€æµ‹"
    echo "  âœ… å¯é…ç½®çš„è¶…æ—¶å’Œé‡è¯•"
    echo ""
    echo -e "${GREEN}ç°åœ¨æ‚¨å¯ä»¥åœ¨å‰ç«¯é¡¹ç›®ä¸­ä½¿ç”¨è¿™äº›æ–‡ä»¶äº†ï¼${NC}"
    echo ""
    echo -e "${BLUE}ä½¿ç”¨ç¤ºä¾‹:${NC}"
    echo "  import { apiClient, auth, items } from './api/client-runtime';"
    echo "  import type { Item, LoginRequest } from './types/api-runtime';"
else
    echo -e "${RED}âŒ å¯¼å‡ºè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ—¥å¿—${NC}"
    exit 1
fi 