# ğŸ³ V7 é¡¹ç›® - äº‘ç«¯å®¹å™¨ç¼–æ’ï¼ˆæ­£ç¡®æ¶æ„ç‰ˆï¼‰
# 
# ğŸ—ï¸ å®é™…æ¶æ„ï¼š
#   â˜ï¸ äº‘æœåŠ¡å™¨: Backend(å®¹å™¨) + Web(å®¹å™¨)
#   ğŸ  æœ¬åœ°å±€åŸŸç½‘: Analytics Engine(systemdæœåŠ¡)
#   ğŸ” è¿æ¥: WireGuard VPN
#
# ğŸ”§ æ ¸å¿ƒä¿®å¤ï¼š
#   - Backendå’ŒWebä½¿ç”¨ç»Ÿä¸€bridgeç½‘ç»œï¼ˆè§£å†³nginx hostnameé—®é¢˜ï¼‰
#   - Backendé€šè¿‡WireGuard VPNï¼ˆ10.0.0.xç½‘æ®µï¼‰è®¿é—®æœ¬åœ°Analytics Engine
#   - ä¸ä¾èµ–host.containers.internalï¼ˆé‚£æ˜¯è®¿é—®äº‘æœåŠ¡å™¨æœ¬åœ°çš„ï¼‰

version: '3.8'

# ğŸŒ ç½‘ç»œé…ç½®
networks:
  v7-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# ğŸ“¦ æ•°æ®å·é…ç½®  
volumes:
  backend-data:
    driver: local
  backend-logs:
    driver: local
  web-cache:
    driver: local

# ğŸš€ æœåŠ¡é…ç½®
services:
  # ğŸ¦€ Backend æœåŠ¡ - Rust FMOD v7 + gRPC
  backend:
    image: ${BACKEND_IMAGE:-ghcr.io/hellocplusplus0/v7/backend:latest}
    container_name: v7-backend
    restart: unless-stopped
    
    # ğŸŒ ç½‘ç»œé…ç½® - ä½¿ç”¨bridgeç½‘ç»œï¼Œé€šè¿‡WireGuardè®¿é—®Analytics Engine
    networks:
      - v7-network
    
    # ğŸ”Œ ç«¯å£æ˜ å°„
    ports:
      - "${BACKEND_HTTP_PORT:-3000}:3000"   # HTTPå¥åº·æ£€æŸ¥
      - "${BACKEND_GRPC_PORT:-50053}:50053" # gRPCæœåŠ¡
    
    # ğŸŒ ç¯å¢ƒå˜é‡é…ç½®
    environment:
      # æœåŠ¡é…ç½®
      - NODE_ENV=production
      - RUST_LOG=info
      - HTTP_PORT=3000
      - GRPC_PORT=50053
      
      # æ•°æ®åº“é…ç½®
      - DATABASE_URL=sqlite:/app/data/prod.db
      - ENABLE_PERSISTENCE=true
      - CREATE_TEST_DATA=false
      
      # ğŸ”‘ å…³é”®ä¿®å¤ï¼šAnalytics Engineé€šè¿‡WireGuard VPNè®¿é—®æœ¬åœ°å±€åŸŸç½‘
      # VPNç½‘æ®µï¼š10.0.0.xï¼ˆæ ¹æ®WireGuardé…ç½®ï¼‰
      # æœ¬åœ°Analytics Engineåœ°å€ï¼š10.0.0.1:50051ï¼ˆWireGuardå®¢æˆ·ç«¯IPï¼‰
      - ANALYTICS_ENGINE_ENDPOINT=http://10.0.0.1:50051
      - ANALYTICS_CONNECTION_TIMEOUT_SEC=10
      - ANALYTICS_REQUEST_TIMEOUT_SEC=30
      
      # æ€§èƒ½è°ƒä¼˜é…ç½®
      - MALLOC_ARENA_MAX=2
      - MALLOC_TRIM_THRESHOLD_=131072
    
    # ğŸ“ æ•°æ®å·æŒ‚è½½
    volumes:
      - backend-data:/app/data:Z
      - backend-logs:/app/logs:Z
      - /tmp:/tmp/app-runtime:Z
    
    # ğŸ”’ å®‰å…¨é…ç½®
    user: "${BACKEND_UID:-1002}:${BACKEND_GID:-1002}"
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    
    # ğŸ“Š èµ„æºé™åˆ¶
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
    
    # ğŸ¥ å¥åº·æ£€æŸ¥ - ä¿®å¤ï¼šä½¿ç”¨wgetæ›¿ä»£curl
    healthcheck:
      test: ["CMD", "/app/backend", "--health-check"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    
    # ğŸ”„ ä¾èµ–å…³ç³»
    depends_on: []

  # ğŸŒ Web æœåŠ¡ - SolidJS + TypeScript + Vite + nginx
  web:
    image: ${WEB_IMAGE:-ghcr.io/hellocplusplus0/v7/web:latest}
    container_name: v7-web
    restart: unless-stopped
    
    # ğŸŒ ç½‘ç»œé…ç½® - ä¸backendåœ¨åŒä¸€bridgeç½‘ç»œ
    networks:
      - v7-network
    
    # ğŸ”Œ ç«¯å£æ˜ å°„
    ports:
      - "${WEB_PORT:-8080}:80"
    
    # ğŸŒ ç¯å¢ƒå˜é‡é…ç½®
    environment:
      - NODE_ENV=production
      # nginxå¯ä»¥é€šè¿‡hostname "backend" è®¿é—®backendæœåŠ¡
      - BACKEND_URL=http://backend:3000
      - BACKEND_GRPC_URL=http://backend:50053
    
    # ğŸ“ æ•°æ®å·æŒ‚è½½
    volumes:
      - web-cache:/var/cache/nginx:Z
    
    # ğŸ”’ å®‰å…¨é…ç½®
    user: "${WEB_UID:-1003}:${WEB_GID:-1003}"
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /var/run:noexec,nosuid,size=50m
      - /tmp:noexec,nosuid,size=50m
    
    # ğŸ“Š èµ„æºé™åˆ¶
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.2'
        reservations:
          memory: 64M
          cpus: '0.05'
    
    # ğŸ¥ å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    
    # ğŸ”„ ä¾èµ–å…³ç³»
    depends_on:
      - backend

# ğŸ“ éƒ¨ç½²è¯´æ˜
# 
# ğŸš€ éƒ¨ç½²å‘½ä»¤:
#   podman-compose -f podman-compose-correct.yml up -d
# 
# ğŸ” WireGuardå‰ç½®æ¡ä»¶:
#   1. äº‘æœåŠ¡å™¨å·²å®‰è£…WireGuardå®¢æˆ·ç«¯
#   2. å·²é…ç½®VPNè¿æ¥åˆ°æœ¬åœ°å±€åŸŸç½‘ï¼ˆ10.0.0.xç½‘æ®µï¼‰
#   3. æœ¬åœ°Analytics Engineè¿è¡Œåœ¨10.0.0.1:50051
# 
# ğŸ§ª éªŒè¯è¿æ¥:
#   podman exec v7-backend wget -qO- http://10.0.0.1:50051/health
# 
# ğŸ”§ ç½‘ç»œæ¶æ„:
#   - Web â†â†’ Backend: bridgeç½‘ç»œå†…éƒ¨é€šä¿¡ï¼ˆhostnameè§£æï¼‰
#   - Backend â†â†’ Analytics: WireGuard VPNè·¨ç½‘ç»œé€šä¿¡
#   - å¤–éƒ¨è®¿é—®: äº‘æœåŠ¡å™¨IP:8080(web), IP:3000(backend-http), IP:50053(backend-grpc) 