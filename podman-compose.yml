# ğŸš€ V7 Podman è½»é‡åŒ–éƒ¨ç½²é…ç½®
# ä¸“ä¸ºè½»é‡çº§æœåŠ¡å™¨(2æ ¸2G)ä¼˜åŒ–çš„Podman Composeé…ç½®
version: '3.8'

services:
  # ğŸ¦€ åç«¯æœåŠ¡ - Rust + FMOD v7 æ¶æ„
  backend:
    image: ${BACKEND_IMAGE:-ghcr.io/hellocplusplus0/v7/backend:latest}
    container_name: v7-backend
    restart: unless-stopped
    
    # ğŸ”Œ ç«¯å£æ˜ å°„
    ports:
      - "3000:3000"
    
    # ğŸŒ ç¯å¢ƒå˜é‡ - ä¿®å¤æ•°æ®åº“è·¯å¾„ä¸ºæŒä¹…åŒ–å­˜å‚¨
    environment:
      - RUST_LOG=${RUST_LOG:-info}
      - DATABASE_URL=${DATABASE_URL:-sqlite:/app/data/prod.db}
      - PORT=3000
      - TZ=Asia/Shanghai
      - ENABLE_CORS=true
      - MAX_CONNECTIONS=100
      # Podman ç‰¹å®šä¼˜åŒ–
      - RUST_BACKTRACE=1
      - MALLOC_ARENA_MAX=2
    
    # ğŸ“ æ•°æ®å·æ˜ å°„ - ç¡®ä¿æ•°æ®æŒä¹…åŒ–å’Œæƒé™æ­£ç¡®
    volumes:
      - ./data:/app/data:Z
      - ./logs/backend:/app/logs:Z
      - ./config:/app/config:ro,Z
    
    # ğŸŒ ç½‘ç»œé…ç½®
    networks:
      - v7-network
    
    # ğŸ’¾ èµ„æºé™åˆ¶ (é’ˆå¯¹2æ ¸2GæœåŠ¡å™¨ä¼˜åŒ–)
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.8'
        reservations:
          memory: 256M
          cpus: '0.2'
    
    # ğŸ”’ å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # ğŸ”’ å®‰å…¨é…ç½® - ä¿æŒåŸºæœ¬å®‰å…¨ä½†å…è®¸æ•°æ®å†™å…¥
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    
    # ğŸ”§ ç”¨æˆ·é…ç½® - ç¡®ä¿æ•°æ®ç›®å½•æƒé™æ­£ç¡®
    user: "1001:1001"
    
    # ğŸŒ æ—¥å¿—é…ç½®
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    
    # ğŸ·ï¸ æ ‡ç­¾
    labels:
      - "app=v7"
      - "service=backend"
      - "version=latest"
      - "maintainer=hellocplusplus0"

  # ğŸŒ å‰ç«¯æœåŠ¡ - SolidJS + Web v7 æ¶æ„
  web:
    image: ${WEB_IMAGE:-ghcr.io/hellocplusplus0/v7/web:latest}
    container_name: v7-web
    restart: unless-stopped
    
    # ğŸ”Œ ç«¯å£æ˜ å°„ - ä½¿ç”¨8080éç‰¹æƒç«¯å£
    ports:
      - "8080:8080"
    
    # ğŸŒ ç¯å¢ƒå˜é‡ - æ”¯æŒåŠ¨æ€é…ç½®
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - TZ=Asia/Shanghai
      # Nginx é…ç½®ç¯å¢ƒå˜é‡
      - NGINX_USER=appuser
      - NGINX_PORT=8080
      - NGINX_WORKER_PROCESSES=auto
      - NGINX_WORKER_CONNECTIONS=1024
      - NGINX_LOG_LEVEL=warn
      - BACKEND_URL=http://backend:3000
    
    # ğŸ“ æ•°æ®å·æ˜ å°„ - å¯é€‰çš„æ—¥å¿—æŒ‚è½½
    volumes:
      - ./logs/web:/var/log/nginx:Z
    
    # ğŸŒ ç½‘ç»œé…ç½®
    networks:
      - v7-network
    
    # ğŸ’¾ èµ„æºé™åˆ¶
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.1'
    
    # ğŸ”’ å¥åº·æ£€æŸ¥ - ä½¿ç”¨8080ç«¯å£
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    # ğŸ”’ å®‰å…¨é…ç½® - é€‚åˆéç‰¹æƒå®¹å™¨
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp:nosuid,size=50m
      - /var/run:nosuid,size=10m
    
    # ğŸ“¦ æœåŠ¡ä¾èµ–
    depends_on:
      backend:
        condition: service_healthy
    
    # ğŸ·ï¸ æ ‡ç­¾
    labels:
      - "app=v7"
      - "service=web"
      - "version=latest"
      - "maintainer=hellocplusplus0"

  # ğŸ“Š è½»é‡çº§ç›‘æ§æœåŠ¡ (å¯é€‰)
  monitor:
    image: prom/node-exporter:latest
    container_name: v7-monitor
    restart: unless-stopped
    
    # ğŸ”Œ ç«¯å£æ˜ å°„
    ports:
      - "${MONITOR_PORT:-9100}:9100"
    
    # ğŸ“ æ•°æ®å·æ˜ å°„
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    
    # ğŸŒ ç¯å¢ƒå˜é‡
    environment:
      - NODE_ID={{.Node.ID}}
    
    # ğŸŒ ç½‘ç»œé…ç½®
    networks:
      - v7-network
    
    # ğŸ’¾ èµ„æºé™åˆ¶
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 64M
        reservations:
          cpus: '0.05'
          memory: 32M
    
    # ğŸ”’ å®‰å…¨é…ç½®
    security_opt:
      - no-new-privileges:true
    read_only: true
    
    # ğŸ·ï¸ æ ‡ç­¾
    labels:
      - "app=v7"
      - "service=monitor"
      - "version=latest"
    
    # å¯åŠ¨å‚æ•°
    command:
      - '--path.procfs=/host/proc'
      - '--path.rootfs=/rootfs'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    
    profiles:
      - monitoring

# ğŸŒ ç½‘ç»œé…ç½®
networks:
  v7-network:
    driver: bridge
    name: v7-network
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16
    labels:
      - "app=v7"
      - "type=internal"

# ğŸ“ æ•°æ®å·é…ç½®
volumes:
  v7-data:
    driver: local
    name: v7-data
    labels:
      - "app=v7"
      - "type=persistent"
  
  v7-logs:
    driver: local
    name: v7-logs
    labels:
      - "app=v7"
      - "type=logs"

# ğŸ·ï¸ å…¨å±€æ ‡ç­¾
x-common-labels: &common-labels
  app: "v7"
  architecture: "podman"
  environment: "${NODE_ENV:-production}"
  maintainer: "hellocplusplus0"
  
# ğŸ“ é…ç½®è¯´æ˜
# 
# ğŸš€ å¯åŠ¨å‘½ä»¤:
#   podman-compose up -d
# 
# ğŸ“Š æŸ¥çœ‹çŠ¶æ€:
#   podman-compose ps
#   podman-compose logs -f
# 
# ğŸ”„ æ›´æ–°æœåŠ¡:
#   podman-compose pull
#   podman-compose up -d --force-recreate
# 
# ğŸ›‘ åœæ­¢æœåŠ¡:
#   podman-compose down
# 
# ğŸ§¹ æ¸…ç†èµ„æº:
#   podman-compose down --volumes --remove-orphans
#   podman system prune -af
# 
# ğŸ“Š å¯ç”¨ç›‘æ§:
#   podman-compose --profile monitoring up -d
# 
# ğŸ”§ èµ„æºä¼˜åŒ–è¯´æ˜:
# - åç«¯: 1æ ¸CPU, 512MBå†…å­˜ (é€‚åˆRusté«˜æ€§èƒ½ç‰¹æ€§)
# - å‰ç«¯: 0.5æ ¸CPU, 256MBå†…å­˜ (Nginxè½»é‡çº§)
# - ç›‘æ§: 0.1æ ¸CPU, 64MBå†…å­˜ (å¯é€‰ç»„ä»¶)
# - æ€»è®¡: 1.6æ ¸CPU, 832MBå†…å­˜ (é¢„ç•™ç³»ç»Ÿèµ„æº)
# 
# ğŸ”’ å®‰å…¨ç‰¹æ€§:
# - éç‰¹æƒå®¹å™¨è¿è¡Œ
# - SELinuxæ ‡ç­¾æ”¯æŒ
# - ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿéš”ç¦»
# - ç½‘ç»œéš”ç¦»
# - ç¯å¢ƒå˜é‡é…ç½®
# 
# ğŸ¯ æœ€ä½³å®è·µç‰¹æ€§:
# - éç‰¹æƒç«¯å£ (3000, 8080, 9100)
# - ç¯å¢ƒå˜é‡é©±åŠ¨é…ç½®
# - å¥åº·æ£€æŸ¥é€‚é…
# - æ­£ç¡®çš„ä¾èµ–å…³ç³»
# - èµ„æºé™åˆ¶ä¼˜åŒ– 