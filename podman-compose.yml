# ğŸ³ V7 é¡¹ç›® - ç”Ÿäº§ç¯å¢ƒå®¹å™¨ç¼–æ’ï¼ˆå·²é’ˆå¯¹Dockerfileä¼˜åŒ–è°ƒæ•´ï¼‰
# æ¶æ„ï¼šWeb(nginx) + Backend(gRPC+gRPC-Web) + Analytics-Engine(gRPC)
# é€šä¿¡ï¼šBrowser â†’ nginx â†’ Backend gRPC-Web:50053
# ğŸ“‹ ä¼˜åŒ–äº®ç‚¹ï¼šå‚æ•°åŒ–é…ç½®ã€å¢å¼ºå®‰å…¨ã€ä¼˜åŒ–æ€§èƒ½ã€ä¼ä¸šçº§ç›‘æ§

# V7 Project - Backend + Web å®¹å™¨åŒ–ç¼–æ’é…ç½®
# Analytics Engine ä½¿ç”¨ systemd éƒ¨ç½²ï¼Œè·å¾—æœ€ä½³æ€§èƒ½
# 
# ğŸ­ æ¶æ„è®¾è®¡ï¼š
#   Analytics Engine: systemd æœåŠ¡ (localhost:50051)
#   Backend: å®¹å™¨åŒ– (ports: 3000/50053)  
#   Web: å®¹å™¨åŒ– (port: 8080)
#
# ğŸš€ ä½¿ç”¨æ–¹æ³•ï¼š
#   1. éƒ¨ç½² Analytics Engine: cd analytics-engine && sudo -u analytics ./scripts/deploy.sh
#   2. å¯åŠ¨å®¹å™¨æœåŠ¡: podman-compose up -d
#   3. éªŒè¯æœåŠ¡: curl http://localhost:8080/health

version: '3.8'

# ğŸŒ ç½‘ç»œé…ç½®
networks:
  v7-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# ğŸ“¦ æ•°æ®å·é…ç½®  
volumes:
  # Backendæ•°æ®å­˜å‚¨
  backend-data:
    driver: local
  backend-logs:
    driver: local
    
  # Webé™æ€èµ„æºï¼ˆå¦‚æœéœ€è¦æŒä¹…åŒ–ï¼‰
  web-cache:
    driver: local

# ğŸš€ æœåŠ¡é…ç½®
services:
  # ğŸ¦€ Backend æœåŠ¡ - Rust FMOD v7 + gRPC
  backend:
    image: ${BACKEND_IMAGE:-v7-backend:latest}
    container_name: v7-backend
    restart: unless-stopped
    
    # ğŸŒ ç½‘ç»œé…ç½® - WireGuard VPNéœ€è¦hostç½‘ç»œæ¨¡å¼
    # ä½¿ç”¨hostæ¨¡å¼è®©å®¹å™¨ç›´æ¥è®¿é—®ä¸»æœºç½‘ç»œæ ˆ(åŒ…æ‹¬WireGuardæ¥å£)
    network_mode: host
    
    # ğŸ”Œ ç«¯å£é…ç½® - hostæ¨¡å¼ä¸‹ä¸éœ€è¦ç«¯å£æ˜ å°„
    # ports:
    #   - "${BACKEND_HTTP_PORT:-3000}:${BACKEND_HTTP_PORT:-3000}"   # HTTP API
    #   - "${BACKEND_GRPC_PORT:-50053}:${BACKEND_GRPC_PORT:-50053}" # gRPC API
    
    # ğŸŒ ç¯å¢ƒå˜é‡é…ç½®
    environment:
      # åŸºç¡€é…ç½®
      - NODE_ENV=${NODE_ENV:-production}
      - RUST_LOG=${RUST_LOG:-info}
      - TZ=${TZ:-Asia/Shanghai}
      
      # ç«¯å£é…ç½®
      - HTTP_PORT=${BACKEND_HTTP_PORT:-3000}
      - GRPC_PORT=${BACKEND_GRPC_PORT:-50053}
      
      # Analytics Engineè¿æ¥é…ç½®
      # ğŸ”§ WireGuard VPN: hostç½‘ç»œæ¨¡å¼ä¸‹å¯ç›´æ¥è®¿é—®VPNæ¥å£
      # å¼€å‘ç¯å¢ƒ: æœ¬åœ°ç›´è¿
      # ç”Ÿäº§ç¯å¢ƒ: é€šè¿‡WireGuard VPN (10.0.0.1æ˜¯analytics-engineçš„VPN IP)
      - ANALYTICS_ENGINE_ENDPOINT=${ANALYTICS_ENGINE_ENDPOINT:-http://127.0.0.1:50051}
      
      # æ•°æ®åº“é…ç½®
      - DATABASE_URL=sqlite:/app/data/prod.db
      
      # æ€§èƒ½è°ƒä¼˜é…ç½®
      - MALLOC_ARENA_MAX=2
      - MALLOC_TRIM_THRESHOLD_=131072
    
    # ğŸ“ æ•°æ®å·æŒ‚è½½
    volumes:
      - backend-data:/app/data:Z
      - backend-logs:/app/logs:Z
      - /tmp:/tmp/app-runtime:Z
    
    # ğŸ”’ å®‰å…¨é…ç½®
    user: "${BACKEND_UID:-1002}:${BACKEND_GID:-1002}"
    
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    
    # ğŸ“Š èµ„æºé™åˆ¶
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.25'
    
    # ğŸ¥ å¥åº·æ£€æŸ¥ï¼ˆé€‚é…WireGuard VPNå»¶è¿Ÿï¼‰
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:${BACKEND_HTTP_PORT:-3000}/health || exit 1"]
      interval: 30s
      timeout: 15s    # å¢åŠ è¶…æ—¶æ—¶é—´ï¼šVPNç½‘ç»œå¯èƒ½æœ‰é¢å¤–å»¶è¿Ÿ
      retries: 5      # å¢åŠ é‡è¯•æ¬¡æ•°ï¼šåº”å¯¹VPNè¿æ¥ä¸ç¨³å®š
      start_period: 45s  # å¢åŠ å¯åŠ¨æ—¶é—´ï¼šç­‰å¾…VPNè¿æ¥å»ºç«‹
    
    # ğŸ“ æ—¥å¿—é…ç½®
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    
    # ğŸ·ï¸ æ ‡ç­¾
    labels:
      - "app=v7"
      - "service=backend"
      - "version=optimized"
      - "protocol=http+grpc"
      - "architecture=rust+fmod-v7"

  # ğŸŒ Web æœåŠ¡ - nginx + React/TypeScript
  web:
    image: ${WEB_IMAGE:-v7-web:latest}
    container_name: v7-web
    restart: unless-stopped
    
    # ğŸ”Œ ç«¯å£é…ç½®
    ports:
      - "${WEB_PORT:-8080}:${WEB_PORT:-8080}"
    
    # ğŸŒ ç½‘ç»œé…ç½® - Webä¿æŒbridgeæ¨¡å¼(ä¸éœ€è¦VPNè®¿é—®)
    networks:
      - v7-network
    
    # ğŸŒ ç¯å¢ƒå˜é‡é…ç½®
    environment:
      # åŸºç¡€é…ç½®
      - NODE_ENV=${NODE_ENV:-production}
      - TZ=${TZ:-Asia/Shanghai}
      
      # Webé…ç½®
      - WEB_PORT=${WEB_PORT:-8080}
      
      # Backendè¿æ¥é…ç½®
      - BACKEND_HTTP_URL=http://backend:${BACKEND_HTTP_PORT:-3000}
      - BACKEND_GRPC_URL=http://backend:${BACKEND_GRPC_PORT:-50053}
    
    # ğŸ“ æ•°æ®å·æŒ‚è½½ï¼ˆå¯é€‰çš„ç¼“å­˜æŒä¹…åŒ–ï¼‰
    volumes:
      - web-cache:/var/cache/nginx:Z
    
    # ğŸ”’ å®‰å…¨é…ç½®
    user: "${WEB_UID:-1001}:${WEB_GID:-1001}"
    
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp:noexec,nosuid,size=50m
    
    # ğŸ“Š èµ„æºé™åˆ¶
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.1'
    
    # ğŸ¥ å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:${WEB_PORT:-8080}/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    
    # ğŸ“ æ—¥å¿—é…ç½®
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    
    # ğŸ·ï¸ æ ‡ç­¾
    labels:
      - "app=v7"
      - "service=web"
      - "version=optimized"
      - "protocol=http"
      - "architecture=nginx+react"
    
    # ğŸ”— æœåŠ¡ä¾èµ–ï¼ˆç¡®ä¿Backendå…ˆå¯åŠ¨ï¼‰
    depends_on:
      backend:
        condition: service_healthy

# ğŸ’¾ å‘½åæ•°æ®å·é…ç½®
volumes:
  backend-data:
    driver: local
    # ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨çœŸå®æŒä¹…åŒ–å­˜å‚¨ï¼Œä¸æ˜¯tmpfså†…å­˜æ–‡ä»¶ç³»ç»Ÿ
    labels:
      - "app=v7"
      - "service=backend"
      - "type=persistent-data"
  
  backend-logs:
    driver: local
    labels:
      - "app=v7" 
      - "service=backend"
      - "type=logs"
  
  web-cache:
    driver: local
    labels:
      - "app=v7"
      - "service=web"
      - "type=cache"

# ğŸ“Š åˆ†æå¼•æ“ - æ”¯æŒå®¹å™¨åŒ–å’Œsystemdä¸¤ç§éƒ¨ç½²æ–¹å¼
# 
# ğŸ­ ç”Ÿäº§ç¯å¢ƒï¼ˆæ¨èï¼‰ï¼šsystemdç‹¬ç«‹è¿›ç¨‹éƒ¨ç½²
#   éƒ¨ç½²æ–¹å¼ï¼šcd analytics-engine && ./scripts/deploy.sh
#   æœåŠ¡ç®¡ç†ï¼šsystemctl {start|stop|status} analytics-engine
#   Backendè¿æ¥ï¼šANALYTICS_ENGINE_ADDR=http://host.containers.internal:50051
# 
# ğŸ§ª æµ‹è¯•/å¼€å‘ç¯å¢ƒï¼šå®¹å™¨åŒ–éƒ¨ç½²ï¼ˆå–æ¶ˆæ³¨é‡Šä»¥ä¸‹é…ç½®ï¼‰
#   å¯ç”¨æ–¹å¼ï¼šè®¾ç½®ç¯å¢ƒå˜é‡ ENABLE_ANALYTICS_CONTAINER=true
#   Backendè¿æ¥ï¼šANALYTICS_ENGINE_ADDR=http://analytics-engine:50051
# 
# analytics-engine:
#     image: ${ANALYTICS_IMAGE:-v7-analytics-engine:latest}
#     container_name: v7-analytics-engine
#     restart: unless-stopped
#     
#     # ğŸ”Œ ç«¯å£é…ç½®ï¼ˆå‚æ•°åŒ–ï¼‰
#     ports:
#       - "${ANALYTICS_PORT:-50051}:${ANALYTICS_PORT:-50051}"
#     
#     networks:
#       - v7-network
#     
#     environment:
#       - ANALYTICS_LISTEN_ADDR=0.0.0.0:${ANALYTICS_PORT:-50051}
#       - ANALYTICS_PORT=${ANALYTICS_PORT:-50051}
#       - RUST_LOG=${RUST_LOG:-info}
#       - PYTHONPATH=/home/analytics/python
#       # æ€§èƒ½ä¼˜åŒ–é…ç½®ï¼ˆåŒ¹é…Dockerfileä¼˜åŒ–ï¼‰
#       - RAYON_NUM_THREADS=2
#       - PYTHON_BRIDGE_THREADS=4
#       - MALLOC_ARENA_MAX=2
#       - MALLOC_TRIM_THRESHOLD_=131072
#       # Pythonä¾èµ–é”å®šé…ç½®
#       - PYTHON_EXACT_VERSIONS=true
#       - REQUIREMENTS_LOCKED=true
#     
#     volumes:
#       - analytics-socket:/tmp/app-runtime:Z  # åŒ¹é…Dockerfileä¼˜åŒ–åçš„è·¯å¾„
#       - analytics-data:/home/analytics/data:Z
#       - analytics-logs:/home/analytics/logs:Z
#     
#     healthcheck:
#       test: ["CMD", "/home/analytics/analytics-engine", "--health-check"]  # ä½¿ç”¨å†…å»ºå¥åº·æ£€æŸ¥
#       interval: 30s
#       timeout: 10s
#       retries: 3
#       start_period: 15s  # å‡å°‘ï¼šä¼˜åŒ–åå¯åŠ¨æ›´å¿«
#     
#     deploy:
#       resources:
#         limits:
#           memory: 768M  # è°ƒæ•´ï¼šé™æ€é“¾æ¥åå†…å­˜å ç”¨å‡å°‘
#           cpus: '0.8'   # è°ƒæ•´ï¼šä¼˜åŒ–åæ€§èƒ½æå‡
#         reservations:
#           memory: 384M  # è°ƒæ•´ï¼šå‡å°‘å†…å­˜é¢„ç•™
#           cpus: '0.3'
#     
#     # ä½¿ç”¨éç‰¹æƒç”¨æˆ·ï¼ˆåŒ¹é…Dockerfileä¼˜åŒ–ï¼‰
#     user: "${ANALYTICS_UID:-1001}:${ANALYTICS_GID:-1001}"
#     
#     security_opt:
#       - no-new-privileges:true
#     tmpfs:
#       - /tmp:noexec,nosuid,size=50m
#     
#     logging:
#       driver: json-file
#       options:
#         max-size: "10m"
#         max-file: "3"
#     
#     labels:
#       - "app=v7"
#       - "service=analytics-engine"
#       - "version=optimized"
#       - "architecture=rust+python+grpc"
#       - "optimization=static-binary+python-bridge"

# ğŸŒ ç½‘ç»œé…ç½®ï¼ˆä¼˜åŒ–æ€§èƒ½å’Œç®€åŒ–å¤æ‚åº¦ï¼‰
# networks:
#   v7-network:
#     driver: bridge
#     name: v7-network
#     ipam:
#       driver: default
#       config:
#         - subnet: 172.20.0.0/16
#     driver_opts:
#       com.docker.network.bridge.name: v7-bridge
#       com.docker.network.driver.mtu: 1500
#       # å¯ç”¨å®¹å™¨é—´ç›´æ¥é€šä¿¡ä¼˜åŒ–
#       com.docker.network.bridge.enable_icc: "true"
#       com.docker.network.bridge.enable_ip_masquerade: "true"
#     labels:
#       - "app=v7"
#       - "type=internal"
#       - "version=optimized"

# ğŸ“ æ•°æ®å·é…ç½®ï¼ˆç®€åŒ–æ¸…ç†ï¼‰
# volumes:
#   # ç§»é™¤analyticsç›¸å…³volumesï¼Œå› ä¸ºç°åœ¨ä½¿ç”¨systemdç‹¬ç«‹éƒ¨ç½²
#   # analytics-socket:
#   #   driver: local
#   #   driver_opts:
#   #     type: tmpfs
#   #     device: tmpfs
#   #     o: "size=100m,uid=${ANALYTICS_UID:-1001},gid=${ANALYTICS_GID:-1001}"
#   #   labels:
#   #     - "app=v7"
#   #     - "type=socket"
#   #     - "service=analytics-engine"
#   
#   # analytics-data:
#   #   driver: local
#   #   labels:
#   #     - "app=v7"
#   #     - "type=data"
#   #     - "service=analytics-engine"
#   
#   # analytics-logs:
#   #   driver: local
#   #   labels:
#   #     - "app=v7"
#   #     - "type=logs"
#   #     - "service=analytics-engine"
#   
#   # ä¿ç•™Backendä¸´æ—¶è¿è¡Œæ—¶å·ï¼ˆå¦‚æœéœ€è¦ï¼‰
#   backend-runtime:
#     driver: local
#     driver_opts:
#       type: tmpfs
#       device: tmpfs
#       o: "size=100m,uid=${BACKEND_UID:-1002},gid=${BACKEND_GID:-1002}"
#     labels:
#       - "app=v7"
#       - "type=runtime"
#       - "service=backend" 