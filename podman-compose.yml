# ğŸ³ V7 é¡¹ç›® - ç”Ÿäº§ç¯å¢ƒå®¹å™¨ç¼–æ’ï¼ˆå·²é’ˆå¯¹Dockerfileä¼˜åŒ–è°ƒæ•´ï¼‰
# æ¶æ„ï¼šWeb(nginx) + Backend(gRPC+gRPC-Web) + Analytics-Engine(gRPC)
# é€šä¿¡ï¼šBrowser â†’ nginx â†’ Backend gRPC-Web:50053
# ğŸ“‹ ä¼˜åŒ–äº®ç‚¹ï¼šå‚æ•°åŒ–é…ç½®ã€å¢å¼ºå®‰å…¨ã€ä¼˜åŒ–æ€§èƒ½ã€ä¼ä¸šçº§ç›‘æ§

version: '3.8'

services:
  # ğŸ¦€ åç«¯æœåŠ¡ - æ”¯æŒ gRPC å’Œ gRPC-Webï¼ˆå·²ä¼˜åŒ–ï¼‰
  backend:
    image: ${BACKEND_IMAGE:-ghcr.io/hellocplusplus0/v7/backend:latest}
    container_name: v7-backend
    restart: unless-stopped
    
    # ğŸ”Œ ç«¯å£æ˜ å°„ï¼ˆå‚æ•°åŒ–é…ç½®ï¼‰
    ports:
      - "${BACKEND_HTTP_PORT:-3000}:${BACKEND_HTTP_PORT:-3000}"
      - "${BACKEND_GRPC_PORT:-50053}:${BACKEND_GRPC_PORT:-50053}"
    
    # ğŸŒ ç¯å¢ƒå˜é‡ï¼ˆå¢å¼ºé…ç½®ï¼‰
    environment:
      - RUST_LOG=${RUST_LOG:-info}
      - DATABASE_URL=${DATABASE_URL:-sqlite:/app/data/prod.db}
      - HTTP_PORT=${BACKEND_HTTP_PORT:-3000}
      - GRPC_PORT=${BACKEND_GRPC_PORT:-50053}
      - TZ=Asia/Shanghai
      - ENABLE_CORS=true
      - MAX_CONNECTIONS=100
      - RUST_BACKTRACE=1
      - MALLOC_ARENA_MAX=2
      - MALLOC_TRIM_THRESHOLD_=131072
      # Analytics Engineè¿æ¥é…ç½®
      - ANALYTICS_ENGINE_ADDR=analytics-engine:${ANALYTICS_PORT:-50051}
    
    volumes:
      - ./data:/app/data:Z
      - ./logs/backend:/app/logs:Z
      - ./config:/app/config:ro,Z
      - analytics-socket:/tmp/app-runtime:Z  # åŒ¹é…Dockerfileä¼˜åŒ–åçš„è·¯å¾„
    
    networks:
      - v7-network
    
    deploy:
      resources:
        limits:
          memory: 512M  # è°ƒæ•´ï¼šé™æ€é“¾æ¥åå†…å­˜å ç”¨æ›´å°
          cpus: '0.8'   # è°ƒæ•´ï¼šä¼˜åŒ–åæ€§èƒ½æå‡
        reservations:
          memory: 256M  # è°ƒæ•´ï¼šå‡å°‘å†…å­˜é¢„ç•™
          cpus: '0.2'
    
    healthcheck:
      test: ["CMD", "/app/backend", "--health-check"]  # ä½¿ç”¨å†…å»ºå¥åº·æ£€æŸ¥
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s  # å‡å°‘ï¼šä¼˜åŒ–åå¯åŠ¨æ›´å¿«
    
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    
    # ä½¿ç”¨éç‰¹æƒç”¨æˆ·ï¼ˆåŒ¹é…Dockerfileä¼˜åŒ–ï¼‰
    user: "${BACKEND_UID:-1002}:${BACKEND_GID:-1002}"
    
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    
    depends_on:
      analytics-engine:
        condition: service_healthy
    
    labels:
      - "app=v7"
      - "service=backend"
      - "version=optimized"
      - "protocols=grpc,grpc-web"
      - "architecture=rust+fmod-v7"
      - "optimization=static-binary+lto"

  # ğŸŒ å‰ç«¯æœåŠ¡ - nginx + SolidJSï¼ˆå·²ä¼˜åŒ–ï¼‰
  web:
    image: ${WEB_IMAGE:-ghcr.io/hellocplusplus0/v7/web:latest}
    container_name: v7-web
    restart: unless-stopped
    
    # ğŸ”Œ ç«¯å£æ˜ å°„ï¼ˆå‚æ•°åŒ–é…ç½®ï¼‰
    ports:
      - "80:${WEB_PORT:-3000}"
      - "8080:${WEB_PORT:-3000}"
    
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - TZ=Asia/Shanghai
      - NGINX_PORT=${WEB_PORT:-3000}
      - NGINX_WORKER_PROCESSES=auto
      - NGINX_WORKER_CONNECTIONS=1024
      - NGINX_LOG_LEVEL=warn
      # gRPC-Web é…ç½®
      - GRPC_WEB_ENDPOINT=http://backend:${BACKEND_GRPC_PORT:-50053}
    
    networks:
      - v7-network
    
    deploy:
      resources:
        limits:
          memory: 128M  # è°ƒæ•´ï¼šnginxä¼˜åŒ–åå†…å­˜å ç”¨æ›´å°
          cpus: '0.3'   # è°ƒæ•´ï¼šä¸‰é˜¶æ®µæ„å»ºåæ€§èƒ½æå‡
        reservations:
          memory: 64M   # è°ƒæ•´ï¼šå‡å°‘å†…å­˜é¢„ç•™
          cpus: '0.05'
    
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:${WEB_PORT:-3000}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s  # å‡å°‘ï¼šä¼˜åŒ–åå¯åŠ¨æ›´å¿«
    
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp:nosuid,size=50m
      - /var/run:nosuid,size=10m
    
    # ä½¿ç”¨éç‰¹æƒç”¨æˆ·ï¼ˆåŒ¹é…Dockerfileä¼˜åŒ–ï¼‰
    user: "${WEB_UID:-101}:${WEB_GID:-101}"
    
    depends_on:
      backend:
        condition: service_healthy
    
    labels:
      - "app=v7"
      - "service=web"
      - "version=optimized"
      - "architecture=solidjs+typescript+vite"
      - "optimization=multi-stage+gzip+csp"

  # ğŸ“Š åˆ†æå¼•æ“ - å·²é’ˆå¯¹Dockerfileä¼˜åŒ–è°ƒæ•´
  analytics-engine:
    image: ${ANALYTICS_IMAGE:-v7-analytics-engine:latest}
    container_name: v7-analytics-engine
    restart: unless-stopped
    
    # ğŸ”Œ ç«¯å£é…ç½®ï¼ˆå‚æ•°åŒ–ï¼‰
    expose:
      - "${ANALYTICS_PORT:-50051}"
    # ports:
    #   - "${ANALYTICS_PORT:-50051}:${ANALYTICS_PORT:-50051}"  # ä»…åœ¨è·¨æœåŠ¡å™¨éƒ¨ç½²æ—¶å¯ç”¨
    
    networks:
      - v7-network
    
    environment:
      - ANALYTICS_LISTEN_ADDR=0.0.0.0:${ANALYTICS_PORT:-50051}
      - ANALYTICS_PORT=${ANALYTICS_PORT:-50051}
      - RUST_LOG=${RUST_LOG:-info}
      - PYTHONPATH=/home/analytics/python
      # æ€§èƒ½ä¼˜åŒ–é…ç½®ï¼ˆåŒ¹é…Dockerfileä¼˜åŒ–ï¼‰
      - RAYON_NUM_THREADS=2
      - PYTHON_BRIDGE_THREADS=4
      - MALLOC_ARENA_MAX=2
      - MALLOC_TRIM_THRESHOLD_=131072
      # Pythonä¾èµ–é”å®šé…ç½®
      - PYTHON_EXACT_VERSIONS=true
      - REQUIREMENTS_LOCKED=true
    
    volumes:
      - analytics-socket:/tmp/app-runtime:Z  # åŒ¹é…Dockerfileä¼˜åŒ–åçš„è·¯å¾„
      - analytics-data:/home/analytics/data:Z
      - analytics-logs:/home/analytics/logs:Z
    
    healthcheck:
      test: ["CMD", "/home/analytics/analytics-engine", "--health-check"]  # ä½¿ç”¨å†…å»ºå¥åº·æ£€æŸ¥
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s  # å‡å°‘ï¼šä¼˜åŒ–åå¯åŠ¨æ›´å¿«
    
    deploy:
      resources:
        limits:
          memory: 768M  # è°ƒæ•´ï¼šé™æ€é“¾æ¥åå†…å­˜å ç”¨å‡å°‘
          cpus: '0.8'   # è°ƒæ•´ï¼šä¼˜åŒ–åæ€§èƒ½æå‡
        reservations:
          memory: 384M  # è°ƒæ•´ï¼šå‡å°‘å†…å­˜é¢„ç•™
          cpus: '0.3'
    
    # ä½¿ç”¨éç‰¹æƒç”¨æˆ·ï¼ˆåŒ¹é…Dockerfileä¼˜åŒ–ï¼‰
    user: "${ANALYTICS_UID:-1001}:${ANALYTICS_GID:-1001}"
    
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    
    labels:
      - "app=v7"
      - "service=analytics-engine"
      - "version=optimized"
      - "protocol=grpc"
      - "architecture=rust+python"
      - "optimization=static-binary+wheels+lto"

# ğŸŒ ç½‘ç»œé…ç½®ï¼ˆå¢å¼ºï¼‰
networks:
  v7-network:
    driver: bridge
    name: v7-network
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16
    driver_opts:
      com.docker.network.bridge.name: v7-bridge
      com.docker.network.driver.mtu: 1500
    labels:
      - "app=v7"
      - "type=internal"
      - "version=optimized"

# ğŸ“ æ•°æ®å·é…ç½®ï¼ˆå¢å¼ºï¼‰
volumes:
  analytics-socket:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: "size=100m,uid=${ANALYTICS_UID:-1001},gid=${ANALYTICS_GID:-1001}"
    labels:
      - "app=v7"
      - "type=socket"
      - "service=analytics-engine"
  
  analytics-data:
    driver: local
    labels:
      - "app=v7"
      - "type=data"
      - "service=analytics-engine"
  
  analytics-logs:
    driver: local
    labels:
      - "app=v7"
      - "type=logs"
      - "service=analytics-engine" 