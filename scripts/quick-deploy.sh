#!/bin/bash

# ğŸš€ V7 å¿«é€Ÿéƒ¨ç½²è„šæœ¬ (ä¿®å¤ç‰ˆ)
# ä¸“ä¸ºè¿œç¨‹æ‰§è¡Œè®¾è®¡ï¼Œä¿®å¤äº†BASH_SOURCEå’Œè·¯å¾„é—®é¢˜

set -euo pipefail

# ğŸ“‹ é…ç½®å‚æ•°
PROJECT_NAME="v7"
COMPOSE_FILE="podman-compose.yml"
ENV_FILE=".env"

# ğŸŒ GitHubä»“åº“é…ç½®
DEFAULT_REPO_URL="https://github.com/helloCplusplus0/v7.git"
DEFAULT_BRANCH="main"

# ğŸ¨ è¾“å‡ºé¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ğŸ“ æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

log_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

log_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# ğŸ” æ£€æŸ¥å¿…è¦çš„å‘½ä»¤
check_requirements() {
    log_info "æ£€æŸ¥éƒ¨ç½²ç¯å¢ƒ..."
    
    local required_commands=("podman" "podman-compose" "curl" "git")
    for cmd in "${required_commands[@]}"; do
        if ! command -v "$cmd" &> /dev/null; then
            log_error "ç¼ºå°‘å¿…è¦å‘½ä»¤: $cmd"
            log_info "è¯·å®‰è£…: sudo apt-get install -y $cmd"
            exit 1
        fi
    done
    
    log_success "ç¯å¢ƒæ£€æŸ¥é€šè¿‡"
}

# ğŸ“¦ ä¸‹è½½éƒ¨ç½²é…ç½® (ä¿®å¤ç‰ˆ)
download_deployment_config() {
    local repo_url="${1:-$DEFAULT_REPO_URL}"
    local branch="${2:-$DEFAULT_BRANCH}"
    local work_dir="/opt/v7-deploy"
    
    log_info "ä¸‹è½½éƒ¨ç½²é…ç½®..."
    log_info "ä»“åº“: $repo_url"
    log_info "åˆ†æ”¯: $branch"
    
    # æ¸…ç†å¹¶åˆ›å»ºå·¥ä½œç›®å½•
    sudo rm -rf "$work_dir"
    sudo mkdir -p "$work_dir"
    
    # ç›´æ¥å…‹éš†ä»“åº“åˆ°å·¥ä½œç›®å½•
    log_info "å…‹éš†ä»“åº“..."
    if ! sudo git clone -b "$branch" "$repo_url" "$work_dir" 2>/dev/null; then
        log_error "æ— æ³•å…‹éš†ä»“åº“: $repo_url"
        log_error "åˆ†æ”¯: $branch"
        log_error "è¯·æ£€æŸ¥ä»“åº“åœ°å€ã€åˆ†æ”¯åç§°å’Œç½‘ç»œè¿æ¥"
        exit 1
    fi
    
    # æ£€æŸ¥å…³é”®æ–‡ä»¶
    if [[ ! -f "$work_dir/podman-compose.yml" ]]; then
        log_error "æœªæ‰¾åˆ°podman-compose.ymlæ–‡ä»¶"
        log_error "ä»“åº“ç»“æ„å¯èƒ½ä¸æ­£ç¡®"
        exit 1
    fi
    
    # è®¾ç½®æƒé™
    sudo chown -R "$USER:$USER" "$work_dir"
    
    log_success "éƒ¨ç½²é…ç½®ä¸‹è½½å®Œæˆ: $work_dir"
    return 0
}

# ğŸ”§ é…ç½®ç¯å¢ƒå˜é‡
setup_environment() {
    local work_dir="$1"
    local backend_image="$2"
    local web_image="$3"
    
    log_info "é…ç½®ç¯å¢ƒå˜é‡..."
    
    cd "$work_dir"
    
    # åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶
    cat > "$ENV_FILE" << EOF
# ğŸš€ V7 ç”Ÿäº§ç¯å¢ƒé…ç½®
# è‡ªåŠ¨ç”Ÿæˆæ—¶é—´: $(date -u +%Y-%m-%dT%H:%M:%SZ)

# ===== ğŸ“¦ é•œåƒé…ç½® =====
BACKEND_IMAGE=$backend_image
WEB_IMAGE=$web_image

# ===== ğŸŒ æœåŠ¡é…ç½® =====
# BackendæœåŠ¡
BACKEND_HTTP_PORT=3000
BACKEND_GRPC_PORT=50053

# WebæœåŠ¡  
WEB_PORT=8080

# ===== ğŸ—„ï¸ æ•°æ®åº“é…ç½® =====
DATABASE_URL=sqlite:/app/data/prod.db
ENABLE_PERSISTENCE=true
PERSIST_PATH=/app/data/memory_db.json

# ===== ğŸ“Š æ—¥å¿—é…ç½® =====
RUST_LOG=info

# ===== ğŸ” å®‰å…¨é…ç½® =====
JWT_SECRET=$(openssl rand -base64 32)

# ===== ğŸ§® Analytics Engineé…ç½® =====
# é»˜è®¤æœ¬åœ°è¿æ¥ (å¦‚éœ€WireGuard,è¯·æ‰‹åŠ¨ä¿®æ”¹)
ANALYTICS_ENGINE_ENDPOINT=http://127.0.0.1:50051
ANALYTICS_CONNECTION_TIMEOUT_SEC=10
ANALYTICS_REQUEST_TIMEOUT_SEC=30
EOF

    log_success "ç¯å¢ƒé…ç½®æ–‡ä»¶åˆ›å»ºå®Œæˆ"
}

# ğŸ” ç™»å½•é•œåƒä»“åº“
login_registry() {
    local registry="$1"
    local username="$2"
    local token="$3"
    
    log_info "ç™»å½•é•œåƒä»“åº“: $registry"
    
    if echo "$token" | podman login "$registry" --username "$username" --password-stdin; then
        log_success "é•œåƒä»“åº“ç™»å½•æˆåŠŸ"
    else
        log_error "é•œåƒä»“åº“ç™»å½•å¤±è´¥"
        log_error "è¯·æ£€æŸ¥ç”¨æˆ·åå’Œè®¿é—®ä»¤ç‰Œ"
        exit 1
    fi
}

# ğŸ“¥ æ‹‰å–é•œåƒ
pull_images() {
    local backend_image="$1"
    local web_image="$2"
    
    log_info "æ‹‰å–é•œåƒ..."
    
    log_info "æ‹‰å–Backendé•œåƒ: $backend_image"
    if ! podman pull "$backend_image"; then
        log_error "Backendé•œåƒæ‹‰å–å¤±è´¥"
        exit 1
    fi
    
    log_info "æ‹‰å–Webé•œåƒ: $web_image"
    if ! podman pull "$web_image"; then
        log_error "Webé•œåƒæ‹‰å–å¤±è´¥"
        exit 1
    fi
    
    log_success "é•œåƒæ‹‰å–å®Œæˆ"
}

# ğŸ›‘ åœæ­¢ç°æœ‰æœåŠ¡
stop_existing_services() {
    local work_dir="$1"
    
    log_info "åœæ­¢ç°æœ‰æœåŠ¡..."
    
    cd "$work_dir"
    
    # å°è¯•åœæ­¢æœåŠ¡ (å…è®¸å¤±è´¥)
    podman-compose down 2>/dev/null || true
    
    # æ¸…ç†æ‚¬ç©ºå®¹å™¨
    podman container prune -f 2>/dev/null || true
    
    log_success "ç°æœ‰æœåŠ¡å·²åœæ­¢"
}

# ğŸš€ å¯åŠ¨æœåŠ¡
start_services() {
    local work_dir="$1"
    
    log_info "å¯åŠ¨V7æœåŠ¡..."
    
    cd "$work_dir"
    
    # å¯åŠ¨æœåŠ¡
    if podman-compose up -d; then
        log_success "æœåŠ¡å¯åŠ¨å®Œæˆ"
    else
        log_error "æœåŠ¡å¯åŠ¨å¤±è´¥"
        log_error "è¯·æ£€æŸ¥podman-compose.ymlé…ç½®"
        exit 1
    fi
}

# ğŸ¥ å¥åº·æ£€æŸ¥
health_check() {
    local work_dir="$1"
    
    log_info "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
    
    # ç­‰å¾…æœåŠ¡å¯åŠ¨
    sleep 10
    
    # æ£€æŸ¥backendå¥åº·çŠ¶æ€
    local max_attempts=30
    local attempt=1
    
    while [[ $attempt -le $max_attempts ]]; do
        log_info "å¥åº·æ£€æŸ¥å°è¯• $attempt/$max_attempts"
        
        if curl -f http://localhost:3000/health >/dev/null 2>&1; then
            log_success "BackendæœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
            break
        fi
        
        if [[ $attempt -eq $max_attempts ]]; then
            log_error "BackendæœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥"
            return 1
        fi
        
        sleep 5
        ((attempt++))
    done
    
    # æ£€æŸ¥webæœåŠ¡
    if curl -f http://localhost:8080/ >/dev/null 2>&1; then
        log_success "WebæœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
    else
        log_warning "WebæœåŠ¡å¯èƒ½æœªå®Œå…¨å¯åŠ¨ï¼Œè¯·ç¨åæ£€æŸ¥"
    fi
    
    return 0
}

# ğŸ“Š éƒ¨ç½²æ€»ç»“
deployment_summary() {
    local work_dir="$1"
    local backend_image="$2"
    local web_image="$3"
    
    log_success "ğŸ‰ V7éƒ¨ç½²å®Œæˆï¼"
    
    echo "========================================"
    echo "ğŸš€ éƒ¨ç½²ä¿¡æ¯:"
    echo "  å·¥ä½œç›®å½•: $work_dir"
    echo "  Backendé•œåƒ: $backend_image"
    echo "  Webé•œåƒ: $web_image"
    echo "  éƒ¨ç½²æ—¶é—´: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
    echo ""
    echo "ğŸŒ è®¿é—®åœ°å€:"
    echo "  Backend API: http://localhost:3000"
    echo "  Backend Health: http://localhost:3000/health"
    echo "  Webåº”ç”¨: http://localhost:8080"
    echo ""
    echo "ğŸ”§ ç®¡ç†å‘½ä»¤:"
    echo "  æŸ¥çœ‹çŠ¶æ€: cd $work_dir && podman-compose ps"
    echo "  æŸ¥çœ‹æ—¥å¿—: cd $work_dir && podman-compose logs -f"
    echo "  é‡å¯æœåŠ¡: cd $work_dir && podman-compose restart"
    echo "  åœæ­¢æœåŠ¡: cd $work_dir && podman-compose down"
    echo "========================================"
}

# ğŸ“‹ æ˜¾ç¤ºå¸®åŠ©
show_help() {
    cat << 'EOF'
ğŸš€ V7 å¿«é€Ÿéƒ¨ç½²è„šæœ¬ (ä¿®å¤ç‰ˆ)

ç”¨æ³•:
    curl -sSL https://raw.githubusercontent.com/helloCplusplus0/v7/main/scripts/quick-deploy.sh | bash -s -- [é€‰é¡¹]

é€‰é¡¹:
    -B, --backend IMAGE     Backendé•œåƒåœ°å€
    -W, --web IMAGE         Webé•œåƒåœ°å€  
    -u, --username USER     æ³¨å†Œè¡¨ç”¨æˆ·å
    -t, --token TOKEN       æ³¨å†Œè¡¨è®¿é—®ä»¤ç‰Œ
    -r, --repo URL          Gitä»“åº“åœ°å€ (å¯é€‰)
    -b, --branch BRANCH     Gitåˆ†æ”¯ (å¯é€‰)
    -h, --help              æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯

ç¤ºä¾‹:
    curl -sSL https://raw.githubusercontent.com/helloCplusplus0/v7/main/scripts/quick-deploy.sh | bash -s -- \
        -B ghcr.io/hellocplusplus0/v7/backend:latest \
        -W ghcr.io/hellocplusplus0/v7/web:latest \
        -u helloCplusplus0 \
        -t your-token

æ³¨æ„:
    - ç¡®ä¿æœåŠ¡å™¨å·²å®‰è£… podman, podman-compose, curl, git
    - ç¡®ä¿é˜²ç«å¢™å¼€æ”¾3000å’Œ8080ç«¯å£
    - éƒ¨ç½²å®Œæˆåè¯·åŠæ—¶ä¿®æ”¹JWT_SECRET
EOF
}

# ğŸ¯ ä¸»å‡½æ•°
main() {
    # æ˜¾ç¤ºæ¨ªå¹…
    echo "ğŸš€ V7å¿«é€Ÿéƒ¨ç½²ç³»ç»Ÿ (ä¿®å¤ç‰ˆ)"
    echo "========================================"
    
    # é»˜è®¤å‚æ•°
    local backend_image=""
    local web_image=""
    local username=""
    local token=""
    local repo_url="$DEFAULT_REPO_URL"
    local branch="$DEFAULT_BRANCH"
    local work_dir=""
    
    # è§£æå‚æ•°
    while [[ $# -gt 0 ]]; do
        case $1 in
            -B|--backend)
                backend_image="$2"
                shift 2
                ;;
            -W|--web)
                web_image="$2"
                shift 2
                ;;
            -u|--username)
                username="$2"
                shift 2
                ;;
            -t|--token)
                token="$2"
                shift 2
                ;;
            -r|--repo)
                repo_url="$2"
                shift 2
                ;;
            -b|--branch)
                branch="$2"
                shift 2
                ;;
            -h|--help)
                show_help
                exit 0
                ;;
            *)
                log_error "æœªçŸ¥å‚æ•°: $1"
                show_help
                exit 1
                ;;
        esac
    done
    
    # éªŒè¯å¿…éœ€å‚æ•°
    if [[ -z "$backend_image" || -z "$web_image" || -z "$username" || -z "$token" ]]; then
        log_error "ç¼ºå°‘å¿…éœ€å‚æ•°"
        show_help
        exit 1
    fi
    
    # æ˜¾ç¤ºé…ç½®ä¿¡æ¯
    log_info "å¼€å§‹V7åº”ç”¨éƒ¨ç½²..."
    echo "========================================"
    echo "ğŸ“¦ éƒ¨ç½²é…ç½®:"
    echo "  ä»“åº“: $repo_url"
    echo "  åˆ†æ”¯: $branch"
    echo "  Backendé•œåƒ: $backend_image"
    echo "  Webé•œåƒ: $web_image"
    echo "========================================"
    
    # æ‰§è¡Œéƒ¨ç½²æµç¨‹
    check_requirements
    
    work_dir="/opt/v7-deploy"
    download_deployment_config "$repo_url" "$branch"
    setup_environment "$work_dir" "$backend_image" "$web_image"
    login_registry "ghcr.io" "$username" "$token"
    pull_images "$backend_image" "$web_image"
    stop_existing_services "$work_dir"
    start_services "$work_dir"
    
    if health_check "$work_dir"; then
        deployment_summary "$work_dir" "$backend_image" "$web_image"
    else
        log_error "éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        log_info "è°ƒè¯•å‘½ä»¤: cd $work_dir && podman-compose logs"
        exit 1
    fi
}

# ğŸš€ æ‰§è¡Œä¸»å‡½æ•°
main "$@" 